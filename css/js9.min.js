var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in b||(b[e]={});b=b[e]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Math.asinh",function(a){return a?a:function(a){a=Number(a);if(0===a)return a;var b=Math.log(Math.abs(a)+Math.sqrt(a*a+1));return 0>a?-b:b}},"es6-impl","es3");
$jscomp.polyfill("Math.sinh",function(a){if(a)return a;var c=Math.exp;return function(a){a=Number(a);return 0===a?a:(c(a)-c(-a))/2}},"es6-impl","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var c=0;return $jscomp.iteratorPrototype(function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,c){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,d={next:function(){if(b<a.length){var e=b++;return{value:c(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(c.call(b,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,b,d){var c=this.length||0;0>b&&(b=Math.max(0,c+b));if(null==d||d>c)d=c;d=Number(d);0>d&&(d=Math.max(0,c+d));for(b=Number(b||0);b<d;b++)this[b]=a;return this}},"es6-impl","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6-impl","es3");
var JS9=function(){var a={NAME:"JS9",VERSION:"1.11",COPYRIGHT:"Copyright (c) 2012-2016 Smithsonian Institution",DEFID:"JS9",WIDTH:512,HEIGHT:512,ANON:"Anonymous",PREFSFILE:"js9Prefs.json",ZINDEX:0,SHAPEZINDEX:4,MESSZINDEX:80,BTNZINDEX:90,MENUZINDEX:1E3,COLORSIZE:1024,SCALESIZE:16384,INVSIZE:1024,HISTSIZE:16384,INSTALLDIR:"",TOROOT:"",PLUGINS:"",LIGHTWIN:"dhtml",ANTIALIAS:!1,SCALEIREG:!0,NOMOVE:3,DBLCLICK:500,TIMEOUT:250,SPINOUT:250,SUPERMENU:/^SUPERMENU_/,RESIZEDIST:20,RESIZEFUDGE:5,RAWID0:"raw0",
RAWIDX:"alt",REPROJDIM:2300,IDFMT:"  (%s)",MINZOOM:.125,MAXZOOM:16,ADDZOOM:.05,CHROMEFILEWARNING:!0};a.TOUCHSUPPORTED=window.hasOwnProperty("ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;a.BROWSER=function(){var a=navigator.platform,b=navigator.appName,d=navigator.userAgent,e,f=d.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);e=d.match(/version\/([\.\d]+)/i);f&&null!==e&&(f[2]=e[1]);f=f?[f[1],f[2],a]:[b,navigator.appVersion,"-?",a];f.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(d));
return f}();a.PIXEL_RATIO=function(){var a=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1)}();a.globalOpts={helperType:"none",helperPort:2718,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2png:!1,alerts:!0,internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,
htimeout:1E4,xtimeout:18E4,extlist:"EVENTS STDEVT",table:{xdim:1024,ydim:1024},image:{xmax:0,ymax:0},clearImageMemory:"never",helperProtocol:location.protocol,maxMemory:75E7,corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,archivesURL:"help/archives.html",imsectionURL:"params/imsection.html",postMessage:!1,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,mouseActions:["display value/position","change contrast/bias","pan the image"],
touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{b:"toggle selected region: source/background",e:"toggle selected region: include/exclude",o:"open a local FITS file","/":"copy wcs position to clipboard","?":"copy value and position to clipboard","+":"zoom in","-":"zoom out",">":"display next image","<":"display previous image","delete":"remove selected region",leftArrow:"move selected region",upArrow:"move selected region",rightArrow:"move selected region",
downArrow:"move selected region"},mousetouchZoom:!1,centerDivs:["JS9Menubar"],pinchWait:8,pinchThresh:6,extendedPlugins:!0,corsProxy:"http://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"http://js9.si.edu/cgi-bin/simbad-proxy.cgi",catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$xreg.data.ra $xreg.data.dec"},topColormaps:"grey heat cool viridis magma sls a b red green blue".split(" "),
debug:0};a.imageOpts={contrast:1,bias:.5,invert:!1,exp:1E3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",wcsunits:"sexagesimal",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:.4,alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,listonchange:!1};a.regionOpts={};a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",prependJS9Dir:!0,dataDir:null};a.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",
drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=230px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=598px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=60px,center=1,resize=1,scrolling=1"}};
a.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};a.plotOpts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0}};a.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},
webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},
publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",
title:"Setting Site Preferences"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}};a.images=[];a.displays=[];a.colormaps=[];a.commands=[];a.plugins=[];a.preloads=[];a.auxFiles=[];a.publics={};a.helper={};a.fits={};a.userOpts={};a.scales="linear log histeq power sqrt squared asinh sinh".split(" ");a.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");a.wcsunitss=
["degrees","sexagesimal","pixels"];a.bugs={};a.bugs.hide_menu=!1;"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);if("Chrome"===a.BROWSER[0]||"Safari"===a.BROWSER[0])a.bugs.webkit_resize=!0;"Chrome"===a.BROWSER[0]&&(a.globalOpts.maxMemory=Math.min(a.globalOpts.maxMemory,5E8),a.globalOpts.image.xmax=6144,a.globalOpts.image.ymax=6144);a.Image=function(c,b,d){var e,f,g=this,h=null,k=function(a,b){var c,d=[];b&&void 0!==b.xcen&&d.push(b.xcen);b&&void 0!==b.ycen&&d.push(b.ycen);
b&&void 0!==b.zoom&&(c=a.parseZoom(b.zoom))&&d.push(c);return d},l=function(b){this.clearMessage();a.images.push(this);if(b)try{a.xeqByName(b,window,this)}catch(p){a.error("in image onload callback",p,!1)}this.xeqPlugins("image","onimageload");this.updateshapes&&this.updateShapes("regions","all","update");this.status.load="complete";a.waiting(!1)};b&&("object"===typeof b?(h=b,h.display&&(f=h.display)):f=b);f||(f=0<a.displays.length?a.displays[0].id:a.DEFID);this.type="image";this.display=a.lookupDisplay(f);
this.params={};this.tmp={};this.params.scalemin=Number.Nan;this.params.scalemax=Number.Nan;this.params.xeqonchange=!0;this.params=$.extend(!0,this.params,a.imageOpts,h);this.setColormap(this.params.colormap);this.displayMode=!0;this.clickState=0;this.queried=this.clickInRegion=!1;h&&h.proxyFile&&(this.proxyFile=h.proxyFile);h&&h.parentFile&&(this.parentFile=h.parentFile);h&&h.id&&(this.id=h.id);this.iy=this.ix=0;this.png={};this.png.image=new Image;this.status={};this.rgb={};this.rgb.sect={zoom:1,
ozoom:1};this.layers={};this.zlayer=a.SHAPEZINDEX;this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend={active:void 0,mode:"normal",opacity:1};this.updateshapes=!1;a.waiting(!0,this.display.divjq[0]);switch(typeof c){case "object":this.source="fits";this.mkRawDataFromHDU(c,$.extend({},{file:c.filename},h));"zscale"===this.params.scaleclipping&&this.zscale(!0);this.mkSection();e=k(this,h);e.length&&this.mkSection.apply(this,e);h&&h.rgbFile?(this.rgbFile=h.rgbFile,$(this.png.image).on("load",
function(){var b;if(g.png.image.width!==g.raw.width||g.png.image.height!==g.raw.height)b=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",g.png.image.width,g.png.image.height,g.raw.width,g.raw.height),a.error(b);g.mkOffScreenCanvas();g.displayImage("all",h);l.call(g,d)}).on("error",function(){a.waiting(!1);g.status.load="error";a.error("could not load image: "+g.id)}),this.png.image.src=this.rgbFile):(this.displayImage("all",h),l.call(this,d));break;case "string":this.source="fits2png";this.imtab=
"image";this.file=c.replace(/\/\.\//,"/");this.id0=this.file.split("/").reverse()[0];this.id=a.getImageID(this.id0,this.display.id);this.status.load="loading";$(this.png.image).on("load",function(){g.mkOffScreenCanvas();g.mkRawDataFromPNG();"zscale"===g.params.scaleclipping&&g.zscale(!0);g.mkSection();e=k(g,h);e.length&&g.mkSection.apply(g,e);g.displayImage("all",h);l.call(g,d);a.DEBUG&&a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",g.file,g.raw.width,g.raw.height,g.raw.dmin,g.raw.dmax)}).on("error",
function(){a.waiting(!1);g.status.load="error";a.error("could not load image: "+g.id)});this.png.image.src=c;break;default:a.log("unknown specification type for Load: "+typeof c)}};a.Image.prototype.getImageData=function(a){var b=null;if(a)if("array"===a)b=Array.prototype.slice.call(this.raw.data);else if("base64"===a){var b="",c=new Uint8Array(this.raw.data.buffer),e=c.byteLength;for(a=0;a<e;a++)b+=String.fromCharCode(c[a]);b=window.btoa(b)}else a&&"false"!==a&&(b=this.raw.data);return{id:this.id,
file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,header:this.raw.header,hdus:this.hdus,data:b}};a.Image.prototype.closeImage=function(){var c,b,d,e,f,g=!1;d=a.images.length;var h=this.display,k=function(b){b.stderr?a.error(b.stderr):b.stdout&&a.log(b.stdout)};for(c=0;c<d;c++)if(this===a.images[c]){d=a.images[c];d===d.display.image&&(g=!0);if(g)for(b in d.clearMessage(),d.display.context.clear(),d.layers)d.layers.hasOwnProperty(b)&&
d.layers[b].canvas.clear();d.xeqPlugins("image","onimageclose");g&&(d.display.image=null);switch(d.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=null}if(a.fits.cleanupFITSFile)for(b=0;b<d.raws.length;b++)e=d.raws[b],e.hdu&&e.hdu.fits&&(f=a.lookupVfile(e.hdu.fits.vfile),1>=f.length&&a.fits.cleanupFITSFile(e.hdu.fits,!0));d.proxyFile&&a.Send("removeproxy",{cmd:"js9Xeq removeproxy "+d.proxyFile},k);d.rgb=null;d.offscreen=
null;d.raw=null;d.colorData=null;d.colorCells=null;d.psColors=null;d=d.psInverse=null;a.images.splice(c,1);break}if(g)for(c=0;c<a.images.length;c++)if(d=a.images[c],h===d.display){d.displayImage("all");d.refreshLayers();break}};a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);
this.offscreen.context=this.offscreen.canvas.getContext("2d");a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.mozImageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1,this.offscreen.context.msImageSmoothingEnabled=!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(c){a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&""===document.domain?
alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};a.Image.prototype.initLCS=function(a){var b=[[0,0,0],[0,0,0],[0,0,0]],c=function(a){var b,c,d=0,e=0,l=[[0,0,0],[0,0,0],[0,0,0]],n=a[0][0]*a[1][1];for(b=0;3>b;b++)for(c=0;2>c;c++)if(void 0===a[b][c]||isNaN(a[b][c]))return null;0<=n?d+=n:e+=n;n=-a[0][1]*a[1][0];0<=n?d+=n:e+=n;b=
d+e;if(0===b||1E-15>Math.abs(b/(d-e)))return null;b=1/b;l[0][0]=a[1][1]*b;l[1][0]=-a[1][0]*b;l[0][1]=-a[0][1]*b;l[1][1]=a[0][0]*b;l[2][0]=-(a[2][0]*l[0][0]+a[2][1]*l[1][0]);l[2][1]=-(a[2][0]*l[0][1]+a[2][1]*l[1][1]);return l};a=a||this.raw.header;b[0][0]=a.LTM1_1||1;b[1][0]=a.LTM2_1||0;b[0][1]=a.LTM1_2||0;b[1][1]=a.LTM2_2||1;b[2][0]=a.LTV1||0;b[2][1]=a.LTV2||0;this.lcs.physical={forward:$.extend(!0,[],b),reverse:c(b)};this.lcs.physical.reverse||delete this.lcs.physical;b[0][0]=a.DTM1_1||1;b[1][0]=
a.DTM2_1||0;b[0][1]=a.DTM1_2||0;b[1][1]=a.DTM2_2||1;b[2][0]=a.DTV1||0;b[2][1]=a.DTV2||0;this.lcs.detector={forward:$.extend(!0,[],b),reverse:c(b)};this.lcs.detector.reverse||delete this.lcs.detector;b[0][0]=a.ATM1_1||1;b[1][0]=a.ATM2_1||0;b[0][1]=a.ATM1_2||0;b[1][1]=a.ATM2_2||1;b[2][0]=a.ATV1||0;b[2][1]=a.ATV2||0;this.lcs.amplifier={forward:$.extend(!0,[],b),reverse:c(b)};this.lcs.amplifier.reverse||delete this.lcs.amplifier;this.lcs[this.params.lcs]||(this.params.lcs="image");this.params.wcssys0||
(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs);return this};a.Image.prototype.mkRawDataFromIMG=function(c){var b,d,e,f,g,h;if(c){b=c.height;d=c.width;e=c.data;this.raws.push({from:"img"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;this.raw.data=new Float32Array(b*d);for(g=c=0;g<b;g++)for(f=0;f<d;f++)h=.299*e[c]+.587*e[c+1]+.114*e[c+2],this.raw.data[(b-g)*d+f]=h,c+=4;this.raw.width=d;this.raw.height=b;this.raw.bitpix=-32;a.Image.prototype.dataminmax.call(this);this.source=
"png";this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix};return this}};a.Image.prototype.mkRawDataFromPNG=function(){var c,b,d,e,f,g,h,k;h=[];d=new ArrayBuffer(8);var l=new Uint8Array(d),n=new DataView(d);if(!this.offscreen.img)return this;this.raws.push({from:"png"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;e=this.offscreen.img.data;for(c=d=0;d<e.length&&0!==e[d];d++)if(255!==e[d]&&(h[c]=String.fromCharCode(e[d]),c++),15===c&&
'{"js9Protocol":'!==h.join("")){f=!0;break}if(15>c||f)a.Image.prototype.mkRawDataFromIMG.call(this,this.offscreen.img);else{c=h.join("");2<a.DEBUG&&a.log("jsonHeader: %s",c);try{b=JSON.parse(c)}catch(p){a.error("can't read FITS header from PNG file: "+c,p)}if(1===b.js9Protocol)this.raw.header=b,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else for(this.raw.endian=b.js9Endian,this.raw.protocol=b.js9Protocol,this.raw.cardstr=b.cardstr,this.raw.ncard=b.ncard,
this.raw.header={},b=this.raw.ncard,c=0;c<b;c++)f=this.raw.cardstr.slice(80*c,80*(c+1)),f=a.cardpars(f),void 0!==f&&(this.raw.header[f[0]]=f[1]);d+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:a.error("BITPIX missing from PNG-based FITS header");"little"===
this.raw.endian?k=!0:"big"===this.raw.endian?k=!1:a.error("js9Endian missing from PNG-based FITS header");this.object=this.raw.header.OBJECT;b=this.raw.width*this.raw.height;f=d%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(b);for(c=0;c<b;c++){switch(f){case 0:g=e[d];d+=1;f=1;break;case 1:g=e[d];d+=1;f=2;break;case 2:g=e[d];d+=2;f=0;break;case 3:g=e[d+1],d+=2,f=1}this.raw.data[c]=g}break;case 16:case -16:16===this.raw.bitpix?(this.raw.data=new Int16Array(b),h=DataView.prototype.getInt16):
(this.raw.data=new Uint16Array(b),h=DataView.prototype.getUint16);for(c=0;c<b;c++){switch(f){case 0:l[0]=e[d];l[1]=e[d+1];g=h.call(n,0,k);d+=2;f=2;break;case 1:l[0]=e[d];l[1]=e[d+1];g=h.call(n,0,k);d+=3;f=0;break;case 2:l[0]=e[d];l[1]=e[d+2];g=h.call(n,0,k);d+=3;f=1;break;case 3:l[0]=e[d+1],l[1]=e[d+2],g=h.call(n,0,k),d+=3,f=2}this.raw.data[c]=g}break;case 32:case -32:32===this.raw.bitpix?(this.raw.data=new Int32Array(b),h=DataView.prototype.getInt32):(this.raw.data=new Float32Array(b),h=DataView.prototype.getFloat32);
for(c=0;c<b;c++){switch(f){case 0:l[0]=e[d];l[1]=e[d+1];l[2]=e[d+2];l[3]=e[d+4];g=h.call(n,0,k);d+=5;f=1;break;case 1:l[0]=e[d];l[1]=e[d+1];l[2]=e[d+3];l[3]=e[d+4];g=h.call(n,0,k);d+=5;f=2;break;case 2:l[0]=e[d];l[1]=e[d+2];l[2]=e[d+3];l[3]=e[d+4];g=h.call(n,0,k);d+=6;f=0;break;case 3:l[0]=e[d+1],l[1]=e[d+2],l[2]=e[d+3],l[3]=e[d+5],g=h.call(n,0,k),d+=6,f=1}this.raw.data[c]=g}break;case -64:this.raw.data=new Float64Array(b);for(c=0;c<b;c++){switch(f){case 0:case 4:l[0]=e[d];l[1]=e[d+1];l[2]=e[d+2];
l[3]=e[d+4];l[4]=e[d+5];l[5]=e[d+6];l[6]=e[d+8];l[7]=e[d+9];g=n.getFloat64(0,k);d+=10;f=2;break;case 1:case 5:l[0]=e[d];l[1]=e[d+1];l[2]=e[d+3];l[3]=e[d+4];l[4]=e[d+5];l[5]=e[d+7];l[6]=e[d+8];l[7]=e[d+9];g=n.getFloat64(0,k);d+=11;f=0;break;case 2:case 6:l[0]=e[d];l[1]=e[d+2];l[2]=e[d+3];l[3]=e[d+4];l[4]=e[d+6];l[5]=e[d+7];l[6]=e[d+8];l[7]=e[d+10];g=n.getFloat64(0,k);d+=11;f=1;break;case 3:case 7:l[0]=e[d+1],l[1]=e[d+2],l[2]=e[d+3],l[3]=e[d+5],l[4]=e[d+6],l[5]=e[d+7],l[6]=e[d+9],l[7]=e[d+10],g=n.getFloat64(0,
k),d+=11,f=2}this.raw.data[c]=g}break;default:a.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}this.dataminmax();this.offscreen.img=null;this.initWCS();this.initLCS();return this}};a.Image.prototype.mkRawDataFromHDU=function(c,b){var d,e,f,g,h,k,l,n;b=b||{};$.isArray(c)||a.isTypedArray(c)||c instanceof ArrayBuffer?($.isArray(c[0])&&(c=c.reduce(function(a,b){return a.concat(b)})),g={image:c}):"object"===typeof c?g=c:a.error("unknown or missing input for HDU creation");g.data&&!g.image&&
(g.image=g.data);g.image||a.error("data missing from JS9 FITS object"+JSON.stringify(g));2>g.naxis&&a.error("can't image a FITS file with less than 2 dimensions");this.raw&&(k=this.raw.width,l=this.raw.height,n=this.raw.bitpix);if(h=this.raws.length){b.rawid=b.rawid||a.RAWIDX;for(d=f=0;d<h;d++)if(b.rawid===this.raws[d].id){e=this.raws[d].from;this.raws[d]={from:e,id:b.rawid};this.raw=this.raws[d];f++;break}f||(this.raws.push({from:"hdu",id:b.rawid}),this.raw=this.raws[h])}else this.raws.push({from:"hdu"}),
this.raw=this.raws[h],this.raw.id=a.RAWID0;this.raw.hdu=g;g.axis?(this.raw.width=g.axis[1],this.raw.height=g.axis[2]):g.naxis1&&g.naxis2?(this.raw.width=g.naxis1,this.raw.height=g.naxis2):k&&l&&(this.raw.width=k,this.raw.height=l);g.bitpix?this.raw.bitpix=g.bitpix:n&&(this.raw.bitpix=n);if("base64"===g.encoding)for(e=window.atob(g.image),g.image=new ArrayBuffer(e.length),f=new Uint8Array(g.image),d=0;d<e.length;d++)f[d]=e.charCodeAt(d);$.isArray(g.image[0])&&(g.image=g.image.reduce(function(a,b){return a.concat(b)}));
switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g.image);break;case 16:this.raw.data=new Int16Array(g.image);break;case -16:this.raw.data=new Uint16Array(g.image);break;case 32:this.raw.data=new Int32Array(g.image);break;case -32:this.raw.data=new Float32Array(g.image);break;case -64:this.raw.data=new Float64Array(g.image)}this.raw.card=g.card;this.raw.cardstr=g.cardstr;this.raw.ncard=g.ncard;if(g.head)this.raw.header=g.head;else if(this.raw.card)for(this.raw.header={},f=this.raw.card.length,
d=0;d<f;d++)h=a.cardpars(this.raw.card[d]),void 0!==h&&(this.raw.header[h[0]]=h[1]);else if(this.raw.cardstr)for(this.raw.header={},f=this.raw.ncard,d=0;d<f;d++)h=this.raw.cardstr.slice(80*d,80*(d+1)),h=a.cardpars(h),void 0!==h&&(this.raw.header[h[0]]=h[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;void 0===g.x1||void 0===g.y1||1===g.x1&&1===g.y1||(void 0!==
this.raw.header.CRPIX1&&(this.raw.header.CRPIX1-=g.x1-1),void 0!==this.raw.header.CRPIX2&&(this.raw.header.CRPIX2-=g.x2-1),void 0===this.raw.header.LTM1_1&&(this.raw.header.LTM1_1=1),void 0===this.raw.header.LTM2_1&&(this.raw.header.LTM2_1=0),void 0===this.raw.header.LTM1_2&&(this.raw.header.LTM1_2=0),void 0===this.raw.header.LTM2_2&&(this.raw.header.LTM2_2=1),this.raw.header.LTV1=void 0===this.raw.header.LTV1?-g.x1-1:this.raw.header.LTV1-(g.x1-1),this.raw.header.LTV2=void 0===this.raw.header.LTV2?
-g.y1-1:this.raw.header.LTV2-(g.y1-1));b.file?this.file=b.file:g.filename&&(this.file=g.filename);this.file0=this.file=this.file||a.ANON+a.uniqueID();b.id&&(this.id0=b.id,this.id=a.getImageID(b.id,this.display.id,this));this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||(this.raw.hdu.fits?this.raw.hdu.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.hdu.fits.extname)):this.raw.hdu.fits.extnum&&0<this.raw.hdu.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,
""),this.file+=sprintf("[%s]",this.raw.hdu.fits.extnum)):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.header.EXTNAME)));this.id||(this.id0=this.file.split("/").reverse()[0],this.id=a.getImageID(this.id0,this.display.id));g.dmin&&g.dmax?(this.raw.dmin=g.dmin,this.raw.dmax=g.dmax):this.dataminmax();this.imtab=g.imtab?g.imtab:g.table?"table":"image";this.object=this.raw.header.OBJECT;this.binning.bin="table"===this.imtab&&g.table?
Number(g.table.bin)||1:1;this.initWCS();this.initLCS();try{e=a.listhdu(this.raw.hdu.fits.vfile),this.hdus=JSON.parse(e)}catch(p){}if(a.fits.cleanupFITSFile&&g.fits.vfile){e=a.globalOpts.clearImageMemory.toLowerCase().split(",");f=!1;d=0;for(h=!1;d<e.length&&!h;d++)switch(e[d]){case "never":f=!1;h=!0;break;case "always":h=f=!0;break;case "auto":2>=this.raw.header.NAXIS&&(!this.hdus||1===this.hdus.length)?f=!0:(f=!1,h=!0);break;case "nocube":2>=this.raw.header.NAXIS?f=!0:(f=!1,h=!0);break;case "noext":this.hdus&&
1!==this.hdus.length?(f=!1,h=!0):f=!0;break;case "size":e[d+1]?a.vsize(g.fits.vfile)>1E6*e[d+1]?f=!0:(f=!1,h=!0):(f=!1,h=!0)}f&&(1<a.DEBUG&&a.log("removing underlying FITS vfile for %s: %s",this.id,this.raw.hdu.fits.vfile),a.fits.cleanupFITSFile(this.raw.hdu.fits,!0))}return this};a.Image.prototype.mkSection=function(a,b,d){var c=this.rgb.sect;c.ozoom=c.zoom;switch(arguments.length){case 0:c.xcen=Math.floor(this.raw.width/2);c.ycen=Math.floor(this.raw.height/2);c.width=Math.min(this.raw.width,this.display.canvas.width);
c.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:c.zoom=a;c.width=Math.min(this.raw.width*c.zoom,this.display.canvas.width);c.height=Math.min(this.raw.height*c.zoom,this.display.canvas.height);break;case 2:c.xcen=parseInt(a,10);c.ycen=parseInt(b,10);break;case 3:c.xcen=parseInt(a,10),c.ycen=parseInt(b,10),c.zoom=d,c.width=Math.min(this.raw.width*c.zoom,this.display.canvas.width),c.height=Math.min(this.raw.height*c.zoom,this.display.canvas.height)}c.width=Math.floor(c.width);
c.height=Math.floor(c.height);c.x0=Math.floor(c.xcen-(c.width+1)/(2*c.zoom)+1);c.y0=Math.floor(c.ycen-(c.height+1)/(2*c.zoom)+1);c.x1=Math.floor(c.xcen+c.width/(2*c.zoom));c.y1=Math.floor(c.ycen+c.height/(2*c.zoom));0>c.x0&&(c.x1-=c.x0,c.x0=0);0>c.y0&&(c.y1-=c.y0,c.y0=0);c.x1>this.raw.width&&(c.x0-=c.x1-this.raw.width,c.x1=this.raw.width);c.y1>this.raw.height&&(c.y0-=c.y1-this.raw.height,c.y1=this.raw.height);c.x0=Math.max(0,c.x0);c.y0=Math.max(0,c.y0);this.offscreenRGB=null;return this};a.Image.prototype.mkColorData=
function(){var c,b,d=a.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(d-1)/(f-e);this.colorData||(this.colorData=[]);for(c=0;c<g;c++)b=this.raw.data[c],this.colorData[c]=b<=e?0:b>=f?d-1:Math.floor((b-e)*h+.5);return this};a.Image.prototype.calcContrastBias=function(c){var b=a.COLORSIZE,d=this.params.bias,e=this.params.contrast;if(1E-4>d-.5&&1E-4>e-1)return c;this.params.invert&&(d=1-d);c=Math.floor(((c/b-d)*e+.5)*b);return 0>c?0:c>=b?b-1:c};a.Image.prototype.mkColorCells=
function(){var c,b,d=a.COLORSIZE;this.colorCells||(this.colorCells=[]);for(c=0;c<d;c++)b=this.params.invert?d-c-1:c,b=this.calcContrastBias(b),this.colorCells[c]=this.cmapObj.mkColorCell(b);return this};a.Image.prototype.mkScaledCells=function(){var c,b,d,e,f,g,h,k,l,n,p,t;h=a.COLORSIZE;var m=a.SCALESIZE,q=a.INVSIZE;f=a.HISTSIZE;if(!this.colorCells)return this;if(!this.psColors){d=this.psColors=[];b=this.params.nancolor;k=[];"#"===b.charAt(0)&&(b=b.slice(1));b=b.toUpperCase();for(c=g=0;6>g;g+=2,c++)t=
"0123456789ABCDEF".indexOf(b.charAt(g)),e="0123456789ABCDEF".indexOf(b.charAt(g+1)),k[c]=16*t+e;d[NaN]=k}this.psInverse||(this.psInverse=[],this.psInverse[NaN]=0);b=this.params.scalemax-this.params.scalemin;g=this.params.scalemin;switch(this.params.scale){case "linear":for(d=0;d<m;d++)c=d/m,c=Math.floor(c*h),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=d/q,this.psInverse[d]=c*b+g;break;case "log":f=this.params.exp;for(d=0;d<m;d++)c=Math.log(f*d/m+1)/Math.log(f),c=Math.floor(c*h),c>=h&&(c=
h-1),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=(Math.pow(f,d/q)-1)/f,this.psInverse[d]=c*b+g;break;case "power":f=this.params.exp;for(d=0;d<m;d++)c=(Math.pow(f,d/m)-1)/f,c=Math.floor(c*h),c>=h&&(c=h-1),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=Math.log(f*d/q+1)/Math.log(f),this.psInverse[d]=c*b+g;break;case "sqrt":for(d=0;d<m;d++)c=d/m,c=Math.floor(Math.sqrt(c)*h),c>=h&&(c=h-1),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=d/q,this.psInverse[d]=c*c*b+g;break;case "squared":for(d=
0;d<m;d++)c=d/m,c=Math.floor(c*c*h),c>=h&&(c=h-1),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=Math.sqrt(d/q),this.psInverse[d]=c*b+g;break;case "asinh":for(d=0;d<m;d++)c=d/m,c=Math.floor(Math.asinh(10*c)/3*h),c>=h&&(c=h-1),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=d/q,c=Math.sinh(3*c)/10,this.psInverse[d]=c*b+g;break;case "sinh":for(d=0;d<m;d++)c=d/m,c=Math.floor(Math.sinh(3*c)/10*h),c>=h&&(c=h-1),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++)c=d/q,c=Math.asinh(10*c)/3,
this.psInverse[d]=c*b+g;break;case "histeq":k=this.raw.data;l=this.raw.width*this.raw.height;b=this.raw.dmax-this.raw.dmin;p=this.raw.dmax;g=this.raw.dmin;n=c=0;t=[];if(!this.hist||!this.hist.length){this.hist=[];for(d=0;d<f;d++)t[d]=0;for(d=0;d<l;d++)k[d]>=g&&k[d]<=p&&(e=Math.floor((k[d]-g)/b*f+.5),e<f&&(t[e]+=1));for(d=0;d<f;d++)n+=t[d];e=n/f;for(d=k=0;d<f&&k<f;d++)for(this.hist[d]=k/f,c+=t[d];c>=e&&k<f;)c-=e,k++;for(c=(f-1)/f;d<f;)this.hist[d++]=c}for(d=0;d<m;d++)c=this.hist[d*f/m],c=Math.floor(c*
h),this.psColors[d]=this.colorCells[c];for(d=0;d<q;d++){h=d/q;for(e=0;e<f-1&&!(this.hist[e]>h);e++);c=e/f;this.psInverse[d]=c*b+g}break;default:a.log("unknown scale '"+this.params.scale+"'")}return this};a.Image.prototype.mkRGBImage=function(){var c,b,d,e,f,g,h,k,l,n,p,t,m,q,r,u,w,y,x,z,v=null,A=null,B=null,C=!1;if(!this.rgb)return this;!a.globalOpts.rgb.active||this!==a.globalOpts.rgb.rim&&this!==a.globalOpts.rgb.gim&&this!==a.globalOpts.rgb.bim||(C=!0,a.globalOpts.rgb.rim&&(v=a.globalOpts.rgb.rim),
a.globalOpts.rgb.gim&&(A=a.globalOpts.rgb.gim),a.globalOpts.rgb.bim&&(B=a.globalOpts.rgb.bim));h=this.display.context;c=this.rgb;b=c.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){f=b.width/b.zoom;g=b.height/b.zoom;d=b.x0;e=this.offscreen.canvas.height-1-(b.y0+g);e=this.offscreen.context.getImageData(d,e,f,g);if(1===b.zoom)c.img=e;else for(c.img=
h.createImageData(b.width,b.height),c=c.img,n=k=0;k<e.height;k++,n++)for(u=k*e.width,t=n*b.zoom,l=h=0;h<e.width;h++,l++)for(d=4*(u+h),p=l*b.zoom,m=0;m<b.zoom;m++)for(q=Math.floor(t+m),w=q*b.width,q=0;q<b.zoom;q++)r=Math.floor(p+q),r=4*(w+r),c.data[r]=e.data[d],c.data[r+1]=e.data[d+1],c.data[r+2]=e.data[d+2],c.data[r+3]=e.data[d+3];return this}c.img&&c.img.width===b.width&&c.img.height===b.height||(c.img=h.createImageData(b.width,b.height));c=c.img;if(!this.psColors)return this;y=void 0!==this.params.opacity?
255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255;this.maskData&&(this.params.maskInvert?void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.opacity,f=255*this.params.maskOpacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha2,f=this.params.alpha1):(e=0,f=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.maskOpacity,f=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==
this.params.alpha2?(e=this.params.alpha1,f=this.params.alpha2):(e=255,f=0));k=b.y1-1;for(n=0;k>=b.y0;k--,n++)for(u=k*this.raw.width,t=n*b.zoom,h=b.x0,l=0;h<b.x1;h++,l++){if(C){if(g=v?v.colorData[u+h]:0,x=A?A.colorData[u+h]:0,z=B?B.colorData[u+h]:0,void 0===g||void 0===x||void 0===z)return a.globalOpts.rgb.active=!1,a.error("RGB images are incompatible. Turning off RGB mode.","",!1),a.Image.prototype.mkRGBImage.call(this),this}else d=this.colorData[u+h];this.maskData&&(y=0<this.maskData[u+h]?e:f);
p=l*b.zoom;for(m=0;m<b.zoom;m++)for(q=Math.floor(t+m),w=q*b.width,q=0;q<b.zoom;q++)r=Math.floor(p+q),r=4*(w+r),C?(c.data[r]=v?v.psColors[g][0]:0,c.data[r+1]=A?A.psColors[x][1]:0,c.data[r+2]=B?B.psColors[z][2]:0):(c.data[r]=this.psColors[d][0],c.data[r+1]=this.psColors[d][1],c.data[r+2]=this.psColors[d][2]),c.data[r+3]=y}return this};a.Image.prototype.blendImage=function(c,b,d){var e=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;
if(0===arguments.length)return this.blend;if(!0===c||!1===c)return this.blend.active=c,this.display.blendMode&&this.displayImage(),this;if(a.notNull(c)||a.notNull(b))a.notNull(c)&&(e.test(c)||a.error("invalid composite/blend operation: "+c),this.blend.mode=c),a.notNull(b)&&(this.blend.opacity=b),a.notNull(d)&&(this.blend.active=d),this.display.blendMode&&this.blend.active&&this.displayImage();return this};a.Image.prototype.putImage=function(c){var b=this.rgb,d=this.display,e=d.context,f=function(b,
c){var d,e;b.offscreenRGB||(e=document.createElement("canvas"),d=e.getContext("2d"),e.width=c.width,e.height=c.height,a.ANTIALIAS||(d.imageSmoothingEnabled=!1,d.mozImageSmoothingEnabled=!1,d.webkitImageSmoothingEnabled=!1,d.msImageSmoothingEnabled=!1),d.putImageData(c,0,0),b.offscreenRGB={canvas:e,context:d});return b.offscreenRGB.canvas};c=c||{};this.ix=Math.floor((d.canvas.width-b.img.width)/2);this.iy=Math.floor((d.canvas.height-b.img.height)/2);"reproject"===this.rawDataLayer()&&c.wcsim&&(this.wcsix=
c.wcsim.ix+c.wcsim.raw.wcsinfo.crpix1-this.raw.wcsinfo.crpix1,this.wcsiy=c.wcsim.iy+c.wcsim.raw.wcsinfo.crpix2-this.raw.wcsinfo.crpix2);a.notNull(c.opacity)||a.notNull(c.blend)?(e.save(),void 0!==c.opacity&&(e.globalAlpha=c.opacity),void 0!==c.blend&&(e.globalCompositeOperation=c.blend),e.drawImage(f(this,b.img),this.ix,this.iy),e.restore()):(this.params.wcsalign&&void 0!==this.wcsix&&void 0!==this.wcsiy&&(this.ix=this.wcsix,this.iy=this.wcsiy),e.putImageData(b.img,this.ix,this.iy));return this};
a.Image.prototype.displayImage=function(c,b){var d,e,f;f=0;var g=[],h={};if(!1===c)return this.displayMode=!1,this;!0===c&&(this.displayMode=!0,c="all");if(!this.displayMode)return this;"object"===typeof c&&(b=c,c=null);c?"all"===c?(c="colors,scaled,rgb,display,plugins",h.notify=!0):"rgbonly"===c?(c="rgb,nodisplay",h.notify=!0):"display"===c&&(h.notify=!0):c="rgb";c.split(",").forEach(function(a,b,c){a=a.trim();h[a]=!0;switch(a){case "colors":h.scaled=!0;h.rgb=!0;break;case "scaled":h.rgb=!0}});h.display=
!0;h.plugins=!0;this.rgbFile&&(h.colors=!1,h.scaled=!1);b=b||{};if(this.display.blendMode&&!1!==b.blendMode)for(d=0;d<a.images.length;d++)e=a.images[d],e.display===this.display&&e.blend.active&&(g.push(e),f++);h.colors&&(this.mkColorData(),this.offscreenRGB=null);h.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null);if(h.rgb&&(this.mkRGBImage(),this.offscreenRGB=null,f))for(d=g.length-1;0<=d;d--)e=g[d],e.mkRGBImage(),e.offscreenRGB=null;if(h.nodisplay)return this;if(h.display){this.display.context.clear();
if(f)for(d=g.length-1;0<=d;d--)e=g[d],f={blend:e.blend.mode,opacity:e.blend.opacity},e.putImage(f),e===this&&(e.displayShapeLayers(),h.notify&&e.notifyHelper());else this.putImage(b),this.displayShapeLayers(),h.notify&&this.notifyHelper();this.display.image=this;if(this.delayedShapes&&this.delayedShapes.length){for(;this.delayedShapes.length;)d=this.delayedShapes.shift(),this.addShapes(d.layer,d.shape,d.opts);delete this.delayedShapes}}this.xeqPlugins("image","onimagedisplay");return this};a.Image.prototype.refreshImage=
function(c,b){var d,e,f,g,h,k;b=b||{};b.rawid=b.rawid||a.RAWID0;"function"===typeof b&&(b={onrefresh:b});!b.onrefresh&&a.imageOpts.onrefresh&&(b.onrefresh=a.imageOpts.onrefresh);d=this.rgb.sect.xcen;e=this.rgb.sect.ycen;h=this.rgb.sect.zoom;f=this.raw.width;g=this.raw.height;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(c,b);k=this.binning.obin!==this.binning.bin;this.raw.width===f&&this.raw.height===g?this.mkSection(d,e,h):(this.mkSection(),this.mkSection(h),k=!0);this.displayImage("colors",
b);k&&(this.refreshLayers(),this.updateShapes("regions","all","binning"));if(b.onrefresh)try{a.xeqByName(b.onrefresh,window,this)}catch(l){a.error("in image refresh callback",l)}this.xeqPlugins("image","onimagerefresh");return this};a.Image.prototype.displayExtension=function(c,b){var d,e,f,g,h,k=this,l=function(c){var d;d="";var e={};c.fits.extname?d=sprintf("[%s]",c.fits.extname):c.fits.extnum&&(d=0<c.fits.extnum?sprintf("[%s]",c.fits.extnum):"");d=k.id.replace(/\[.*\]/,"")+d;b.separate?(e.id=d,
e.display=k.display,a.checkNew(new a.Image(c,e))):(e.file=d,e.id=d,k.refreshImage(c,e))};void 0===c&&a.error("missing extname/extnum for displayExtension()");b=b||{};this.hdus||a.error("no FITS HDUs found for displayExtension()");if(this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.fptr){f={fptr:this.raw.hdu.fits.fptr,vfile:this.raw.hdu.fits.vfile};if("string"===typeof c){f.extname=c;g=c.toLowerCase();for(e=d=0;d<this.hdus.length;d++)if(this.hdus[d].name&&this.hdus[d].name.toLowerCase()===g){e++;
break}e||a.error(sprintf("no FITS HDU %s for displayExtension()",c))}else"number"===typeof c&&(f.extnum=c,this.hdus[c]?g=this.hdus[c].name||c.toString():a.error(sprintf("no FITS HDU %s for displayExtension()",c)));if(b.separate){d=sprintf("[%s]",g);g=this.id.replace(/\[.*\]/,"")+d;for(e=d=0;d<a.images.length;d++)if(h=a.images[d],g===h.id&&0<$("#"+h.display.id).length&&this.display.id===h.display.id){e++;break}if(e){h.displayImage("display",b);h.clearMessage();return}}try{a.handleFITSFile("",f,l)}catch(n){a.error("can't process FITS extension",
n)}}else a.error("virtual FITS file is missing for extension display");return this};a.Image.prototype.displaySlice=function(c,b){var d,e=this,f=function(c){var f;b.separate?(f=sprintf("[%s]",d.slice),f=f.replace(/([0-9][0-9]*)/,"$1:$1"),b.id=e.id.replace(/\[.*\]/,"")+f,c.filename=e.file.replace(/\[.*\]/,"")+f,(f=a.lookupImage(b.id,e.display.id))?(f.slice=d.slice,f.displayImage("display",b),f.clearMessage()):a.Load(c,b,{display:b.display||e.display})):(e.slice=d.slice,e.refreshImage(c,a.fits.options))};
void 0===c&&a.error("missing slice for displaySlice()");b=b||{};if(this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.fptr){d={fptr:this.raw.hdu.fits.fptr,vfile:this.raw.hdu.fits.vfile};a.isNumber(c)?d.slice=sprintf("*,*,%s",c):d.slice=c;try{a.handleFITSFile("",d,f)}catch(g){a.error("can't process FITS slice",g)}}else a.error("virtual FITS file is missing for slice display");return this};a.Image.prototype.toArray=function(){var c,b,d,e,f,g,h,k,l,n;l=this.raw.data.buffer;g=a.raw2FITS(this.raw);h=2880-
g.length%2880;2880===h&&(h=0);for(c=0;c<h;c++)g+=" ";h=2880-l.byteLength%2880;2880===h&&(h=0);c=new ArrayBuffer(g.length+l.byteLength+h);k=new Uint8Array(c);for(c=0;c<g.length;c++)k[c]=g.charCodeAt(c);if(0<(new Int8Array((new Int16Array([1])).buffer))[0])for(f=g.length,e=Math.abs(this.raw.bitpix)/8,n=new Uint8Array(l),c=0;c<n.byteLength;c+=e)for(b=c+e-1,d=0;d<e;b--,d++)k[f++]=n[b];else k.set(new Uint8Array(l),g.length);f=g.length+l.byteLength;for(c=0;c<h;c++)k[f++]=0;return k};a.Image.prototype.getPan=
function(){return{x:(this.rgb.sect.x0+this.rgb.sect.x1)/2+1,y:(this.rgb.sect.y0+this.rgb.sect.y1)/2+1}};a.Image.prototype.setPan=function(c,b){var d,e,f,g,h,k=this.raw.width/2,l=this.raw.height/2;0===arguments.length&&(c=k,b=l);this.mkSection(c,b);if(this.display.blendMode)for(d=0;d<a.images.length;d++)h=a.images[d],h!==this&&h.display===this.display&&h.blend.active&&(f=h.raw.width/2,g=h.raw.height/2,0!==arguments.length&&(f-=k-c,g-=l-b),a.Image.prototype.mkSection.call(h,f,g));this.displayImage("rgb");
for(e in this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].show&&this.layers[e].opts.panzoom&&this.refreshShapes(e);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan");return this};a.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};a.Image.prototype.parseZoom=function(a){var b;b=this.rgb.sect.zoom;switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=b*parseFloat(a.slice(1));break;case "/":a=b/parseFloat(a.slice(1));break;case "I":case "i":a=
2*b;break;case "O":case "o":a=b/2;break;case "T":case "t":a=Math.min(this.display.width,this.display.height)/Math.max(this.raw.width,this.raw.height);a=Math.round(100*(a+1E-5))/100;break;default:a=parseFloat(a)}break;case "number":break;default:return}return a};a.Image.prototype.setZoom=function(c){var b,d,e;if(b=this.parseZoom(c)){this.mkSection(b);if(this.display.blendMode)for(c=0;c<a.images.length;c++)e=a.images[c],e!==this&&e.display===this.display&&e.blend.active&&a.Image.prototype.mkSection.call(e,
b);this.displayImage("rgb");for(d in this.layers)this.layers.hasOwnProperty(d)&&this.layers[d].show&&this.layers[d].opts.panzoom&&this.refreshShapes(d);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom");return this}};a.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom());this.binning.obin=this.binning.bin;this.rgb.sect.ozoom=this.rgb.sect.zoom};a.Image.prototype.imageToLogicalPos=function(a,b){var c,e=a.x,f=a.y,g="image";b=b||this.params.lcs||"image";switch(b){case "physical":this.lcs.physical&&
(g=b,c=this.lcs.physical.reverse);break;case "detector":this.lcs.detector&&(g=b,c=this.lcs.detector.reverse);break;case "amplifier":this.lcs.amplifier&&(g=b,c=this.lcs.amplifier.reverse)}c&&(e=a.x*c[0][0]+a.y*c[1][0]+c[2][0],f=a.x*c[0][1]+a.y*c[1][1]+c[2][1]);return{x:e,y:f,sys:g}};a.Image.prototype.logicalToImagePos=function(a,b){var c,e={x:a.x,y:a.y};b=b||this.params.lcs||"image";switch(b){case "physical":this.lcs.physical&&(c=this.lcs.physical.forward);break;case "detector":this.lcs.detector&&
(c=this.lcs.detector.forward);break;case "amplifier":this.lcs.amplifier&&(c=this.lcs.amplifier.forward)}c&&(e.x=a.x*c[0][0]+a.y*c[1][0]+c[2][0],e.y=a.x*c[0][1]+a.y*c[1][1]+c[2][1]);return e};a.Image.prototype.displayToImagePos=function(a){var b=this.rgb,c=this.rgb.sect,e={};1>=c.zoom?(e.x=(a.x-this.ix)/c.zoom+c.x0+1,e.y=(b.img.height-1-(a.y-this.iy))/c.zoom+c.y0+1):(e.x=(a.x-this.ix)/c.zoom+c.x0+1-.5,e.y=(b.img.height-1-(a.y-this.iy))/c.zoom+c.y0+1-.5);return e};a.Image.prototype.imageToDisplayPos=
function(a){var b=this.rgb,c=this.rgb.sect,e={};1>=c.zoom?(e.x=(a.x-1-c.x0)*c.zoom+this.ix,e.y=(c.y0-(a.y-1))*c.zoom+(b.img.height-1)+this.iy):(e.x=(a.x-1+.5-c.x0)*c.zoom+this.ix,e.y=(c.y0-(a.y-1+.5))*c.zoom+(b.img.height-1)+this.iy);return e};a.Image.prototype.logicalToDisplayPos=function(a){return this.imageToDisplayPos(this.logicalToImagePos(a))};a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};
a.Image.prototype.setWCSSys=function(c){"image"===c?(this.params.wcssys="image",this.params.wcsunits="pixels"):"physical"===c?(this.params.wcssys="physical",this.params.wcsunits="pixels"):this.raw.wcs&&0<this.raw.wcs&&("native"===c&&(c=this.params.wcssys0),c=a.wcssys(this.raw.wcs,c))&&(this.params.wcssys=c.trim(),c="pixels"===this.params.wcsunits?a.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(c),this.updateShapes("regions","all","update"));a.globalOpts.extendedPlugins&&this.xeqPlugins("image",
"onsetwcssys");return this};a.Image.prototype.initWCS=function(c){var b,d,e,f=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;if(!this.raw.header)return this;c=c||this.raw.header;this.raw.altwcs={};b="default";this.raw.altwcs[b]={};this.raw.altwcs[b].header=this.raw.header;for(d in c)c.hasOwnProperty(d)&&(e=d.match(f))&&e.length&&(b=e[2],this.raw.altwcs[b]||(this.raw.altwcs[b]=
{},this.raw.altwcs[b].header=$.extend({},this.raw.header)),"RADESYS"===e[1]&&(e[1]="RADECSYS"),this.raw.altwcs[b].header[e[1]]=c[e[0]]);for(d in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(d)){c=a.raw2FITS(this.raw.altwcs[d].header);this.raw.altwcs[d].wcs=a.initwcs(c);try{this.raw.altwcs[d].wcsinfo=JSON.parse(a.wcsinfo(this.raw.altwcs[d].wcs))}catch(g){}}this.setWCS("default");return this};a.Image.prototype.getWCS=function(){var a,b;for(a in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(a)&&
this.raw.wcs===this.raw.altwcs[a].wcs)return b=$.extend(!0,{},this.raw.altwcs[a].wcsinfo),b.version=a,b.wcsname=this.raw.altwcs[a].header.WCSNAME,b;return null};a.Image.prototype.setWCS=function(c){var b,d;c=c||"default";if(!this.raw||!this.raw.altwcs)return this;for(b in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(b)&&(d=this.raw.altwcs[b].header.WCSNAME,c===b||c===d))return 0>=this.raw.altwcs[b].wcs&&a.error("invalid WCS for version: %s",c),this.raw.wcs=this.raw.altwcs[b].wcs,this.raw.wcsinfo=
this.raw.altwcs[b].wcsinfo,c=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:this.params.wcssys.trim(),this.setWCSSys(c),this.params.wcssys0||(this.params.wcssys0=c),this.setWCSUnits(this.params.wcsunits),this;a.error("could not find WCS version: "+c)};a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};a.Image.prototype.setWCSUnits=function(c){var b;if("pixels"===c)this.params.wcssys="physical",this.params.wcsunits="pixels";else if(this.raw.wcs&&
0<this.raw.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)b=a.imageOpts.wcssys,this.setWCSSys(this.raw.wcs,b);if(c=a.wcsunits(this.raw.wcs,c))this.params.wcsunits=c.trim(),this.updateShapes("regions","all","update")}a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits");return this};a.Image.prototype.notifyHelper=function(){var c,b=this,d=new RegExp("^"+a.ANON+"[0-9]*");a.helper.connected&&!this.file.match(d)&&a.helper.send("image",{image:this.file},function(d){var e,
g;"object"===typeof d?(e=d.stdout,d.stderr&&1<a.DEBUG&&a.log(d.stderr)):e=d;e&&(e=e.trim().split(/ +/),(d=a.lookupImage(e[0],b.display.id||a.DEFID))&&!d.fitsFile&&(e=e[1],"?"!==e&&(a.analOpts.dataDir?(g=e.lastIndexOf("/")+1,d.fitsFile=a.analOpts.dataDir+"/"+e.slice(g)):(d.fitsFile=e,0>d.fitsFile.indexOf("/")&&(c=d.file.match(/.*\//))&&c.length&&(e=new RegExp("^"+a.INSTALLDIR),c=c[0].replace(e,""),d.fitsFile=c+d.fitsFile),a.analOpts.prependJS9Dir&&(d.fitsFile&&"/"!==d.fitsFile.charAt(0)&&(d.fitsFile=
"${JS9_DIR}/"+d.fitsFile),d.parentFile&&"/"!==d.parentFile.charAt(0)&&(d.parentFile="${JS9_DIR}/"+d.parentFile))),1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",d.file,d.fitsFile))),d&&d.fitsFile&&(d.fitsFile=d.fitsFile.replace(/\/\.\//g,"/")),d&&d.parentFile&&(d.parentFile=d.parentFile.replace(/\/\.\//g,"/")),b.queried||(b.queryHelper("all"),b.queried=!0))});return this};a.Image.prototype.queryHelper=function(c){var b=this;c=c||"all";!a.helper.connected||"all"!==c&&"getAnalysis"!==c||this.analysisPackages||
a.helper.send("getAnalysis",{fits:this.fitsFile},function(c){if(c)try{b.analysisPackages=JSON.parse(c)}catch(e){a.log("can't get analysis",e)}});return this};a.Image.prototype.expandMacro=function(c,b){var d,e=this;if(c)return c.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,function(c,g,h){var f;h=function(a,c){var b=a.params.wcssys;if(c)switch(c){case "wcs":if("physical"===b||"image"===b)a.params.wcssys=a.params.wcssys0;break;case "physical":case "image":a.params.wcssys=c}return b};var l=function(a,
c){var b;"table"===a.imtab?a.raw.hdu.table.filter&&!c.match(a.raw.hdu.table.filter)&&(c=c.match(/\]\[/)?c.slice(0,-1)+"&&"+a.raw.hdu.table.filter+"]":c+("["+a.raw.hdu.table.filter+"]")):"image"===a.imtab&&(b=a.file.match(/\[.*\]/))&&(c=c.match(/\[.*\]/)?c.replace(/\[.*\]/,b):c+b);return c},n=g.split("(");n[1]&&(n[1]=n[1].replace(/\)$/,""));switch(n[0]){case "id":f=e.display.divjq.attr("id");break;case "image":case "png":f=e.id;break;case "filename":e.parentFile&&"this"!==n[1]?f=e.parentFile:e.fitsFile?
f=l(e,e.fitsFile):a.error("no FITS file for "+e.id);break;case "fits":e.fitsFile||a.error("no FITS file for "+e.id);f=l(e,e.fitsFile);break;case "parent":e.parentFile||a.error("no parent FITS file for "+e.id);f=e.parentFile;break;case "ext":e.fitsFile?(f=e.fitsFile.match(/\[.*\]/),null===f&&(f="")):a.error("no FITS file for "+e.id);break;case "imcenter":f=e.displayToLogicalPos({x:e.display.width/2,y:e.display.height/2});f=sprintf("%s,%s",f.x,f.y);break;case "wcscenter":f=e.displayToImagePos({x:e.display.width/
2,y:e.display.height/2});f=a.pix2wcs(e.raw.wcs,f.x,f.y).replace(/\s+/g,",");break;case "sregions":c=h(e,n[1]);f=e.listRegions("source",0).replace(/\s+/g,"");c&&(e.params.wcssys=c);break;case "bregions":c=h(e,n[1]);f=e.listRegions("background",0).replace(/\s+/g,"");c&&(e.params.wcssys=c);break;case "regions":c=h(e,n[1]);f=e.listRegions("all",0).replace(/\s+/g,"");c&&(e.params.wcssys=c);break;default:if(b){d=b.length;for(h=0;h<d;h++)if(b[h].name===g){f=b[h].value;break}f||(f="false")}f||(f=c)}return f})};
a.Image.prototype.lookupAnalysis=function(a){var c,d,e,f=null;if(this.analysisPackages){for(d=0;d<this.analysisPackages.length&&!f;d++)for(e=this.analysisPackages[d],c=0;c<e.length;c++){f=e[c];if(f.xclass&&f.xclass+":"+f.name===a)break;f=null}if(f)return f;for(d=0;d<this.analysisPackages.length&&!f;d++)for(e=this.analysisPackages[d],c=0;c<e.length;c++){f=e[c];if(f.name===a)break;f=null}}return f};a.Image.prototype.runAnalysis=function(c,b,d){var e,f=this,g={};d=d||a.globalOpts.analysisFunc;if(a.helper.connected&&
this.analysisPackages){if(e=this.lookupAnalysis(c)){e.action&&(g.cmd=this.expandMacro(e.action,b));if(e.keys)for(g.keys={},c=0;c<e.keys.length;c++)g.keys[e.keys[c]]=this.expandMacro("$"+e.keys[c],b);g.id=this.expandMacro("$id");g.image=this.file;g.fits=this.fitsFile;g.rtype=e.rtype;switch(a.helper.type){case "nodejs":case "socket.io":b=e.xclass?e.xclass+":"+e.name:e.name;break;default:b="runAnalysis"}a.waiting(!0,this.display.divjq[0]);a.helper.send(b,g,function(c){var b,g;a.waiting(!1);b="object"===
typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};b.errcode=b.errcode||0;if(d)d(b.stdout,b.stderr,b.errcode,e);else{if(b.errcode||b.stderr)c=b.stderr?b.stderr:sprintf("ERROR: while executing %s [%s]",e.name,b.errcode),0<=c.search(/WARNING/i)?a.log(c):a.error(c,a.analOpts.epattern);switch(e.rtype){case "text":case void 0:f.displayAnalysis("text",b.stdout,{divid:a.globalOpts.analysisDiv});break;case "plot":f.displayAnalysis("plot",b.stdout,{divid:a.globalOpts.analysisDiv});break;case "alert":b.stdout&&
alert(b.stdout);break;case "fits":case "png":g=b.stdout.split(/\s+/);c=g[0].trim().replace(/\/\.\//,"/");"/"!==c.charAt(0)&&(c=a.InstallDir(c));b={proxyFile:c};g[1]&&(g=g[1].trim().replace(/\/\.\//,"/"),b.parentFile=g);a.Load(c,b,{display:f.display});break;case "none":break;default:a.error("unknown analysis result type: "+e.rtype)}}});return this}a.error("could not find analysis task: "+c)}};a.Image.prototype.displayAnalysis=function(c,b,d){var e,f,g,h,k,l,n,p,t,m={x:"linear",y:"linear"};p=a.lightOpts[a.LIGHTWIN];
var q=function(a){return 0===a?a:Math.log(a)},r=function(a){return 0===a?a:Math.exp(a)},u=function(a,c){var b,d,e;if(!a.text)return null;d=a.x||0;if("%Y"===a.y.toUpperCase())for(b=1;b<c.length-1;b++){if(c[b][0]>d){e=Math.max(c[b-1][1],c[b][1],c[b+1][1]);break}}else e=a.y;return{x:d,y:e}},w=function(a,c,b,d){switch(b){case "x":b=c.getAxes().xaxis;break;case "y":b=c.getAxes().yaxis}switch(d){case "linear":b.options.transform=null;b.options.inverseTransform=null;break;case "log":b.options.transform=
q,b.options.inverseTransform=r}m[b]=d;c.setupGrid();c.draw()},y=function(c,b,d){var e,f,g,h=d.data,l=d.annotations.color||a.plotOpts.annotateColor;c.find(".plotAnnotation").remove();for(e=0;e<d.annotations.data.length;e++)f=d.annotations.data[e],g=u(f,h),g=b.pointOffset({x:g.x,y:g.y}),0>g.left||g.left>c.width()||(f=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",g.left,g.top+-25,l,"&darr;"+f.text),c.append(f))},x=function(a,
c,b,d){var e;switch(b){case "x":e={xaxis:{type:d,autorange:!0}};break;case "y":e={yaxis:{type:d,autorange:!0}}}Plotly.restyle(a.attr("id"),e)},z=function(c){var b,d,e,f=c.data,g=c.annotations.color||a.plotOpts.annotateColor,h=[];for(b=0;b<c.annotations.data.length;b++)if(d=c.annotations.data[b],e=u(d,f))d={x:e.x,y:e.y,xref:"x",yref:"y",text:d.text,arrowcolor:g,font:{color:g},showarrow:!0,arrowhead:2,ax:0,ay:-30},h.push(d);return h};d=d||{};e=d.winformat;d.divid&&0<$("#"+d.divid).length&&(l=$("#"+
d.divid));k=d.title||"";this&&!k&&(d=this.fitsFile||this.id||"",d=d.split("/").reverse()[0],k="AnalysisResults: "+d+sprintf(a.IDFMT,this.display.id));d="Analysis_"+a.uniqueID();switch(c){case "text":b="<div class='JS9Analysis'></div>"+("<pre class='JS9AnalysisText'>"+(b||"")+"</pre>")+"</div>";l?l.html(b):(e=e||p.textWin,f=a.lightWin(d,"inline",b,k,e));break;case "plot":try{g=JSON.parse(b)}catch(v){a.error("can't plot return data: "+b,v)}if(!g)return;b=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",
d,d);l?l.html(b):(e=e||p.plotWin,f=a.lightWin(d,"inline",b,k,e));h=$("#"+d+" #"+d+"Plot");l&&(h.css("width",l.css("width")),h.css("height",l.css("height")),h.css("margin",0));if(g.data){switch(a.globalOpts.plotLibrary){case "plotly":t=x;p=$.extend(!0,{},a.plotOpts,g.opts);g.label&&(p.title=g.label);b={x:[],y:[],type:"scatter"};3<=g.data[0].length&&(b.error_y={type:"data",array:[],visible:!0},g.points&&g.points.yerr&&g.points.yerr.color&&(b.error_y.color=g.points.yerr.color));for(e=0;e<g.data.length;e++)b.x.push(g.data[e][0]),
b.y.push(g.data[e][1]),b.error_y&&b.error_y.array&&b.error_y.array.push(g.data[e][2]);a.plotOpts.annotate&&g.annotations&&(p.annotations=z(g));"log"===p.xscale&&(p.xaxis=p.xaxis||{},p.xaxis.type="log",p.xaxis.autorange=!0,m.x="log");"log"===p.yscale&&(p.yaxis=p.yaxis||{},p.yaxis.type="log",p.yaxis.autorange=!0,m.y="log");try{Plotly.newPlot(h.attr("id"),[b],p)}catch(v){a.error("can't plot data (plotly)",v)}break;default:t=w;p=$.extend(!0,{},a.plotOpts,g.opts);a.plotOpts.annotate&&g.annotations&&(p.zoomStack.func=
function(a,c){y(h,a,g)});g.color=g.color||p.color;"log"===g.xscale&&(p.xaxis=p.xaxis||{},p.xaxis.transform=q,p.xaxis.inverseTransform=r,m.x="log");"log"===g.yscale&&(p.yaxis=p.yaxis||{},p.yaxis.transform=q,p.yaxis.inverseTransform=r,m.y="log");try{n=$.plot(h,[g],p)}catch(v){a.error("can't plot data (flot)",v)}a.plotOpts.annotate&&g.annotations&&y(h,n,g)}h.css("outline","none");h.attr("tabindex",0);h.on("keypress",function(a){a=String.fromCharCode(a.which||a.keyCode);m[a]="linear"===m[a]?"log":"linear";
t(h,n,a,m[a])})}break;case "params":case "textline":l?a.allinone?l.html(b):$.ajax({url:b,cache:!1,dataType:"text",success:function(a){l.html(a)}}):(e="params"===c?e||p.paramWin:e||p.dpathWin,f=a.allinone?"inline":"ajax",f=a.lightWin(d,f,b,k,e))}return f};a.Image.prototype.loadAuxFile=function(c,b){var d=this,e,f,g,h,k=a.auxFiles.length,l=[],n=function(){d.aux[f.name]=f;a.Image.prototype.mkOffScreenCanvas.call(h);a.Image.prototype.mkRawDataFromPNG.call(h);if(b)try{a.xeqByName(b,window,d,f)}catch(q){a.error("in aux mask onload callback",
q)}a.DEBUG&&a.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",h.type,h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)},p=function(c){d.aux[f.name]=f;f.regions=c;if(b)try{a.xeqByName(b,window,d,f)}catch(r){a.error("in aux region onload callback",r)}},t=function(c){d.aux[f.name]=f;f.text=c;if(b)try{a.xeqByName(b,window,d,f)}catch(r){a.error("in aux text onload callback",r)}},m=function(c,b,d){a.log(sprintf("could not load auxiliary file: %s [%s]",f.url,b))};if(c&&k){for(e=0;e<k;e++)f=a.auxFiles[e],
f.image&&!f.regex&&(f.regex=new RegExp(f.image));g=c.split(":");for(e=0;e<k;e++)if(f=a.auxFiles[e],g[0]===f.name&&this.id.match(f.regex)&&(1===g.length||g[1]===f.type))switch(f.type){case "mask":if(f.im){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(q){a.error("in aux mask callback",q)}}else l.push(f);break;case "regions":if(f.layer){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(q){a.error("in aux regions callback",q)}}else l.push(f);break;case "text":if(f.text){if(this.aux[f.name]=
f,b)try{a.xeqByName(b,window,this,f)}catch(q){a.error("in aux text callback",q)}}else l.push(f)}for(e=0;e<l.length;e++)switch(f=l[e],f.type){case "mask":f.im=Object.create(a.Image);h=f.im;h.type="aux";h.file=f.url;h.id=h.file.split("/").reverse()[0];h.params={};h.params.scalemin=Number.Nan;h.params.scalemax=Number.Nan;h.raws=[];h.png={};h.png.image=new Image;$(h.png.image).on("load",n).on("error",m);h.png.image.src=a.InstallDir(f.url);break;case "regions":f.layer=this.display.newShapeLayer(c,a.Regions.opts);
g=a.InstallDir(f.url);$.ajax({url:g,cache:!1,dataType:"json",mimeType:"application/json",success:p,error:m});break;case "text":g=a.InstallDir(f.url),$.ajax({url:g,cache:!1,dataType:"text",success:t,error:m})}}};a.Image.prototype.saveFITS=function(c){var b;window.hasOwnProperty("saveAs")?(c=c||"js9.fits",b=this.toArray(),b=new Blob([b],{type:"application/octet-binary"}),saveAs(b,c)):a.error("no saveAs function available to save FITS file");return c};a.Image.prototype.saveIMG=function(c,b,d){var e,
f,g,h,k,l;if(window.hasOwnProperty("saveAs")){c=c||"js9.png";k=this.display.width;l=this.display.height;f=document.createElement("canvas");f.setAttribute("width",k);f.setAttribute("height",l);g=f.getContext("2d");g.drawImage(this.display.canvas,0,0);for(e in this.layers)this.layers.hasOwnProperty(e)&&"main"===this.layers[e].dlayer.dtype&&this.layers[e].show&&(h=this.layers[e].dlayer.canvasjq[0],g.drawImage(h,0,0,k,l));void 0!==d&&(0>d||1<d)&&(d=.95);f.toBlob(function(a){saveAs(a,c)},b||"image/png",
d)}else a.error("no saveAs function available for saving image");return c};a.Image.prototype.savePNG=function(a){return this.saveIMG(a||"js9.png","image/png")};a.Image.prototype.saveJPEG=function(a,b){return this.saveIMG(a||"js9.jpeg","image/jpeg",b)};a.Image.prototype.updateValpos=function(c,b){var d,e,f,g,h,k;d=null;e=a.floatPrecision(this.params.scalemin,this.params.scalemax);f=function(a,c){var b,d="";c=c||3;0>a&&(a=Math.abs(a),d="-");for(b=""+a;b.length<c;)b="0"+b;return d+b};if(this.params.valpos){void 0===
b&&(b=!0);if(this.valpos)return b&&this.displayMessage("info",this.valpos),this.valpos;g={x:c.x,y:c.y,sys:"image"};k="image"===this.params.wcssys?g:this.imageToLogicalPos(c);d=this.raw.data[Math.floor(c.y-.5)*this.raw.width+Math.floor(c.x-.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:h=f(d);break;case -32:case -64:h=a.floatFormattedString(d,e,3);break;default:h=f(d)}e=h;f=k.x.toFixed(3)+" "+k.y.toFixed(3)+" ("+k.sys+")";d={ix:g.x,iy:g.y,isys:"image",px:k.x,py:k.y,psys:k.sys,ra:"",dec:"",
wcssys:"",val:d,val3:h,vstr:e+"&nbsp;&nbsp;&nbsp;&nbsp;"+f,id:this.id,file:this.file,object:this.object};0<this.raw.wcs&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys&&(k=a.pix2wcs(this.raw.wcs,c.x,c.y).trim().split(/\s+/),g=k[0]+" "+k[1]+" ("+(k[2]||"wcs")+")",d.ra=k[0],d.dec=k[1],d.wcssys=k[2],d.vstr=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+g+"&nbsp;&nbsp;&nbsp;&nbsp;"+f);b&&this.displayMessage("info",d)}return d};a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,
contrast:this.params.contrast,bias:this.params.bias}};a.Image.prototype.setColormap=function(c,b,d){switch(arguments.length){case 1:case 3:switch(c){case "rgb":a.globalOpts.rgb.active=!a.globalOpts.rgb.active;break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=a.imageOpts.invert;this.params.contrast=a.imageOpts.contrast;this.params.bias=a.imageOpts.bias;break;default:if(this.cmapObj)switch(this.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=
null;break;case "blue":a.globalOpts.rgb.bim=null}this.cmapObj=a.lookupColormap(c);this.params.colormap=this.cmapObj.name;switch(c){case "red":a.globalOpts.rgb.rim=this;break;case "green":a.globalOpts.rgb.gim=this;break;case "blue":a.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(b)||(this.params.contrast=b),isNaN(d)||(this.params.bias=d));break;case 2:isNaN(c)||(this.params.contrast=c),isNaN(b)||(this.params.bias=b)}this.displayImage("colors");a.globalOpts.extendedPlugins&&this.xeqPlugins("image",
"onsetcolormap");return this};a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax}};a.Image.prototype.setScale=function(c,b,d){var e=this,f=function(c){0<=a.scales.indexOf(c)?e.params.scale=c:a.error("unknown scale: "+c)};if(arguments.length){switch(arguments.length){case 1:f(c);break;case 2:this.params.scalemin=parseInt(c,10);this.params.scalemax=parseInt(b,10);this.mkColorData();break;default:f(c),
this.params.scalemin=parseInt(b,10),this.params.scalemax=parseInt(d,10),this.mkColorData()}this.displayImage("scaled")}a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetscale");return this};a.Image.prototype.dataminmax=function(){var a,b,d=isNaN(this.params.scalemin)||void 0===this.params.scalemin,e=isNaN(this.params.scalemax)||void 0===this.params.scalemax;if("dataminmax"===this.params.scaleclipping){if(this.raw.dmin===this.params.scalemin||void 0===this.raw.dmin)d=!0;if(this.raw.dmax===
this.params.scalemax||void 0===this.raw.dmax)e=!0}this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;if(0<this.raw.bitpix)if(void 0!==this.raw.header.BLANK)for(b=this.raw.header.BLANK,a=0;a<this.raw.data.length;a++)this.raw.data[a]!==b&&(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));else for(a=0;a<this.raw.data.length;a++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]);
else for(a=0;a<this.raw.data.length;a++)isNaN(this.raw.data[a])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));d&&(this.params.scalemin=this.raw.dmin);e&&(this.params.scalemax=this.raw.dmax);return this};a.Image.prototype.zscale=function(c){var b,d,e;if(!a.zscale||!this.raw||!this.raw.data)return this;b=this.raw.data;d=b.length*b.BYTES_PER_ELEMENT;try{e=a.vmalloc(d)}catch(f){a.error("image too large for zscale malloc: "+d,f)}try{a.vmemcpy(new Uint8Array(b.buffer),
e)}catch(f){a.error("can't copy image to zscale heap: "+d,f)}b=a.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);a.vfree(e);e=b.trim().split(/\s+/);this.params.z1=parseFloat(e[0]);this.params.z2=parseFloat(e[1]);c&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);return this};a.Image.prototype.rawDataLayer=function(c,b){var d,e,f,g,h,k;if(!arguments.length)return this.raw.id;if("string"===
typeof c)if("function"===typeof b)c={rawid:c};else{for(d=0;d<this.raws.length;d++)if(f=this.raws[d],c===f.id){if("remove"===b){"raw0"===c&&a.error("can't remove primary (raw0) data layer");f.hdu&&f.hdu.fits&&(e=a.lookupVfile(f.hdu.fits.vfile),1>=e.length&&a.fits.cleanupFITSFile&&a.fits.cleanupFITSFile(f.hdu.fits,!0));this.raw=this.raws[0];if(f.current0&&f.current0.id)for(e=0;e<this.raws.length;e++)if(f.current0.id===this.raws[e].id){this.raw=this.raws[e];break}this.raws.splice(d,1);this.raw.header.bitpix&&
(this.raw.bitpix=this.raw.header.bitpix);this.dataminmax();this.mkSection();this.displayImage("all",c);return!0}this.raw=f;this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix);this.dataminmax();this.mkSection();this.displayImage("all",c);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer");return!0}return!1}if("function"!==typeof b)return!1;c=c||{};h=c.rawid||a.RAWIDX;void 0===c.oraw&&(c.oraw="current0");if("current"===c.oraw)e=this.raw;else if("current0"===c.oraw){for(d=
0;d<this.raws.length;d++)if(f=this.raws[d],h===f.id){e=f.current0;break}e||(e=this.raw)}else for(d=0;d<this.raws.length;d++)if(f=this.raws[d],c.oraw===f.id){e=f;break}e||(e=this.raws[0]);f=-1;for(d=0;d<this.raws.length;d++)if(h===this.raws[d].id){g=this.raws[d];f=d;break}if(0>f||c.alwaysCopy){g=$.extend(!0,{},e);g.current0=e;if(c.bitpix){switch(c.bitpix){case 8:g.data=new Uint8Array(e.height*e.width);break;case 16:g.data=new Int16Array(e.height*e.width);break;case -16:g.data=new Uint16Array(e.height*
e.width);break;case 32:g.data=new Int32Array(e.height*e.width);break;case -32:g.data=new Float32Array(e.height*e.width);break;case -64:g.data=new Float64Array(e.height*e.width)}k=g.width*g.height;for(d=0;d<k;d++)g.data[d]=e.data[d];g.bitpix=c.bitpix}else switch(e.bitpix){case 8:g.data=new Uint8Array(e.data);break;case 16:g.data=new Int16Array(e.data);break;case -16:g.data=new Uint16Array(e.data);break;case 32:g.data=new Int32Array(e.data);break;case -32:g.data=new Float32Array(e.data);break;case -64:g.data=
new Float64Array(e.data)}g.id=h;g.from=c.from||g.from||"func"}b.call(this,e,g,c)&&(0<=f?this.raws[f]=g:this.raws.push(g),this.raw=g,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==c.dataminmax&&this.dataminmax(),this.displayImage("all",c));return!0};a.Image.prototype.gaussBlurData=function(c){var b={};void 0===c&&a.error("missing sigma value for gaussBlurData");b=b||{};b.bitpix=-64===this.raw.bitpix?-64:-32;b.oraw="current0";b.alwaysCopy=!0;b.rawid=b.rawid||"gaussBlur";b.sigma=
c;this.rawDataLayer(b,function(b,e){var d;switch(e.bitpix){case -32:d=new Float32Array(e.data);break;case -64:d=new Float64Array(e.data);break;default:a.error("invalid temp bitpix for gaussBlur: "+e.bitpix)}gaussBlur(d,e.data,e.width,e.height,c);return!0});return this};a.Image.prototype.imarithData=function(c,b,d){var e;if(!arguments.length)return"add sub mul div min max reset".split(" ");d=d||{};d.rawid=d.rawid||"imarith";if("reset"===c||"remove"===c)this.rawDataLayer(d.rawid,"remove");else{void 0!==
c&&void 0!==b||a.error("missing arg(s) for image arithmetic");switch(c){case "add":case "sub":case "mul":case "div":case "min":case "max":d.op=c;break;default:a.error("invalid operator for image arithmetic: "+c)}"object"===typeof b?(this.raw.width===b.raw.width&&this.raw.height===b.raw.height||a.error("images must be the same size for image arithmetic"),d.argtype="image",d.argval=b):a.isNumber(b)?(d.argtype="value",d.argval=b):((e=a.lookupImage(b))||a.error("imarith arg1 must be an image or a constant: "+
b),d.argval=e,d.argtype="image");"div"===d.op&&"value"===d.argtype&&0===d.argval&&a.error("imarith can't divide by zero (nor can anyone else)");if(!d.bitpix)switch(d.argtype){case "image":d.bitpix=0<this.raw.bitpix&&0<d.argval.raw.bitpix?Math.max(this.raw.bitpix,d.argval.raw.bitpix):0>this.raw.bitpix&&0>d.argval.raw.bitpix?Math.min(this.raw.bitpix,d.argval.raw.bitpix):0>this.raw.bitpix&&0<d.argval.raw.bitpix?this.raw.bitpix:d.argval.raw.bitpix;break;case "value":d.bitpix=-64===this.raw.bitpix?-64:
-32}d.alwaysCopy=!0;d.oraw="current";this.rawDataLayer(d,function(c,b,d){switch(d.argtype){case "image":c=d.argval.raw.data;switch(d.op){case "add":for(d=0;d<b.data.length;d++)b.data[d]+=c[d];break;case "sub":for(d=0;d<b.data.length;d++)b.data[d]-=c[d];break;case "mul":for(d=0;d<b.data.length;d++)b.data[d]*=c[d];break;case "div":for(d=0;d<b.data.length;d++)b.data[d]=0===c[d]?0:b.data[d]/c[d];break;case "min":for(d=0;d<b.data.length;d++)b.data[d]=Math.min(b.data[d],c[d]);break;case "max":for(d=0;d<
b.data.length;d++)b.data[d]=Math.max(b.data[d],c[d]);break;default:a.error("unknown operation for imarith: "+d.op)}break;case "value":c=d.argval;switch(d.op){case "add":for(d=0;d<b.data.length;d++)b.data[d]+=c;break;case "sub":for(d=0;d<b.data.length;d++)b.data[d]-=c;break;case "mul":for(d=0;d<b.data.length;d++)b.data[d]*=c;break;case "div":for(d=0;d<b.data.length;d++)b.data[d]=0===c?0:b.data[d]/c;break;case "min":for(d=0;d<b.data.length;d++)b.data[d]=Math.min(b.data[d],c);break;case "max":for(d=
0;d<b.data.length;d++)b.data[d]=Math.max(b.data[d],c);break;default:a.error("unknown op for imarith: "+d.op)}break;default:a.error("unknown argument type for imarith: "+d.argtype)}return!0});return this}};a.Image.prototype.shiftData=function(c,b,d){void 0!==c&&void 0!==b||a.error("missing translation value(s) for shiftData");d=d||{};d.rawid=d.rawid||"shift";d.x=c;d.y=b;this.rawDataLayer(d,function(a,b,c){var d,e,f,g,p=a.data.BYTES_PER_ELEMENT;void 0===b.xoff&&(b.xoff=0);void 0===b.yoff&&(b.yoff=0);
b.xoff+=c.x;b.yoff+=c.y;if(!c.fill||"clear"===c.fill)if(0<b.bitpix?(g=c.blank||b.header.BLANK||0,b.header.BLANK=g):g=NaN,"function"===typeof b.data.fill)b.data.fill(g);else for(c=0;c<b.data.length;c++)b.data[c]=g;for(c=0;c<a.height;c++)if(f=c+b.yoff,!(0>f||f>=a.height)){d=0;e=d+b.xoff;g=a.width;0>e&&(d-=e,g+=e,e=0);e+g>a.width&&(g-=e+g-a.width);if(0>=g)return!1;d=(c*a.width+d)*p;d=new Uint8Array(a.data.buffer,d,g*p);e=(f*a.width+e)*p;g=new Uint8Array(b.data.buffer,e,g*p);g.set(d)}return!0});return this};
a.Image.prototype.reprojectData=function(c,b){var d=this;a.waiting(!0,this.display.divjq[0]);window.setTimeout(function(){var e={},f=!1,g,h,k,l,n,p,t,m,q,r,u,w,y,x;q=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
r=/TAN|SIN|ZEA|STG|ARC/;var z=function(b){d.refreshImage(b,m);a.waiting(!1)};if(d.raw.wcs&&c&&a.reproject){d.raw.hdu&&d.raw.hdu.fits&&d.raw.hdu.fits.fptr||a.error("virtual FITS file is missing for reprojection");b=b||{};"string"===typeof c&&((n=a.getImage(c))?c=n:a.error("unknown WCS for reproject: "+c));n=$.extend(!0,{},d.raw.header);for(l in n)n.hasOwnProperty(l)&&q.test(l)&&delete n[l];c.raw&&c.raw.header?p=c.raw.header:c.BITPIX&&c.NAXIS1&&c.NAXIS2?p=c:a.error("invalid wcs object input to reproject()");
for(l in p)p.hasOwnProperty(l)&&q.test(l)&&(e[l]=p[l]);e=$.extend(!0,{},e,n);e.NAXIS&&e.NAXIS1&&e.NAXIS2||a.error("invalid FITS image header");e.NAXIS1*e.NAXIS2>a.REPROJDIM*a.REPROJDIM&&a.error("for now, the max image size for reprojection is approximately "+a.REPROJDIM+" * "+a.REPROJDIM);l=a.raw2FITS(e,!0);e="wcs_"+a.uniqueID()+".txt";a.vfile(e,l);try{r.test(d.raw.wcsinfo.ptype)||(k="owcs_"+a.uniqueID()+".txt",a.vfile(k,a.raw2FITS(d.raw.header,!0)),g="awcs_"+a.uniqueID()+".txt",t=a.tanhdr(k,g,""),
1<a.DEBUG&&a.log("tanhdr (input): %s %s -> %s",k,g,t),a.vunlink(k),0<=t.search(/\[struct stat="OK"/)&&(b.cmdswitches=b.cmdswitches||"",b.cmdswitches+=" -i "+g)),r.test(c.raw.wcsinfo.ptype)||(k="owcs_"+a.uniqueID()+".txt",a.vfile(k,a.raw2FITS(p,!0)),h="awcs_"+a.uniqueID()+".txt",t=a.tanhdr(k,h,""),1<a.DEBUG&&a.log("tanhdr (reproj): %s %s -> %s",k,h,t),a.vunlink(k),0<=t.search(/\[struct stat="OK"/)&&(a.vunlink(e),e=h))}catch(v){}d.raw.hdu&&d.raw.hdu.fits.vfile?(h=d.raw.hdu.fits.vfile,d.raw.hdu.fits.extname?
h+=sprintf("[%s]",d.raw.hdu.fits.extname):d.raw.hdu.fits.extnum&&0<d.raw.hdu.fits.extnum&&(h+=sprintf("[%s]",d.raw.hdu.fits.extnum))):(k=d.toArray(),h=d.id.replace(/\.png$/,"_png.fits"),a.vfile(h,k));p=d.id.replace(/\[.*\]/,"").replace(/\.png$/,".fits").replace(/\.gz$/,"");k="reproj_"+a.uniqueID()+"_"+p;"table"===d.imtab&&(q=d.raw.hdu.table,p=Math.floor(q.cx-(q.nx+1)/2+1),r=Math.floor(q.cx+q.nx/2),l=Math.floor(q.cy-(q.ny+1)/2+1),q=Math.floor(q.cy+q.ny/2),p=sprintf("[EVENTS][bin X=%s:%s,Y=%s:%s]",
p,r,l,q),h+=p);try{u=k.lastIndexOf("."),0<=u&&(w=k.substring(0,u)+"_area"+k.substring(u)),x=b.cmdswitches||"",t=a.reproject(h,k,e,x),1<a.DEBUG&&a.log("reproject: %s %s %s [%s] -> %s",h,k,e,x,t),a.vunlink(w),a.vunlink(e),g&&a.vunlink(g),0>t.search(/\[struct stat="OK"/)&&(f=!0,(y=t.match(/msg="(.*)"/))&&y[1]?a.error(y[1]+" (from mProjectPP)"):a.error(t))}catch(v){if(f)return;a.vunlink(w);a.vunlink(e);t?a.error(t):a.error("WCS reproject failed",v)}m=$.extend(!0,{},b||{},a.fits.options);m.rawid=m.rawid||
"reproject";m.wcsim=c;try{a.handleFITSFile(k,m,z)}catch(v){a.error("can't process reprojected FITS file",v)}}},a.SPINOUT);return this};a.Image.prototype.filterRGBImage=function(c){var b,d=[],e=Array.prototype.slice.call(arguments);if(!c){for(b in a.ImageFilters)a.ImageFilters.hasOwnProperty(b)&&d.push(b);return d}"reset"===c||a.ImageFilters[c]||a.error("JS9 image filter '"+c+"' not available");if("reset"===c)return this.setColormap("reset"),this;e.shift();e.unshift(this.display.context,this.rgb.img);
try{a.ImageFilters[c].apply(null,e)}catch(f){a.error("JS9 image filter '"+c+"' failed",f)}this.displayImage("display");a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage");return this};a.Image.prototype.moveToDisplay=function(c){var b,d,e,f=this.display;d=a.lookupDisplay(c);if(!c||!d)return a.error("could not find display: "+c),null;this.clearMessage();this.display.context.clear();this.xeqPlugins("image","onimageclear");for(b in f.layers)f.layers.hasOwnProperty(b)&&("main"!==
f.layers[b].dtype||d.layers[b]||d.newShapeLayer(b,f.layers[b].opts));for(b in this.layers)this.layers.hasOwnProperty(b)&&(c=this.layers[b],(e=d.layers[b])?(d.image&&d.image.showShapeLayer(b,!1),this.showShapeLayer(b,!1),c.dlayer=e,c.divjq=e.divjq,c.canvasjq=e.canvasjq,c.canvas=e.canvas,this.showShapeLayer(b,!0)):delete this.layers[b]);this.display=d;this.display.image=this;this.mkSection();this.displayImage("all");this.refreshLayers();f.image=null;for(b=0;b<a.images.length;b++)if(d=a.images[b],f===
d.display){d.display.image=null;d.displayImage("all");d.refreshLayers();break}return this};a.Image.prototype.saveSession=function(c){var b,d,e,f,g;c=c||"js9.ses";window.hasOwnProperty("saveAs")||a.error("no saveAs function available to save session");a.waiting(!0,this.display.divjq[0]);b={};b.file=this.file;b.params=$.extend(!0,{},this.params);b.params.xcen=this.rgb.sect.xcen;b.params.ycen=this.rgb.sect.ycen;b.params.zoom=this.rgb.sect.zoom;b.layers=[];for(g in this.layers)this.layers.hasOwnProperty(g)&&
(d=this.layers[g],e=d.dlayer,"main"===e.dtype&&(f={},f.name=g,f.json=e.canvas.toJSON(e.el),f.dopts=$.extend(!0,{},e.opts),d.catalog&&(f.catalog=d.catalog),d.starbase&&(f.starbase=JSON.stringify(d.starbase)),b.layers.push(f)));b.dwidth=this.display.width;b.dheight=this.display.height;b.params.display&&delete b.params.display;b=JSON.stringify(b,null,4);b=new Blob([b],{type:"application/json"});saveAs(b,c);a.waiting(!1);return c};a.Image.prototype.xeqPlugins=function(a,b,d){var c,f,g,h,k,l=function(a,
b){var c="JS9:"+a;$(document).trigger(c,b)};if(a&&b){h=this.display.pluginInstances;for(c in h)if(h.hasOwnProperty(c)&&(f=h[c],f.isActive(b)))switch(g=f.plugin.opts,a){case "image":try{g[b].call(f,this),l(b,{im:this})}catch(n){f.errLog(b,n)}break;case "region":case "shape":try{g[b].call(f,this,d),l(b,{im:this,xreg:d})}catch(n){f.errLog(b,n)}break;case "keypress":k=d.originalEvent||d;try{g[b].call(f,this,this.ipos,k),l(b,{im:this,ipos:this.ipos,evt:k})}catch(n){f.errLog(b,n)}break;case "mouse":if(!this.clickInRegion||
g[b+"_inRegion"]){k=d.originalEvent||d;try{g[b].call(f,this,this.ipos,k),l(b,{im:this,ipos:this.ipos,evt:k})}catch(n){f.errLog(b,n)}}}return this}};a.Image.prototype.displayMessage=function(a,b,d){};a.Image.prototype.clearMessage=function(a){};a.Colormap=function(c,b,d,e){this.name=c;switch(arguments.length){case 2:this.type="lut";this.colors=b;break;case 4:this.type="sao";this.vertices=[b,d,e];break;default:a.error("colormap requires a colormap name and 1 or 3 array args")}a.colormaps.push(this);
1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)};a.Colormap.prototype.mkColorCell=function(c){var b,d=a.COLORSIZE,e=[0,0,0],f,g;switch(this.type){case "sao":f=c/d;for(c=0;3>c;c++){g=this.vertices[c];b=g.length;for(d=0;d<b&&!(g[d][0]>f);d++);d=0===d?g[0][1]:d===b?g[b-1][1]:(b=(g[d][1]-g[d-1][1])/(g[d][0]-g[d-1][0]))?b*(f-g[d-1][0])+g[d-1][1]:g[d][1];e[c]=255*d}break;case "lut":f=this.colors.length;c=Math.floor(c*f/d);0>c?(e[0]=255*this.colors[0][0],e[1]=255*this.colors[0][1],e[2]=255*this.colors[0][2]):
c<f?(e[0]=255*this.colors[c][0],e[1]=255*this.colors[c][1],e[2]=255*this.colors[c][2]):(e[0]=255*this.colors[f-1][0],e[1]=255*this.colors[f-1][1],e[2]=255*this.colors[f-1][2]);break;default:a.error("unknown colormap type")}return e};a.Display=function(c){var b=this;this.divjq=c instanceof jQuery?c:"object"===typeof c?$(c):$("#"+c);this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);this.id=this.divjq.attr("id");this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=
a.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=a.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.width0=this.width;this.height0=this.height;this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",a.ZINDEX);
this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);a.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),a.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,
function(){var c=b.divjq.width(),e=b.divjq.height();a.bugs.webkit_resize&&(c-=a.RESIZEFUDGE,e-=a.RESIZEFUDGE);b.resize(c,e)}));this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();
this.blendMode=!1;this.mouseActions=a.globalOpts.mouseActions.slice(0);this.touchActions=a.globalOpts.touchActions.slice(0);this.keyboardActions=$.extend(!0,{},a.globalOpts.keyboardActions);this.mousetouchZoom=a.globalOpts.mousetouchZoom;this.divjq.on("mouseover",this,function(b){return a.mouseOverCB(b)});this.divjq.on("mousedown touchstart",this,function(b){return a.mouseDownCB(b)});this.divjq.on("mousemove touchmove",this,function(b){return a.mouseMoveCB(b)});this.divjq.on("mouseup touchend",this,
function(b){return a.mouseUpCB(b)});this.divjq.on("mouseout",this,function(b){return a.mouseOutCB(b)});this.divjq.on("keypress",this,function(b){return a.keyPressCB(b)});this.divjq.on("keydown",this,function(b){return a.keyDownCB(b)});this.divjq.on("wheel",this,function(b){return a.wheelCB(b)});this.divjq.on("dragenter",this,function(b){return a.dragenterCB(this.id,b)});this.divjq.on("dragover",this,function(b){return a.dragoverCB(this.id,b)});this.divjq.on("dragexit",this,function(b){return a.dragexitCB(this.id,
b)});this.divjq.on("drop",this,function(b){return a.dragdropCB(this.id,b,a.NewFITSImage)});this.divjq.on("contextmenu",this,function(){return!1});this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalFile-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.Load(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="refreshLocalFile-'+
this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.RefreshImage(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalRegions-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadRegions(this.files[i], {display:\''+this.id+"'}); };this.value=null;return false;\"> </div>");
this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalSession-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadSession(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalColormap-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.AddColormap(this.files[i], {display:\''+
this.id+"'});};this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalCatalogs-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadCatalog(null, this.files[i], {display:\''+this.id+"'}); };this.value=null;return false;\"> </div>");a.displays.push(this);a.DEBUG&&a.log("JS9 display:  %s",this.id)};a.Display.prototype.initMessages=function(){this.messageContainer=
$("<div>").addClass("JS9Container").css("z-index",a.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);try{this.messageContainer.draggable({start:function(c,b){this.oicb=a.globalOpts.internalContrastBias;a.globalOpts.internalContrastBias=!1},stop:function(c,b){a.globalOpts.internalContrastBias=this.oicb}})}catch(c){}return this};a.Display.prototype.displayPlugin=
function(c){var b,d,e,f,g,h,k,l;h=this.pluginInstances[c.name];switch(a.globalOpts.winType){case "light":b=a.lightOpts[a.LIGHTWIN];if(h&&h.status)if("inactive"===h.status){if(h.winHandle&&(h.winHandle.show(),h.status="active",c.opts.onplugindisplay))try{c.opts.onplugindisplay.call(h,this.image)}catch(n){a.log("onplugindisplayCB: %s [%s]\n%s",c.name,n.message,a.strace(n))}}else"active"===h.status&&h.winHandle&&(h.winHandle.hide(),h.status="inactive");else if(d=c.name.replace(/\s/g,"_"),e=this.id+"_"+
d+"_lightDiv",f=this.id+"_"+d+"_outerDiv",d=this.id+"_"+d+"_innerDiv",h||(g=$("<div>").attr("id",f).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(c.name).attr("id",d).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(g)),g=c.opts.winDims[0]||a.WIDTH,k=c.opts.winDims[1]||a.HEIGHT,l=c.opts.winResize?"1":"0",b=sprintf(b.format,g,k,l),g=c.opts.toolbarHTML&&0<=c.opts.toolbarHTML.search(/\$title/)?"":c.opts.winTitle||"",g+=sprintf(a.IDFMT,this.id),
f=a.lightWin(e,"div",f,g,b),e=$("#"+e+" #"+d),h=a.instantiatePlugin(e,c,f),h.winHandle.onclose=function(){h.winHandle.hide();h.status="inactive";return!1},h.status="active",c.opts.onplugindisplay)try{c.opts.onplugindisplay.call(h,this.image)}catch(n){a.log("onplugindisplayCB: %s [%s]\n%s",c.name,n.message,a.strace(n))}break;case "new":a.error("external window support for plugins not yet implemented")}};a.Display.prototype.resize=function(c,b,d){var e,f,g,h,k,l=function(a){a.left+=h;a.top+=k;a.setCoords()};
a.globalOpts.resize||a.error("display resize not enabled");if(!c&&!b)return{width:this.width,height:this.height};if("full"===c){if(d=b,window.innerWidth&&(c=window.innerWidth),window.innerHeight)for(b=window.innerHeight,e=0;e<a.globalOpts.centerDivs.length;e++)f=a.globalOpts.centerDivs[e],this.pluginInstances[f]&&(b-=this.pluginInstances[f].divjq.height())}else"reset"===c&&(d=b,c=this.width0||c,b=this.height0||b);c=Math.floor(c);b=b?Math.floor(b):c;(10>c||10>b)&&a.error("invalid dimension(s) passed to display resize");
if(c===this.width&&b===this.height)return this;d=d||{};e=c;c=b;h=(e-this.width)/2;k=(c-this.height)/2;this.width=e;this.height=c;this.divjq.css("width",e);this.divjq.css("height",c);this.canvasjq.attr("width",e);this.canvasjq.attr("height",c);a.bugs.webkit_resize&&!this.resizing&&(this.owidth=Math.min(this.owidth,e),this.oheight=Math.min(this.oheight,c));(void 0===d.resizeMenubar||d.resizeMenubar)&&(b=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",e);if(void 0===d.resizeColorbar||
d.resizeColorbar)if(b=this.pluginInstances.JS9Colorbar)b.divjq.html(""),a.Colorbar.init.call(b,e,null);for(g in this.layers)this.layers.hasOwnProperty(g)&&(b=this.layers[g],"main"===b.dtype&&(b.divjq.css("width",e),b.divjq.css("height",c),b.canvasjq.attr("width",e),b.canvasjq.attr("height",c),b.canvas.setWidth(e),b.canvas.setHeight(c),b.canvas.calcOffset()));for(e=0;e<a.images.length;e++)if(c=a.images[e],c.mkSection(),c.display&&this===c.display&&(c.resize?(c.resize.left+=h,c.resize.top+=k):c.resize=
{left:h,top:k},c===c.display.image))for(g in c.layers)c.layers.hasOwnProperty(g)&&(b=c.layers[g],"main"!==b.dlayer.type||b.json||(b.canvas.getObjects().forEach(l),b.canvas.renderAll()));a.bugs.webkit_resize&&this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE);!this.image||!a.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",d),this.image.refreshLayers());d.center&&this.center();return this};a.Display.prototype.inResize=function(c){return a.globalOpts.resizeHandle&&
c.x+a.RESIZEDIST>=this.divjq.width()&&c.y+a.RESIZEDIST>=this.divjq.height()?!0:!1};a.Display.prototype.center=function(){var c,b,d=this.divjq,e,f;e=d.offset().top;var g=d.height(),h=$(window).height();f=d.offset().left;var d=d.width(),k=$(window).width();for(c=0;c<a.globalOpts.centerDivs.length;c++)b=a.globalOpts.centerDivs[c],this.pluginInstances[b]&&(b=this.pluginInstances[b].divjq,g+=b.height(),e=Math.min(b.offset().top,e));e=g<h?e-(h/2-g/2):e;f=d<k?f-(k/2-d/2):f;$("html, body").animate({scrollTop:e,
scrollLeft:f},250);return this};a.Display.prototype.nextImage=function(c){var b,d;c=c||1;if(this.image){for(b=0;b<a.images.length&&this.image!==a.images[b];b++);for(d=b+c;d!==b&&(d>=a.images.length&&(d=0),0>d&&(d=a.images.length-1),a.images[d].display!==this);d+=c);b!==d&&(c=a.images[d],c.displayImage("all"),c.refreshLayers(),c.clearMessage());return this}};a.Display.prototype.loadSession=function(c){var b=this,d,e=function(a){var c,e,f,g,p=function(){a.refreshLayers()};if(d.layers&&d.layers.length)for(c=
0;c<d.layers.length;c++)if(f=d.layers[c],g=f.name,e=b.newShapeLayer(g,f.dopts),a.addShapes(g,[]),e.canvas.loadFromJSON(f.json,p),f.catalog&&(a.layers[g].catalog=f.catalog),f.starbase)try{a.layers[g].starbase=JSON.parse(f.starbase)}catch(t){}},f=function(c){c.file||a.error("session does not contain a filename");d=c;d.params.onload=e;d.params.display&&delete d.params.display;a.Load(d.file,d.params,{display:b.id})};a.waiting(!0,this.divjq[0]);"object"===typeof c?f(c):$.ajax({url:c,cache:!1,dataType:"json",
mimeType:"application/json",async:!1,success:function(a){f(a)},error:function(b,d,e){a.error("could not load session: "+c,e)}});return this};a.Image.prototype.starbaseToShapes=function(c,b){var d,e,f,g,h,k,l,n,p,t,m,q,r,u,w,y,x;t=a.globalOpts.catalogs.ras;d=a.globalOpts.catalogs.decs;var z=[],v=a.globalOpts.catalogs,A=function(b,c,d){return(b=a.wcs2pix(b.raw.wcs,c,d).trim().split(/ +/))&&b.length?{x:parseFloat(b[0]),y:parseFloat(b[1])}:null};e=function(a,b,c,d){var e,f;if(void 0!==d)f=d;else{f=-1;
for(e=0;e<c.length;e++){for(d=0;d<b.length;d++)if(c[e].toLowerCase()===b[d].toLowerCase()){f=a[b[d]];break}if(0<=f)break}if(0>f)for(y=c[0],x=new RegExp("^"+y,"i"),d=0;d<b.length;d++)if(b[d].match(x)){f=a[b[d]];break}if(0>f)for(y=c[0],x=new RegExp(".*"+y+".*","i"),d=0;d<b.length;d++)if(b[d].match(x)){f=a[b[d]];break}}return f};if(c&&c.data&&c.headline){k=c.data;l=c.headline;n=c.delims;b=b||{};t=e(c,l,t,b.xcol);0>t&&a.error("can't find an RA column (see Preferences:catalogs)");m=e(c,l,d,b.ycol);0>m&&
a.error("can't find a Dec column (see Preferences:catalogs)");g=b.shape||v.shape||"circle";switch(g){case "box":p=function(a,c,d){return{width:b.width||v.width||7,height:b.height||v.height||7}};break;case "circle":p=function(a,c,d){return{radius:b.radius||v.radius||3.5}};break;case "ellipse":p=function(a,c,d){return{r1:b.r1||v.r1||3.5,r2:b.r2||v.r2||3.5}};break;default:p=function(a,c,d){return{width:b.width||7,height:b.height||7}}}u=this.getWCSSys();w=b.wcssys?b.wcssys:v.wcssys?v.wcssys:"ICRS";this.setWCSSys(w);
for(e=d=0;d<k.length;d++)if(q=k[d][t],r=k[d][m],"\x00"!==n[t]&&0<=":h ".indexOf(n[t])&&"galactic"!==w&&"ecliptic"!==w&&(q*=15),f=A(this,q,r)){h=p.call(this,k[d][1],k[d][1]);h={id:d.toString(),shape:g,x:f.x,y:f.y,width:h.width,height:h.height,radius:h.radius,r1:h.r1,r2:h.r2,angle:0,data:{ra:q,dec:r}};if(!1!==b.save&&!1!==a.globalOpts.catalogs.save)for(f=0;f<=l.length;f++)l[f]&&(h.data[l[f]]=k[d][f]);b.color&&(h.color=b.color);z[e++]=h}this.setWCSSys(u);return z}};a.Image.prototype.loadCatalog=function(c,
b,d){var e,f,g=$.extend(!0,{},a.Catalogs.opts);e=a.globalOpts.catalogs;e.tooltip&&(g.tooltip=e.tooltip);d=d||{};d.color=d.color||e.color||"#00FF00";d.wcssys=d.wcssys||e.wcssys;d.dowcsstr=!0;e={convFuncs:{def:function(b){var c={};c.val=a.saostrtod(b);c.delim=String.fromCharCode(a.saodtype());if("\x00"!==c.delim&&0<=" \t-.:hdmsr'\"".indexOf(c.delim)||a.isNumber(b))return c;c.val=b;return c}},units:d.units||e.units,skip:d.skip||e.skip};try{f=new a.Starbase(b,e)}catch(h){a.error("could not parse catalog. Is it in tab-separated column format?")}f&&
f.data&&f.data.length||a.error("no objects found in catalog");e=this.starbaseToShapes(f,d);e.length?(c=c||"catalog_"+a.uniqueID(),this.display.newShapeLayer(c,g),this.removeShapes(c),this.layers[c].catalog=b,this.layers[c].starbase=f,this.addShapes(c,e,d)):a.error("no catalog objects found");return this};a.Image.prototype.saveCatalog=function(c,b){var d,e;d=b||this.activeShapeLayer();this.layers[d]&&this.layers[d].catalog||(d&&"undefined"!==d?a.error("no catalog available: "+d):a.error("no active catalog available"));
e=new Blob([this.layers[d].catalog],{type:"text/plain;charset=utf-8"});c=c||d+".cat";window.hasOwnProperty("saveAs")?saveAs(e,c):a.error("no saveAs function available to save catalog");return c};a.Command=function(c){for(var b in c)c.hasOwnProperty(b)&&(this[b]=c[b]);c.name||a.error("command has no name");c.get||c.set||a.error("command requires get and/or set routine");a.commands.push(this);1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};a.Command.prototype.getDisplayInfo=function(a){a&&a.id&&(this.display=
a,this.image=a.image);return this};a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};a.Helper=function(){this.helper=this.connected=!1;this.type=a.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};a.Helper.prototype.connectinfo=function(){var c;return null===a.helper.connected?"notConfigured":a.helper.connected?(c=sprintf("connected %s %s",a.helper.type,a.helper.url),a.helper.pageid&&
(c+="<p>"+a.helper.pageid),c):sprintf("notConnected %s",a.helper.type)};a.Helper.prototype.connect=function(c){var b=this;c&&(this.type=c);if(this.socket){try{this.socket.disconnect()}catch(d){a.log("warning: can't disconnect from socket")}this.socket=null}a.globalOpts.helperURL?0<=a.globalOpts.helperURL.search(/:\/\//)?this.url=a.globalOpts.helperURL:this.url=a.globalOpts.helperProtocol+a.globalOpts.helperURL:this.url=document.domain?a.globalOpts.helperProtocol+document.domain:a.globalOpts.helperProtocol+
"localhost";switch(this.type){case "none":this.connected=null;$(document).trigger("JS9:ready",{type:"none",status:"OK"});a.Preload(!0);break;case "get":case "post":a.globalOpts.helperCGI||a.error("cgi script name missing for helper");this.url+="/"+a.globalOpts.helperCGI;this.helper=this.connected=!0;a.DEBUG&&a.log("JS9 helper: connect: "+this.type);$(document).trigger("JS9:ready",{type:"get",status:"OK"});a.Preload(!0);break;case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");
this.url+=":"+a.globalOpts.helperPort;this.sockurl=this.url+"/socket.io/socket.io.js";$.ajax({url:this.sockurl,dataType:"script",timeout:a.globalOpts.htimeout,success:function(){var c,e;b.socket=io.connect(b.url,{reconnection:!0,reconnectionDelay:1E4,reconnectionDelayMax:1E4,reconnectionAttempts:6,timeout:a.globalOpts.htimeout});b.socket.on("connect",function(){b.connected=!0;b.helper=!0;e=[];for(c=0;c<a.displays.length;c++)e.push(a.displays[c].id);b.socket.emit("displays",{displays:e},function(a){b.pageid=
a});$(document).trigger("JS9:ready",{type:"socket.io",status:"OK"});a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect: "+b.type)});b.socket.on("connect_error",function(){b.connected=!1;b.helper=!1;a.Preload(!0);1<a.DEBUG&&a.log("JS9 helper: connect error")});b.socket.on("connect_timeout",function(){b.connected=!1;b.helper=!1;a.Preload(!0);1<a.DEBUG&&a.log("JS9 helper: connect timeout")});b.socket.on("disconnect",function(){b.connected=!1;b.helper=!1;1<a.DEBUG&&a.log("JS9 helper: disconnect")});b.socket.on("reconnect",
function(){b.connected=!0;b.helper=!0;1<a.DEBUG&&a.log("JS9 helper: reconnect")});b.socket.on("msg",a.msgHandler)},error:function(c,e,f){b.connected=!1;b.helper=!1;$(document).trigger("JS9:ready",{type:"socket.io",status:"error"});a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect failure: "+e+" "+f)}});break;default:a.error("unknown helper type: "+this.type)}};a.Helper.prototype.send=function(c,b,d){if(!this.connected)return null;b&&"object"===typeof b?(b.cookie=document.cookie,a.globalOpts.dataPath&&
!b.dataPath&&(b.dataPath=a.globalOpts.dataPath+":.")):b={dataPath:"."};a.TOROOT&&(b.dataPath+=":"+a.TOROOT);switch(this.type){case "get":case "post":b.key=c;a.DEBUG&&a.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(b),this.url);$.ajax({url:this.url,type:this.type.toUpperCase(),data:b,dataType:"text",success:function(b){"string"===typeof b&&0<=b.search(a.analOpts.epattern)&&a.log(b);d&&d(b)},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: "+this.type+" failure: "+c+" "+d)}});break;case "sock.io":case "nodejs":a.helper.socket.emit(c,
b,d)}return this};a.Fabric={};a.Fabric.elements="cornerSize cornerColor borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint hasBorders params pub".split(" ");a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00FF00",cornerColor:"#00FF00",cornerSize:fabric.isTouchSupported?12:8,hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0},
fill:"transparent"};a.Fabric.rescaleStrokeWidth=function(c,b){var d=(this.scaleX+this.scaleY)/2;c=c||1;c*=d;!b&&this.params&&(b=this.params.sw1);b&&("group"===this.type?this.forEachObject(function(d){a.Fabric.rescaleStrokeWidth.call(d,c,b)}):this.setStrokeWidth(b/c))};a.Fabric.rescaleEvenly=function(){var a;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=
this.scaleY),this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;a.Fabric.newShapeLayer=function(c,b,d){var e,f;if(this&&c){if(this.layers[c])return this.layers[c];this.layers[c]={};f=this.layers[c];f.params=[];f.params.sel=null;f.params.sellayer=null;d?f.dtype="other":(f.dtype="main",d=this.divjq);e=d.attr("id")+"-"+c.replace(/\s+/,"_")+"-shapeLayer";f.display=this;f.opts=$.extend(!0,{},
b);f.opts.canvas=f.opts.canvas||{};void 0===f.opts.canvas.selection&&(f.opts.canvas.selection=!0);f.el=a.Fabric.elements;f.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(d);f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",e).attr("width",d.css("width")).attr("height",d.css("height")).appendTo(f.divjq);a.bugs.webkit_resize&&"main"===f.dtype&&f.canvasjq.attr("width",this.width).attr("height",this.height);f.canvas=new fabric.Canvas(f.canvasjq[0]);f.canvas.renderOnAddRemove=
!1;f.canvas.preserveObjectStacking=!0;f.opts.movable?(f.opts.hasControls=!0,f.opts.hasRotatingPoint=!0,f.opts.hasBorders=!0,f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.lockRotation=!1,f.opts.lockScalingX=!1,f.opts.lockScalingY=!1,f.opts.lockUniScaling=!1,f.opts.selectable=!0,f.opts.evented=!0,f.opts.usekeyboard=!0):!1===f.opts.movable&&(f.opts.hasControls=!1,f.opts.hasRotatingPoint=!1,f.opts.hasBorders=!1,f.opts.lockMovementX=!0,f.opts.lockMovementY=!0,f.opts.lockRotation=!0,f.opts.lockScalingX=
!0,f.opts.lockScalingY=!0,f.opts.lockUniScaling=!0,f.opts.selectable=!1,f.opts.evented=!1,f.opts.usekeyboard=!1);f.opts.selectable&&(f.opts.canvas.selection=!0);if(f.opts.onmousedown||f.opts.onmouseup||f.opts.onmousemove||f.opts.tooltip||f.opts.onmouseover||f.opts.onmouseout){f.opts.evented=!0;if(f.opts.onmousedown)f.canvas.on("mouse:down",function(b){if(f.display.image&&b.target)"main"===f.dtype&&(f.display.image.clickInRegion=!0),f.opts.onmousedown.call(this,f.display.image,b.target.pub,b.e,b.target);
else if(this._selection=this.selection)this.selection=a.specialKey(b.e)});else f.canvas.on("mouse:down",function(b){if(this._selection=this.selection)this.selection=a.specialKey(b.e)});if(f.opts.onmouseup)f.canvas.on("mouse:up",function(a){f.display.image&&a.target&&f.opts.onmouseup.call(this,f.display.image,a.target.pub,a.e,a.target);this.selection=this._selection||this.selection});else f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.onmousemove)f.canvas.on("mouse:move",
function(a){f.display.image&&a.target&&f.opts.onmousemove.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseover)f.canvas.on("mouse:over",function(a){f.display.image&&a.target&&f.opts.onmouseover.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseout)f.canvas.on("mouse:out",function(a){f.display.image&&a.target&&f.opts.onmouseout.call(this,f.display.image,a.target.pub,a.e,a.target)});f.opts.tooltip&&(f.canvas.on("mouse:over",function(b){f.display.image&&
b.target&&a.tooltip(b.target.left,b.target.top,f.opts.tooltip,f.display.image,b.target.pub,b.e,b.target)}),f.canvas.on("mouse:out",function(b){f.display.image&&b.target&&a.tooltip(b.target.left,b.target.top,null,f.display.image,b.target.pub,b.e,b.target)}))}else f.canvas.on("mouse:down",function(b){if(this._selection=this.selection)this.selection=a.specialKey(b.e)}),f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.ongroupcreate&&(f.opts.canvas.selection=
!0,f.opts.selectable=!0,f.opts.ongroupcreate))f.canvas.on("selection:created",function(a){var b=[],c=[];f.display.image&&a.target&&"group"===a.target.type&&(a.target.forEachObject(function(a){a.pub&&(c.push(a),b.push(a.pub))}),f.opts.ongroupcreate.call(this,f.display.image,b,a.e,c))});f.canvas.on("object:scaling",function(a){a.target.rescaleEvenly();a.target.rescaleBorder()});f.canvas.on("object:selected",function(b){f.params.sel&&b.target.params&&f.params.sel!==b.target&&f.canvas.fire("before:selection:cleared",
{target:f.params.sel});if(b.target){switch(b.target.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(f,b.target),f.canvas.renderAll()}b.target.polyparams?f.params.sel=b.target.polyparams.polygon:b.target.params&&(f.params.sel=b.target)}f.display.image&&(f.display.image.layer=c)});f.canvas.on("before:selection:cleared",function(b){f.params.sel=null;f.display.image&&(f.display.image.layer=null);if(b.target)switch(b.target.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(f,
b.target),f.canvas.renderAll()}});if(f.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",function(){f.canvas.calcOffset()});else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});return f}};a.Fabric.showShapeLayer=function(c,b){var d=this,e=0,f,g,h,k;if(g=this.getShapeLayer(c)){k=g.canvas;h=this.display.layers[c];if("show"===b||!0===b){"show"===b&&(g.show=!0);g.json&&g.show&&k.loadFromJSON(g.json,function(){var b,e,f;d.resize&&(k.getObjects().forEach(function(a){a.left+=
d.resize.left;a.top+=d.resize.top;a.setCoords()}),k.calcOffset());d.layers[c].opts.panzoom?(d.binning.obin=d.binning.bin,d.refreshShapes(c)):k.renderAll();k.selection=g.opts.canvas.selection;g.zindex=Math.abs(g.zindex);h.divjq.css("z-index",g.zindex);for(b in d.layers)d.layers.hasOwnProperty(b)&&c!==b&&d.layers[b].show&&(e=d.display.layers[b],e.divjq.css("z-index")<g.zindex&&(f=e.canvas.getActiveObject()))&&(a.Fabric.removePolygonAnchors(e,f),e.canvas.discardActiveObject())});for(f in this.layers)this.layers.hasOwnProperty(f)&&
this.layers[f].json&&e++;e||(this.resize=null)}else if("hide"===b||!1===b)g.show&&(k.forEachObject(function(b){a.Fabric.removePolygonAnchors(h,b);b.params&&b.params.winid&&(b.params.winid.close(),b.params.winid=null)}),e=k.toJSON(g.dlayer.el),g.json=JSON.stringify(e),k.selection=!1,h&&(g.zindex=-Math.abs(g.zindex),h.divjq.css("z-index",g.zindex)),k.clear()),"hide"===b&&(g.show=!1);"show"===b||!0===b?this.xeqPlugins("shape","onshapelayershow",c):this.xeqPlugins("shape","onshapelayerhide",c);return this}};
a.Fabric.displayShapeLayers=function(){var a;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&this.display.image.showShapeLayer(a,!1);if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0)}};a.Fabric.getShapeLayer=function(a,b){var c,e;if(!a)return null;e=this.layers[a];if(!e){c=this.display.layers[a];if(!c)return null;this.layers[a]={};e=this.layers[a];
e.show=!0;e.nshape=0;e.dlayer=c;e.opts=e.dlayer.opts;e.canvas=e.dlayer.canvas;e.canvas.calcOffset()}return e};a.Fabric.activeShapeLayer=function(a){var b,c,e,f;if(a)if($.isArray(a)){b=0;for(c=this.zlayer-1;b<a.length;b++)f=this.layers[a[b]],"main"===f.dlayer.dtype&&(f.zindex=c--,f.show?e||(e=a[b]):f.zindex=-f.zindex,f.dlayer.divjq.css("z-index",f.zindex));a=e}else{f=this.layers[a];if(f.show){e=f.zindex;f.zindex=this.zlayer-1;f.dlayer.divjq.css("z-index",f.zindex);for(b in this.layers)this.layers.hasOwnProperty(b)&&
(c=this.layers[b],c!==f&&c.zindex===f.zindex&&"main"===c.dlayer.dtype&&(c.zindex=e,c.dlayer.divjq.css("z-index",c.zindex)));this.xeqPlugins("shape","onshapelayeractive",a)}a=this}else{for(b in this.layers)this.layers.hasOwnProperty(b)&&(c=this.layers[b],"main"===c.dlayer.dtype&&(void 0===f||c.zindex>f)&&(f=c.zindex,e=b));a=e}return a};a.Fabric._parseShapeOptions=function(c,b,d){var e,f,g,h,k,l,n,p={},t={};h="main"===this.display.layers[c].dtype?this.rgb.sect.zoom:1;k=h/("main"===this.display.layers[c].dtype?
this.binning.bin||1:1);if(b.remove)return{remove:b.remove};t.tags=[];if(b.tags)if("string"===typeof b.tags)for(f=b.tags.toLowerCase().split(","),c=0;c<f.length;c++)t.tags[c]=f[c].trim();else if($.isArray(b.tags))for(c=0;c<b.tags.length;c++)t.tags[c]=b.tags[c].trim();void 0!==b.angle&&(p.angle=-b.angle);void 0!==b.x&&void 0!==b.y&&(e=this.imageToDisplayPos(b),p.left=e.x,p.top=e.y);void 0!==b.left&&(p.left=b.left);void 0!==b.top&&(p.top=b.top);void 0===p.left&&(p.left=d&&void 0!==d.left?d.left:this.display.canvasjq.attr("width")/
2-1);void 0===p.top&&(p.top=d&&void 0!==d.top?d.top:this.display.canvasjq.attr("height")/2-1+1);b.dx&&(p.left+=b.dx);b.dy&&(p.top-=b.dy);switch(b.shape){case "annulus":t.radii=[];if(void 0!==b.radii)if("string"===typeof b.radii)for(t.radii=b.radii.replace(/ /g,"").split(","),e=c=0;c<t.radii.length;c++)""!==t.radii[c]&&(t.radii[e++]=parseInt(t.radii[c],10));else t.radii=b.radii;else for(b.ireg&&a.SCALEIREG&&(b.iradius&&(b.iradius/=k),b.oradius&&(b.oradius/=k)),h=(b.oradius-b.iradius)/b.nannuli,k=b.nannuli+
1,c=0;c<k;c++)f=b.iradius+h*c,t.radii.push(f);break;case "box":b.ireg&&a.SCALEIREG&&(b.width&&(b.width/=k),b.height&&(b.height/=k));break;case "circle":b.ireg&&a.SCALEIREG&&b.radius&&(b.radius/=k);break;case "ellipse":b.ireg&&a.SCALEIREG&&(b.r1&&(b.r1/=k),b.r2&&(b.r2/=k));break;case "point":switch(b.ptshape){case "box":b.width=2*b.ptsize;b.height=2*b.ptsize;break;case "circle":b.radius=b.ptsize;break;case "ellipse":b.rx=b.ptsize,b.ry=b.ptsize/2}b.lockRotation=!0;b.lockScalingX=!0;b.lockScalingY=!0;
b.lockUniScaling=!0;b.hasControls=!1;b.hasRotatingPoint=!1;b.hasBorders=!0;break;case "line":case "polygon":if(b.pts&&b.pts.length){if("string"===typeof b.pts){g=b.pts.replace(/ /g,"").split(",");f=g.length;if("string"===typeof g[0])for(c=0;c<f;c++)g[c]=parseFloat(g[c]);b.pts=[];for(e=c=0;c<f;c+=2,e++)b.pts[e]={x:g[c],y:g[c+1]}}f=b.pts.length;for(c=0;c<f;c++)b.pts[c]=this.imageToDisplayPos(b.pts[c]);b.left&&b.top?g={x:b.left,y:b.top}:(g=a.centerPolygon(b.pts),p.left=g.x,p.top=g.y);b.points=[];for(c=
0;c<f;c++)e={x:(b.pts[c].x-g.x)/h,y:(b.pts[c].y-g.y)/h},b.points.push(e)}else"polygon"===b.shape&&b.polypoints?b.points=b.polypoints:"line"===b.shape&&b.linepoints&&(b.points=b.linepoints);if(b.ireg&&a.SCALEIREG)for(f=b.points.length,c=0;c<f;c++)b.points[c].x/=k,b.points[c].y/=k}for(l in b)if(b.hasOwnProperty(l))switch(l){case "tags":case "x":case "y":case "dx":case "dy":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":p[l]=
b[l];break;case "shape":n=b[l];break;default:t[l]=b[l]}if(!(b=t.color)){b=t.tags;l=t.tagcolors;var m,q;l=l||{};for(m in l)if(l.hasOwnProperty(m)&&(c=m.split("_"),0===$(b).not(c).length&&0===$(c).not(b).length)){q=l[m];break}if(!q)for(m in l)if(l.hasOwnProperty(m)&&(c=m.split("_"),0===$(b).not(c).length)){q=l[m];break}if(!q)for(m in l)if(l.hasOwnProperty(m)&&(c=m.split("_"),0===$(c).not(b).length)){q=l[m];break}b=q=q||d&&d.get("stroke")||l.defcolor||a.globalOpts.defcolor||"#000000"}p.stroke=b;p.selectColor=
p.stroke;p.cornerColor=p.stroke;p.borderColor=p.stroke;void 0!==t.fixinplace&&(d=t.fixinplace,void 0===p.lockMovementX&&(p.lockMovementX=d),void 0===p.lockMovementY&&(p.lockMovementY=d),void 0===p.lockRotation&&(p.lockRotation=d),void 0===p.lockScalingX&&(p.lockScalingX=d),void 0===p.lockScalingY&&(p.lockScalingY=d),void 0===p.hasControls&&(p.hasControls=!d),void 0===p.hasRotatingPoint&&(p.hasRotatingPoint=!d),void 0===p.hasBorders&&(p.hasBorders=!d));return{shape:n,opts:p,params:t}};a.Fabric.addShapes=
function(c,b,d){var e,f,g,h,k,l,n,p,t,m=[],q={};if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:c,shape:b,opts:d});else if((k=this.getShapeLayer(c))&&k.show){l=k.canvas;"main"===this.display.layers[c].dtype?(n=this.rgb.sect.zoom,p=this.binning.bin||1):p=n=1;if("string"===typeof b)e=this.parseRegions(b),b="string"===typeof e?[{shape:e}]:e;else if(!$.isArray(b))if("object"===typeof b)b=[b];else return;if("string"===typeof d)try{g=JSON.parse(d)}catch(r){return a.error("can't parse shape opts: "+
d,r),null}else g=d;l.size()||(k.zindex=this.zlayer++,d=this.display.layers[c],d.divjq.css("z-index",k.zindex),this.xeqPlugins("shape","onshapelayercreate",c));h=$.extend(!0,{},a.Fabric.opts,k.opts,g);for(g=0;g<b.length;g++){d=$.extend(!0,{},h,b[g]);f=a.Fabric._parseShapeOptions.call(this,c,d);if(f.remove){if(!0===f.remove||"true"===f.remove)f.remove="all";if(!1!==f.remove&&"false"!==f.remove){this.removeShapes(c,f.remove);continue}}if(f.shape){d=f.opts;q=f.params;q.id=++k.nshape;switch(f.shape){case "annulus":q.shape=
"annulus";f=d.top;t=d.left;d.top=0;d.left=0;if(q.radii)for(e=0;e<q.radii.length;e++)d.radius=q.radii[e],m.push(new fabric.Circle(d));d.top=f;d.left=t;d.width=2*d.radius;d.height=2*d.radius;e=new fabric.Group(m,d);break;case "box":q.shape="box";e=new fabric.Rect(d);break;case "circle":q.shape="circle";e=new fabric.Circle(d);break;case "ellipse":q.shape="ellipse";d.rx=q.r1;d.ry=q.r2;e=new fabric.Ellipse(d);break;case "point":q.shape="point";switch(q.ptshape){case "box":e=new fabric.Rect(d);break;case "circle":e=
new fabric.Circle(d);break;case "ellipse":e=new fabric.Ellipse(d);break;default:e=new fabric.Rect(d)}break;case "line":q.shape="line";e=new fabric.Polyline(d.points,d);break;case "polygon":q.shape="polygon";e=new fabric.Polygon(d.points,d,!0);break;case "text":q.shape="text";q.text=d.text||"Double-click to add text here";d.fill=d.stroke;d.strokeWidth=0;e=new fabric.Text(q.text,d);break;default:a.error("unknown shape: "+f.shape)}l.add(e);q.layerName=c;q.sw1=e.strokeWidth;q.listonchange=!1;e.params=
q;if(k.opts.panzoom)switch(q.shape){case "point":case "text":break;default:e.scale(n/p)}e.rescaleBorder();a.Fabric._updateShape.call(this,c,e,null,"add",q)}}(void 0===q.redraw||q.redraw)&&l.renderAll();return q.id}};a.Fabric.selectShapes=function(c,b,d){var e,f,g,h,k;if(!this.layers||!c||!this.layers[c])return null;b=b||"all";e=this.layers[c].canvas;f=e.getActiveGroup();c={group:null};switch(typeof b){case "object":b.params&&(f&&f.contains(b)?c.group=f:c.group=null,d.call(this,b,c));break;case "number":g=
e.getObjects();for(h=g.length;h--;)k=g[h],k.params&&b===k.params.id&&(f&&f.contains(k)?c.group=f:c.group=null,d.call(this,k,c));break;case "string":if("selected"===b)if(e.getActiveObject())b=e.getActiveObject(),b.params&&(c.group=null,d.call(this,b,c));else{if(f)for(c.group=f,g=f.getObjects(),h=g.length;h--;)k=g[h],k.params&&d.call(this,k,c)}else for(g=e.getObjects(),h=g.length;h--;)if(k=g[h],k.params)if(f&&f.contains(k)?c.group=f:c.group=null,"all"===b)d.call(this,k,c);else if(a.colorToHex(b)===
k.stroke.toLowerCase())d.call(this,k,c);else if(b===k.params.shape)d.call(this,k,c);else if(k.params.tags)for(e=0;e<k.params.tags.length;e++)b===k.params.tags[e]&&d.call(this,k,c)}return this};a.Fabric.updateShapes=function(c,b,d,e){var f=this;this.selectShapes(c,b,function(b,h){a.Fabric._updateShape.call(f,c,b,h,d,e)});return this};a.Fabric._updateShape=function(c,b,d,e,f){var g,h,k,l,n,p,t,m={},q=this.layers[c],r=function(a){return a.toFixed(1)};d=d||{};f=f||{};h="main"===this.display.layers[c].dtype?
this.rgb.sect.zoom:1;m.mode=e||"update";m.id=b.params.id;m.shape=b.params.shape;m.layer=c;m.color=b.stroke;m.tags=b.params.tags;e=b.getCenterPoint();d.group&&(n=d.group.getCenterPoint(),e={x:e.x+n.x,y:e.y+n.y});n=this.displayToImagePos(e);m.x=n.x;m.y=n.y;m.imsys="image";m.lcs=this.imageToLogicalPos(n);"image"===this.params.wcssys?(k=m.x,l=m.y):(k=m.lcs.x,l=m.lcs.y,m.imsys=m.lcs.sys);m.angle=-b.angle;d.group&&(m.angle-=d.group.angle);for(;0>m.angle;)m.angle+=360;for(;360<m.angle;)m.angle-=360;t=m.angle;
this.raw.wcsinfo&&this.raw.wcsinfo.crot&&(m.angle-=this.raw.wcsinfo.crot);e=b.scaleX/h*1;h=b.scaleY/h*1;d.group&&(e*=d.group.scaleX,h*=d.group.scaleY);switch(m.shape){case "annulus":m.shape="annulus";m.radii=[];m.imstr="annulus("+r(k)+", "+r(l)+", ";g="annulus "+m.x+" "+m.y+" ";p=b.getObjects();t=p.length;for(d=0;d<t;d++)h=p[d].radius*e,m.imstr+=r(h),g+=m.x+" "+m.y+" "+(m.x+h)+" "+m.y+" ",m.imstr=d===t-1?m.imstr+")":m.imstr+", ",m.radii.push(h);break;case "box":m.shape="box";m.width=b.width*e;m.height=
b.height*h;m.imstr="box("+r(k)+", "+r(l)+", "+r(m.width)+", "+r(m.height)+", "+m.angle.toFixed(4)+")";g="box "+m.x+" "+m.y+" "+m.x+" "+m.y+" "+(m.x+m.width)+" "+m.y+" "+m.x+" "+m.y+" "+m.x+" "+(m.y+m.height)+" "+m.angle*Math.PI/180;break;case "circle":m.radius=b.radius*e;m.imstr="circle("+r(k)+", "+r(l)+", "+r(m.radius)+")";g="circle "+m.x+" "+m.y+" "+m.x+" "+m.y+" "+(m.x+m.radius)+" "+m.y;break;case "ellipse":m.r1=b.width*e/2;m.r2=b.height*h/2;m.imstr="ellipse("+r(k)+", "+r(l)+", "+r(m.r1)+", "+
r(m.r2)+", "+m.angle.toFixed(4)+")";g="ellipse "+m.x+" "+m.y+" "+m.x+" "+m.y+" "+(m.x+m.r1)+" "+m.y+" "+m.x+" "+m.y+" "+m.x+" "+(m.y+m.r2)+" "+m.angle*Math.PI/180;break;case "point":m.width=b.width*e;m.height=b.height*h;m.imstr="point("+r(k)+", "+r(l)+")";g="point "+m.x+" "+m.y;break;case "line":case "polygon":m.imstr=m.shape+"(";g=m.shape+" ";m.pts=[];for(d=0;d<b.points.length;d++)0<d&&(m.imstr+=", ",g+=" "),k={x:m.x+b.points[d].x*e,y:m.y-b.points[d].y*h},k=a.rotatePoint(k,t,{x:m.x,y:m.y}),"image"===
this.params.wcssys?m.imstr+=r(k.x)+", "+r(k.y):(l=this.imageToLogicalPos(k),m.imstr+=r(l.x)+", "+r(l.y)),g+=k.x+" "+k.y,m.pts.push(k),"line"===m.shape&&(0===d?p=0:(l=m.pts[d-1],p+=Math.sqrt((k.x-l.x)*(k.x-l.x)+(k.y-l.y)*(k.y-l.y))));m.imstr="line"===m.shape?m.imstr+(') {"size":'+r(p)+',"units":"pixels"}'):m.imstr+")";break;case "text":m.imstr="text("+r(k)+", "+r(l)+', "'+b.text+'")',m.text=b.text,g="text "+m.x+" "+m.y+' "'+b.text+'"'}if(this.raw.wcs&&0<this.raw.wcs){if("regions"===c&&!1!==f.dowcsstr||
"regions"!==c&&!0===f.dowcsstr)m.wcsstr=a.reg2wcs(this.raw.wcs,g).replace(/;$/,"");g=a.pix2wcs(this.raw.wcs,n.x,n.y).trim().split(/\s+/);m.ra=g[0];m.dec=g[1];m.wcssys=g[2]}m.data=b.params.data;b.set("pub",m);b.params.winid&&($(b.params.winid).is(":visible")?a.Regions.initConfigForm.call(this,b):b.params.winid=null);if(f.nocb)return m;if("regions"===c&&this.params.xeqonchange&&q.show&&this.onregionschange)try{this.params.xeqonchange=!1,a.xeqByName(this.onregionschange,window,this,m)}catch(u){a.log("error in xeqonchange: %s [%s]\n%s",
this.id,u.message,a.strace(u))}finally{this.params.xeqonchange=!0}if(this.params.xeqonchange&&q.show&&q.opts.onchange)try{this.params.xeqonchange=!1,a.xeqByName(q.opts.onchange,window,this,m)}catch(u){a.log("error in onchange: %s [%s]\n%s",this.id,u.message,a.strace(u))}finally{this.params.xeqonchange=!0}this.xeqPlugins("shape","on"+c+"change",m);return m};a.Fabric.removeShapes=function(c,b,d){var e=this,f;if(d=this.getShapeLayer(c))return f=d.canvas,this.selectShapes(c,b,function(b,d){a.Fabric._updateShape.call(e,
c,b,d,"remove");b.params&&b.params.winid&&b.params.winid.close();f.remove(b)}),f.getActiveGroup()&&f.discardActiveGroup(),f.renderAll(),this};a.Fabric.getShapes=function(a,b){var c=[];this.selectShapes(a,b,function(a){c.push(a.pub||{})});return c};a.Fabric.changeShapes=function(c,b,d){var e,f,g,h,k,l,n,p,t,m,q,r,u=[],w=this;if((k=this.getShapeLayer(c))&&d)return l=k.canvas,"main"===this.display.layers[c].dtype?(q=this.rgb.sect.zoom,r=this.binning.bin||1):r=q=1,n=l.getActiveObject(),this.selectShapes(c,
b,function(b,x){d.radii&&(b.params.radii=[]);h=$.extend(!0,{},b.params,d);g=a.Fabric._parseShapeOptions.call(this,c,h,b);if(g.remove){if(!0===g.remove||"true"===g.remove)g.remove="all";if(!1!==g.remove&&"false"!==g.remove){this.removeShapes(c,g.remove||"all");return}}switch(b.params.shape){case "text":g.opts.stroke&&(g.opts.fill=g.opts.stroke),g.opts.strokeWidth=0}b.set(g.opts);b.params=$.extend(!1,{},b.params,g.params);switch(b.params.shape){case "annulus":if(d.radii&&d.radii.length){t=b.get("stroke");
b.forEachObject(function(a){u.push(a)});p=u.length;for(e=0;e<p;e++)b.remove(u[e]),l.remove(u[e]);p=b.params.radii.length;for(e=m=0;e<p;e++)f=new fabric.Circle({radius:b.params.radii[e],stroke:t}),m=Math.max(m,b.params.radii[e]),b.add(f);b.scaleX=q/r;b.scaleY=q/r;b.width=2*m;b.height=2*m;n===b&&l.setActiveObject(b)}break;case "box":d.width&&(b.scaleX=q/r);d.height&&(b.scaleY=q/r);break;case "circle":d.radius&&(b.scaleX=q/r,b.scaleY=q/r);break;case "ellipse":d.r1&&(b.rx=d.r1,b.scaleX=q/r,b.width=2*
b.rx);d.r2&&(b.ry=d.r2,b.scaleY=q/r,b.height=2*b.ry);break;case "line":case "polygon":d.points&&d.points.length&&(b.scaleX=q/r,b.scaleY=q/r),n===b&&(a.Fabric.removePolygonAnchors(k.dlayer,b),a.Fabric.addPolygonAnchors(k.dlayer,b)),a.resetPolygonCenter(b)}b.rescaleBorder();b.setCoords();a.Fabric._updateShape.call(w,c,b,x,"update")}),(void 0===d.redraw||d.redraw)&&l.renderAll(),this};a.Fabric.refreshShapes=function(c){var b,d,e,f,g,h,k,l,n,p=!1,t=this;if(n=this.getShapeLayer(c))return"main"===this.display.layers[c].dtype&&
(p=!0),p?(e=this.binning.bin,f=this.rgb.sect.zoom,g=this.binning.obin/this.rgb.sect.ozoom*f/e,h=this.binning.obin/this.rgb.sect.ozoom*f/e):(e=1,h=g=f=this.rgb.sect.zoom),e=n.canvas,e.getActiveGroup()&&e.discardActiveGroup(),d=e.getActiveObject(),this.selectShapes(c,"all",function(c){b=t.logicalToDisplayPos(c.pub.lcs);c.setLeft(b.x);c.setTop(b.y);switch(c.params.shape){case "point":case "text":break;default:k=g,l=h,p&&(k*=c.scaleX,l*=c.scaleY),c.scaleX=k,c.scaleY=l,c.rescaleBorder()}c.setCoords();
switch(c.type){case "polyline":case "polygon":d===c&&(a.Fabric.removePolygonAnchors(n.dlayer,c),a.Fabric.addPolygonAnchors(n.dlayer,c))}}),p&&(this.binning.obin=this.binning.bin,this.rgb.sect.ozoom=this.rgb.sect.zoom),e&&e.renderAll(),this};a.Fabric.addPolygonPoint=function(c,b,d){var e,f,g,h,k,l,n,p,t,m,q,r,u,w,y,x=Number.MAX_VALUE;if(b&&b.points){d=a.eventToDisplayPos(d);n=b.getCenterPoint().x;l=b.getCenterPoint().y;n=(d.x-n)/b.get("scaleX");r=(d.y-l)/b.get("scaleY");for(l=-b.get("angle")*Math.PI/
180;l>2*Math.PI;)l-=2*Math.PI;d=Math.cos(l)*n-Math.sin(l)*r;r=Math.sin(l)*n+Math.cos(l)*r;n=b.points;for(l=0;l<n.length;l++)k=n[l],f=n[(l+1)%n.length],p=k.x<f.x?k.x:f.x,t=k.y<f.y?k.y:f.y,m=k.x>f.x?k.x:f.x,q=k.y>f.y?k.y:f.y,e=k.x-f.x,k=k.y-f.y,g=Math.sqrt(e*e+k*k),0!==g&&(e/=g,k/=g),g=d-f.x,h=r-f.y,g=g*e+h*k,e=f.x+e*g,f=f.y+k*g,e<p?e=p:e>m&&(e=m),f<t?f=t:f>q&&(f=q),p=(e-d)*(e-d)+(f-r)*(f-r),p<x&&(x=p,u=e,w=f,y=l===n.length?0:l);c=this.getShapeLayer(c);a.Fabric.removePolygonAnchors(c.dlayer,b);n.splice(y+
1,0,{x:u,y:w});c.canvas.setActiveObject(b)}};a.Fabric.removePolygonPoint=function(c,b){var d,e,f,g;b&&b.polyparams&&(e=b.polyparams.polygon,f=e.points,g=b.polyparams.point,d=this.getShapeLayer(c),a.Fabric.removePolygonAnchors(d.dlayer,e),f.splice(g,1),a.resetPolygonCenter(e),d.canvas.setActiveObject(e))};a.Fabric.addPolygonAnchors=function(c,b){var d,e,f={},g=c.canvas,h=function(){var b=this.polyparams.polygon,d=this.polyparams.point,e=b.get("points"),h=c.display.image;b.angle?f=a.rotatePoint({x:this.left,
y:this.top},-b.angle,{x:b.left,y:b.top}):(f.x=this.left,f.y=this.top);e[d].x=(f.x-b.left)/b.scaleX;e[d].y=(f.y-b.top)/b.scaleY;a.resetPolygonCenter(b);a.Fabric._updateShape.call(h,b.params.layerName,b,null,"update");h&&(h.params.listonchange||b.params.listonchange)&&h.listRegions(b,2);g.renderAll()},k=function(b){var c,d={};for(c=0;c<b.params.anchors.length;c++)d.x=b.left+b.points[c].x*b.scaleX,d.y=b.top+b.points[c].y*b.scaleY,b.angle&&(d=a.rotatePoint(d,b.angle,{x:b.left,y:b.top})),b.params.anchors[c].set({left:d.x,
top:d.y,angle:b.angle}),b.params.anchors[c].setCoords();b._calcDimensions(!0);g.renderAll()};if(!b.params.anchors){b.params.anchors=[];for(d=0;d<b.points.length;d++)f.x=b.left+b.points[d].x*b.scaleX,f.y=b.top+b.points[d].y*b.scaleY,b.angle&&(f=a.rotatePoint(f,b.angle,b.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:b.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize,height:a.Fabric.opts.cornerSize,padding:2}),
e.on("moving",h),e.polyparams={},e.polyparams.polygon=b,e.polyparams.point=d,b.params.anchors[d]=e,g.add(e);b.on("moving",function(){k(b)});b.on("rotating",function(){k(b)});b.on("scaling",function(){k(b)});b.setCoords()}};a.Fabric.removePolygonAnchors=function(a,b){var c,e=a.canvas;if(b&&b.params&&b.params.anchors){for(c=0;c<b.params.anchors.length;c++)e.remove(b.params.anchors[c]);delete b.params.anchors}};a.resetPolygonCenter=function(c){var b,d,e,f={};c._calcDimensions();d=(c.minX+c.width/2)*
c.scaleX;b=(c.minY+c.height/2)*c.scaleY;c.angle?f=a.rotatePoint({x:c.left+d,y:c.top+b},c.angle,{x:c.left,y:c.top}):(f.x=c.left+d,f.y=c.top+b);if(5<=fabric.version.split(".")[1])for(d/=c.scaleX,e=b/c.scaleY,b=0;b<c.points.length;b++)c.points[b].x-=d,c.points[b].y-=e;c.left=f.x;c.top=f.y;c.setCoords()};a.Fabric.print=function(c){var b,d,e,f,g,h,k=0,l=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));
c=c||{};f=this.display.canvas.toDataURL("image/png");b="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>";g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k);b+=sprintf("%s<img src='%s'></div>",g,f);for(d in this.layers)this.layers.hasOwnProperty(d)&&(f=this.layers[d],"main"===f.dlayer.dtype&&f.show&&(b+=sprintf("%s%s</div>",g,f.dlayer.canvas.toSVG())));(void 0===c.colorbar||c.colorbar)&&(c=this.display.pluginInstances.JS9Colorbar)&&c.isActive()&&
(k+=2,f=c.colorbarjq[0].toDataURL("image/png"),k+=this.display.height,g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k),b+=sprintf("%s<img src='%s'></div>",g,f),c.textjq&&c.textjq[0]&&(f=c.textjq[0].toDataURL("image/png"),k+=c.colorbarjq.height()+1,g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k),b+=sprintf("%s<img style='width:%spx;'src='%s'></div>",g,this.display.width,f)));b+="</body></html>";window.isElectron&&(h="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data; window.setTimeout(function(){window.print()}, 250);},false)\x3c/script><p>waiting for image ...</body></html>");
(e=window.open(h,this.id,l))?e.document?(e.document.open(),e.document.write(b),e.document.close()):e.postMessage?window.setTimeout(function(){e.postMessage(b,"*")},250):a.error("no method available for drawing image into print window"):a.error("could not create print window (check your pop-up blockers)")};a.Fabric.initGraphics=function(){var c;a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;a.Image.prototype.addShapes=a.Fabric.addShapes;a.Image.prototype.selectShapes=a.Fabric.selectShapes;
a.Image.prototype.updateShapes=a.Fabric.updateShapes;a.Image.prototype.updateShape=a.Fabric._updateShape;a.Image.prototype.getShapes=a.Fabric.getShapes;a.Image.prototype.changeShapes=a.Fabric.changeShapes;a.Image.prototype.removeShapes=a.Fabric.removeShapes;a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;a.Image.prototype.getShapeLayer=a.Fabric.getShapeLayer;a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;a.Image.prototype.activeShapeLayer=a.Fabric.activeShapeLayer;a.Image.prototype.displayShapeLayers=
a.Fabric.displayShapeLayers;a.Image.prototype.print=a.Fabric.print;for(c in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(c)&&(fabric.Object.prototype[c]=a.Fabric.opts[c])};a.Fabric.initGraphics();a.MouseTouch={};a.MouseTouch.CLASS="JS9";a.MouseTouch.NAME="MouseTouch";a.MouseTouch.WIDTH=512;a.MouseTouch.HEIGHT=220;a.MouseTouch.BASE=a.MouseTouch.CLASS+a.MouseTouch.NAME;a.MouseTouch.mouseText=[];a.MouseTouch.mouseText[0]="move mouse, no buttons pressed:";a.MouseTouch.mouseText[1]="move mouse, primary button pressed:";
a.MouseTouch.mouseText[2]="move mouse, secondary button pressed:";a.MouseTouch.touchText=[];a.MouseTouch.touchText[0]="touch move, with one finger:";a.MouseTouch.touchText[1]="touch move, with two fingers:";a.MouseTouch.touchText[2]="touch move, with three fingers:";a.MouseTouch.textHTML="<div style='float: left'>%s</div>";a.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>";a.MouseTouch.actionid=function(a,b){return(a+"_"+b).replace(/[^A-Za-z0-9_]/g,"_")};a.MouseTouch.addText=function(c,
b){var d;d=sprintf(a.MouseTouch.textHTML,b);return $("<div>").addClass(a.MouseTouch.BASE+"Text").html(d).appendTo(c)};a.MouseTouch.addAction=function(c,b,d){b=a.MouseTouch.actionid(b,d);d=sprintf(a.MouseTouch.actionHTML,d);return $("<div>").addClass(a.MouseTouch.BASE+"Action").attr("id",b).html(d).appendTo(c)};a.MouseTouch.isPinch=function(c,b){var d=a.globalOpts.pinchWait,e=a.globalOpts.pinchThresh,f,g,h,k;if(!c)return-1;g=c.display;if(!g.mousetouchZoom||2!==c.pos.touches.length)return-1;switch(g.ispinch){case -1:case 1:return g.ispinch}f=
Math.sqrt((c.pos.touches[0].x-c.pos.touches[1].x)*(c.pos.touches[0].x-c.pos.touches[1].x)+(c.pos.touches[0].y-c.pos.touches[1].y)*(c.pos.touches[0].y-c.pos.touches[1].y));g.dist0||(g.dist0=f);g.deltas.push(Math.floor(f-g.dist0));if(g.deltas.length>=d){f=1;for(k=h=0;f<d;f++)g.deltas[f]>g.deltas[f-1]?h++:g.deltas[f]<g.deltas[f-1]&&k++;g.ispinch=h>=e||k>=e?1:-1;g.lastzoom=0;return g.ispinch}return 0};a.MouseTouch.Actions={};a.MouseTouch.Actions["display value/position"]=function(c,b,d){!a.specialKey(d)&&
a.globalOpts.internalValPos&&c&&b&&0<b.x&&0<b.y&&b.x<c.raw.width&&b.y<c.raw.height&&(c.valpos=c.updateValpos(b,!0))};a.MouseTouch.Actions["change contrast/bias"]=function(c,b,d){var e=c.display;a.globalOpts.internalContrastBias&&c&&b&&!(c.pos0&&c.pos&&Math.abs(c.pos0.x-c.pos.x)<a.NOMOVE&&Math.abs(c.pos0.y-c.pos.y)<a.NOMOVE||c.clickInRegion||a.specialKey(d)||c.rgbFile)&&(d=a.eventToDisplayPos(d,c.posOffset),b=Math.floor(d.x+.5),d=Math.floor(d.y+.5),a.globalOpts.containContrastBias&&(0>b||0>d||b>=e.canvas.width||
d>=e.canvas.height)||(c.params.bias=b/e.canvas.width,c.params.contrast=d/e.canvas.height*10,a.bugs.firefox_linux?window.setTimeout(function(){c.displayImage("scaled",{blendMode:!1})},0):c.displayImage("scaled",{blendMode:!1}),a.globalOpts.extendedPlugins&&c.xeqPlugins("image","onchangecontrastbias")))};a.MouseTouch.Actions["change contrast/bias"].stop=function(a,b,d){a.display.blendMode&&a.displayImage("rgb")};a.MouseTouch.Actions["wheel zoom"]=function(c,b){var d;c&&c.display.mousetouchZoom&&(d=
0<b.originalEvent.deltaY?Math.min(a.MAXZOOM,c.getZoom()+a.ADDZOOM):Math.max(a.MINZOOM,c.getZoom()-a.ADDZOOM),d=Math.round(100*(d+1E-5))/100,c.setZoom(d))};a.MouseTouch.Actions["pan the image"]=function(a,b,d){a&&(b=a.rgb.sect.xcen+(a.pos0.x-a.pos.x)/a.rgb.sect.zoom,a.setPan(b,a.rgb.sect.ycen-(a.pos0.y-a.pos.y)/a.rgb.sect.zoom),a.pos0=a.pos)};a.MouseTouch.Actions.pinch=function(c,b,d){c&&(b=c.display,d=b.zoom0*Math.sqrt((c.pos.touches[0].x-c.pos.touches[1].x)*(c.pos.touches[0].x-c.pos.touches[1].x)+
(c.pos.touches[0].y-c.pos.touches[1].y)*(c.pos.touches[0].y-c.pos.touches[1].y))/b.dist0,d=Math.max(a.MINZOOM,Math.min(a.MAXZOOM,Math.round(100*(d+1E-5))/100)),d!==b.lastzoom&&c.setZoom(d),b.lastzoom=d)};a.MouseTouch.Actions.start=function(c,b,d){c&&(b=c.display,b.ispinch=0,b.dist0=0,b.zoom0=c.rgb.sect.zoom,b.deltas=[]);b=a.MouseTouch.getAction(c,d);a.MouseTouch.Actions[b]&&a.MouseTouch.Actions[b].start&&a.MouseTouch.Actions[b].start(c,c.ipos,d)};a.MouseTouch.Actions.stop=function(c,b,d){b=a.MouseTouch.getAction(c,
d);a.MouseTouch.Actions[b]&&a.MouseTouch.Actions[b].stop&&a.MouseTouch.Actions[b].stop(c,c.ipos,d)};a.MouseTouch.getAction=function(c,b){var d,e;if(!c)return d;e=c.display;switch(c.clickState){case 0:d=e.mouseActions[0];break;case 1:d=e.mouseActions[1];break;case 2:d=e.mouseActions[2];break;case -1:d=e.touchActions[0];break;case -2:switch(a.MouseTouch.isPinch(c,b)){case -1:d=e.touchActions[1];break;case 1:d="pinch"}break;case -3:d=e.touchActions[2]}return d};a.MouseTouch.action=function(c,b,d){if((d=
d||a.MouseTouch.getAction(c,b))&&a.MouseTouch.Actions[d])a.MouseTouch.Actions[d](c,c.ipos,b)};a.MouseTouch.mousetouchzoom=function(c,b){var d=a.lookupDisplay(c),e=b.checked;d&&(d.mousetouchZoom=e)};a.MouseTouch.init=function(){var c,b,d=this;this.divjq.html("");this.divjq.addClass("JS9PluginScrolling");this.mousetouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchContainer").appendTo(this.divjq);b=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",
a.MouseTouch.BASE+"Header");this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(b).appendTo(this.mousetouchContainer);this.mousetouchTextContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer);this.mousetouchActionContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",
this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer);if(a.TOUCHSUPPORTED){this.mousetouchTouchTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer);for(c=0;c<a.MouseTouch.touchText.length;c++)a.MouseTouch.addText.call(this,this.mousetouchTouchTextContainer,a.MouseTouch.touchText[c]);for(c=a.MouseTouch.touchText.length;c<this.display.touchActions.length;c++)a.MouseTouch.addText.call(this,
this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchTouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer);for(c=0;c<this.display.touchActions.length;c++)b=this.display.touchActions[c],a.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,"touch",b);this.mousetouchTouchContainer.sortable({start:function(a,b){this.oidx=b.item.index()},stop:function(a,b){var c=b.item.index(),e=d.display.touchActions.splice(this.oidx,
1)[0];d.display.touchActions.splice(c,0,e)}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){this.mousetouchMouseTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer);for(c=0;3>c;c++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,a.MouseTouch.mouseText[c]);for(c=3;c<this.display.mouseActions.length;c++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchMouseContainer=
$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer);for(c=0;c<this.display.mouseActions.length;c++)b=this.display.mouseActions[c],a.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",b);this.mousetouchMouseContainer.sortable({start:function(a,b){this.oidx=b.item.index()},stop:function(a,b){var c=b.item.index(),e=d.display.mouseActions.splice(this.oidx,1)[0];d.display.mouseActions.splice(c,
0,e)}})}b=sprintf("<p><div class='%s'>use mouse wheel or pinch to zoom:&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",a.MouseTouch.BASE+"Footer",this.display.id);this.mousetouchFootContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchFootContainer").html(b).appendTo(this.mousetouchContainer);this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",
!0)};a.Regions={};a.Regions.CLASS="JS9";a.Regions.NAME="Regions";a.Regions.opts={panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",tagcolors:{include_source:"#00FF00",
exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(c,b,d,e){var f;!a.specialKey(d)&&e.params&&(b=(new Date).getTime(),e.params.lasttime&&b-e.params.lasttime<a.DBLCLICK&&(f=!0),e.params.lasttime=b);f?e.params.winid||($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){e.pub&&a.Regions.initConfigForm.call(c,e)}),e.params.winid=a.allinone?c.displayAnalysis("params",
a.allinone.regionsConfigHTML,{title:"Region Configuration"}):c.displayAnalysis("params",a.InstallDir(a.Regions.opts.configURL),{title:"Region Configuration"})):a.specialKey(d)&&("polygon"===e.type||"polyline"===e.type?(a.Fabric.addPolygonPoint.call(c,e.params.layerName,e,d),a.Fabric._updateShape.call(c,e.params.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon&&(d=e.polyparams.polygon,a.Fabric.removePolygonPoint.call(c,d.params.layerName,e),a.Fabric._updateShape.call(c,d.params.layerName,
d,null,"update")))},onmouseup:function(){var a,b=[];this.getActiveObject()&&b.push(this.getActiveObject());this.getActiveGroup()&&(b=this.getActiveGroup().getObjects());for(a=0;a<b.length;a++)b[a].polyparams&&this.setActiveObject(b[a].polyparams.polygon)},onchange:null};a.Regions.init=function(c){var b;a.Image.prototype.parseRegions=a.Regions.parseRegions;a.Image.prototype.saveRegions=a.Regions.saveRegions;a.Image.prototype.listRegions=a.Regions.listRegions;a.Image.prototype.copyRegions=a.Regions.copyRegions;
b=this.display.newShapeLayer(c||"regions",a.Regions.opts);b.canvas.on("mouse:up",function(){var a,c,f=[];if(b.display.image)for(c=b.display.image,this.getActiveObject()&&f.push(this.getActiveObject()),this.getActiveGroup()&&(f=this.getActiveGroup().getObjects()),a=0;a<f.length;a++)if(f[a].params){c.params.listonchange?c.listRegions("all",2):f[a].params.listonchange&&c.listRegions("selected",2);break}});return this};a.Regions.onchange=function(c,b){if(a.Regions.opts.onchange&&"function"===typeof a.Regions.opts.onchange)try{a.Regions.opts.onchange(c,
b)}catch(d){}};a.Regions.initConfigForm=function(a){var b,c,e=a.params.winid,f="#"+$(e).attr("id")+" #regionsConfigForm ";$(f+"."+a.pub.shape).each(function(){$(this).removeClass("nodisplay")});$(f+".val").each(function(){c="";b=$(this).attr("name");switch(b){case "radii":a.pub.radii&&a.pub.radii.forEach(function(a){c&&(c+=", ");c+=a.toFixed(1)});break;case "pts":a.pub.pts?a.pub.pts.forEach(function(a){c&&(c+=", ");c+=sprintf("%s, %s",a.x.toFixed(2),a.y.toFixed(2))}):a.pub.imstr&&(c=a.pub.imstr.replace(/^.*\(/,
"").replace(/\)$/,""));break;default:void 0!==a.pub[b]&&(c=a.pub[b],"number"===typeof c&&0!==c%1&&(c=c.toFixed(2)))}$(this).val(c)});a.pub.wcsstr&&$(f+".wcs").removeClass("nodisplay");void 0===a.params.listonchange&&(a.params.listonchange=!1);a.params.listonchange?$(f+"[name='listonchange']").prop("checked",!0):$(f+"[name='listonchange']").prop("checked",!1);void 0===a.params.fixinplace&&(a.params.fixinplace=!1);a.params.fixinplace?$(f+"[name='fixinplace']").prop("checked",!0):$(f+"[name='fixinplace']").prop("checked",
!1);switch(a.pub.shape){case "box":case "ellipse":case "text":$(f+".angle").removeClass("nodisplay")}$(f).data("im",this);$(f).data("shape",a);$(f).data("winid",e)};a.Regions.processConfigForm=function(c,b,d){var e,f,g,h=d.length,k={},l=function(a,b,c){return"remove"===b||void 0!==a.pub[b]&&String(a.pub[b])!==c||void 0!==a.params[b]&&String(a.params[b])!==c?!0:!1},n=function(a){return"true"===a?!0:"false"===a?!1:""===a||isNaN(a)?a:parseFloat(a)};for(e=0;e<h;e++)switch(f=d[e].name,g=d[e].value,f){case "x":l(c,
f,g)&&(k[f]=n(g),void 0===k.y&&(k.y=c.pub.y));break;case "y":l(c,f,g)&&(k[f]=n(g),void 0===k.x&&(k.x=c.pub.x));break;default:l(c,f,g)&&(k[f]=n(g))}this.changeShapes(c.pub.layer,c,k);a.Regions.initConfigForm.call(this,c,b)};a.Regions.listRegions=function(c,b,d){var e,f,g,h,k,l="",n="none",p=!1,t=[],m;void 0===b&&(b=2);void 0===d&&(d="regions");m=this.getShapes(d,c);e=m.length;if(b)for(c=0;c<e;c++)if(d=m[c],(g=d.tags.join(","))&&"source,include"!==g&&"include,source"!==g){p=!0;break}for(f in a.Regions.opts.tagcolors)a.Regions.opts.tagcolors.hasOwnProperty(f)&&
t.push(a.Regions.opts.tagcolors[f]);for(c=0;c<e;c++)d=m[c],g=d.tags.join(","),f=0<=g.indexOf("exclude")?"-":"",k=d.color&&-1===t.indexOf(d.color)?' {"color": "'+d.color+'"} ':"",p&&(h=" # "+g),d.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==n&&("none"!==n&&(l+="; "),l+=this.params.wcssys,n="wcs"),l+="; "+f+d.wcsstr):d.imstr&&(n!==d.imsys&&("none"!==n&&(l+="; "),l+=d.imsys,n=d.imsys),l+="; "+f+d.imstr),k&&(l+=k),h&&(l+=h);1<b&&this.displayMessage("regions",l);return l};
a.Regions.copyRegions=function(c,b){var d,e,f=[];if("object"===typeof c)f.push(c);else if("all"===c)for(d=0;d<a.images.length;d++)this!==a.images[d]&&f.push(a.images[d]);else(d=a.lookupImage(c))&&f.push(d);if(f.length){b||(e=this.listRegions("selected",1));e||(e=this.listRegions(b,1));for(d=0;d<f.length;d++)f[d].addShapes("regions",e);return this}};a.Regions.parseRegions=function(c){var b=[],d,e,f,g,h,k,l,n,p,t,m,q=/(annulus)|(box)|(circle)|(ellipse)|(line)|(polygon)|(point)|(text)/,r=/(fk4)|(fk5)|(icrs)|(galactic)|(ecliptic)|(image)|(physical)/,
u=/\(\s*([^)]+?)\s*\)/,w=/(\{[^}]*\})/,y=/\s*,\s*/,x=function(a){var b,c={opts:{},args:[],isregion:0};0<=a.indexOf("(")?c.cmd=a.split("(")[0].trim().toLowerCase():0<=a.indexOf("{")?c.cmd=a.split("{")[0].trim().toLowerCase():0<=a.indexOf("#")?c.cmd=a.split("#")[0].trim().toLowerCase():c.cmd=a.trim().toLowerCase();c.cmd&&(c.isregion=0<=c.cmd.search(q));c.comment=a.split("#")[1];c.comment&&(c.comment=c.comment.trim().toLowerCase());if((b=w.exec(a))&&b[1])try{c.opts=JSON.parse(b[1].trim())}catch(D){c.opts=
{}}(b=u.exec(a))&&b[1]&&(c.args=b[1].split(y));c.isregion&&0===c.cmd.indexOf("-")&&(c.cmd=c.cmd.slice(1),c.comment=c.comment?c.comment+",exclude":"exclude");return c},z=function(b){b=a.saostrtod(b);var c=String.fromCharCode(a.saodtype());switch(c){case '"':b/=3600;break;case "'":b/=60;break;case "r":b*=180/Math.PI}return{dval:b,dtype:c}},v=function(b,c){var d,e;e=z(b);d=z(c);if(":"===e.dtype||":"===d.dtype)p=!0;n||p?(":"===e.dtype&&"galactic"!==l&&"ecliptic"!==l&&(e.dval*=15),d=a.wcs2pix(this.raw.wcs,
e.dval,d.dval).split(/ +/),e=parseFloat(d[0]),d=parseFloat(d[1])):"physical"===l?(d=this.logicalToImagePos({x:e.dval,y:d.dval}),e=d.x,d=d.y):(e=e.dval,d=d.dval);return[e,d]},A=function(a,b){var c=z(a),d=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};(n||p)&&c.dtype&&"."!==c.dtype&&(c.dval=Math.abs(c.dval/d["cdelt"+b]));return c.dval},B=function(a){a=z(a);var b=this.raw.wcsinfo||{crot:0};(n||p)&&b.crot&&(a.dval+=b.crot);return a.dval};c=c.trim();if(!c.match(/(\(|\{|#|;|\n)/))return c;k=this.getWCSSys();l="physical";
this.setWCSSys(l);n="image"!==l&&"physical"!==l;f=c.split(/\n|;/);for(c=0;c<f.length;c++)if("#"!==f[c].trim().substr(0,1))if(p=!1,h=x(f[c]),m=h.args.length,h.isregion){g=$.extend(!0,{},h.opts);g.shape=h.cmd;2<=m&&(t=v.call(this,h.args[0],h.args[1]),g.x=t[0],g.y=t[1]);switch(h.cmd){case "annulus":g.radii=[];for(d=2;d<m;d++)g.radii.push(A.call(this,h.args[d],1));break;case "box":3<=m&&(g.width=A.call(this,h.args[2],1));4<=m&&(g.height=A.call(this,h.args[3],2));5<=m&&(g.angle=B.call(this,h.args[4]));
break;case "circle":3<=m&&(g.radius=A.call(this,h.args[2],1));break;case "ellipse":3<=m&&(g.r1=A.call(this,h.args[2],1));4<=m&&(g.r2=A.call(this,h.args[3],2));5<=m&&(g.angle=B.call(this,h.args[4]));break;case "line":case "polygon":g.pts=[];for(e=d=0;d<m;d+=2,e++)t=v.call(this,h.args[d],h.args[d+1]),g.pts[e]={x:t[0],y:t[1]};delete g.x;delete g.y;break;case "text":3<=m&&(g.text=h.args[2].replace(/^['"]/,"").replace(/["']$/,""))}h.comment&&(g.tags=h.comment);b.push(g)}else h.cmd.match(r)?(this.setWCSSys(h.cmd),
l=this.getWCSSys(),n="image"!==l&&"physical"!==l):"remove"!==h.cmd&&"delete"!==h.cmd||b.push({remove:!0});this.setWCSSys(k);return b};a.Regions.saveRegions=function(c,b,d){var e=sprintf("# Region file format: JS9 version 1.0");b=this.listRegions(b,1,d);e=sprintf("%s\n%s\n",e,b.replace(/; */g,"\n"));e=new Blob([e],{type:"text/plain;charset=utf-8"});c||(c=d?d+".reg":"js9.reg");window.hasOwnProperty("saveAs")?saveAs(e,c):a.error("no saveAs function available to save region file");return c};a.Regions.keyDownCB=
function(a,b,d){var c,f,g={evt:d},h=d.which||d.keyCode;if(a){b=a.layer||"regions";f=a.display.layers[b].canvas;switch(h){case 8:case 46:d.preventDefault();c="removeRegion";break;case 37:d.preventDefault();c="editRegion";g.dx=-1;break;case 38:d.preventDefault();c="editRegion";g.dy=1;break;case 39:d.preventDefault();c="editRegion";g.dx=1;break;case 40:d.preventDefault();c="editRegion";g.dy=-1;break;case 68:c="downRegion";break;case 85:c="upRegion"}switch(c){case "removeRegion":a.removeShapes(b,"selected");
a.clearMessage(b);f.fire("mouse:up");break;case "editRegion":a.changeShapes(b,"selected",g);f.fire("mouse:up");break;case "downRegion":a.selectShapes(b,"selected",function(a){f.sendToBack(a)});break;case "upRegion":a.selectShapes(b,"selected",function(a){f.bringToFront(a)})}}};a.Catalogs={};a.Catalogs.CLASS="JS9";a.Catalogs.NAME="Catalogs";a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,
selectable:!1,canvas:{selection:!1},panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"}};Math.log10=Math.log10||function(a){return Math.log(a)/Math.LN10};"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};b.prototype=a;return new b});Math.asinh=Math.asinh||function(a){return-Infinity===a?a:Math.log(a+Math.sqrt(a*a+1))};Math.sinh=Math.sinh||function(a){return(Math.exp(a)-Math.exp(-a))/2};a.jupyterFocus=
function(a,b){var c;window.hasOwnProperty("Jupyter")&&(c=a instanceof jQuery?a:$(a),c.find(b||"input, textarea").each(function(){Jupyter.keyboard_manager.register_events($(this))}))};a.getImageID=function(c,b,d){var e,f,g=0,h=1,k=a.images.length,l=/.*<([0-9][0-9]*)>$/;c=c.replace(/<[0-9][0-9]*>/,"");for(e=0;e<k;e++)f=a.images[e],f.display.id===b&&f!==d&&c===f.id0&&(0<=f.id.search(l)&&(f=f.id.replace(l,"$1"),h=Math.max(h,parseInt(f,10))),g++);return g?c+"<"+String(h+1)+">":c};a.uniqueID=function(){var a=
1;return function(){return a++}}();a.waiting=function(c,b){var d;switch(c){case !0:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?(b=b||$("body").get(0),a.spinner||(a.spinner={},d={color:a.globalOpts.spinColor,opacity:a.globalOpts.spinOpacity},a.spinner.spinner=new Spinner(d)),a.spinner.spinner.spin(b)):$("body").addClass("waiting");break;case !1:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?a.spinner&&a.spinner.spinner.stop():$("body").removeClass("waiting")}};
a.msgHandler=function(c,b){var d,e,f,g=[],h=c.cmd,k=c.id;b&&(a.globalOpts.alerts=!1);if(a.publics[h]){$.isArray(c.args)||(c.args=[c.args]);g=$.extend(!0,[],c.args);k&&g.push({display:k});"RunAnalysis"===h&&b&&(1===g.length&&g.push(null),g.push(b),b=null);try{f=a.publics[h].apply(null,g)}catch(l){f=sprintf("ERROR: %s",l.message)}b&&(a.globalOpts.alerts=!0,b(f));return f}if(h&&"#"!==h){d=a.lookupCommand(h);e=a.lookupDisplay(k);if(d&&e)switch(d.getDisplayInfo(e),c.args?g=$.extend(!0,[],c.args):c.paramlist&&
(g=c.paramlist.split(/ +/)),d.getWhich(g)){case "get":try{f=d.get(g)||""}catch(l){f="ERROR: "+l.message}break;case "set":try{f=d.set(g)||"OK"}catch(l){f="ERROR: "+l.message}break;default:f=sprintf("ERROR: unknown cmd type for '%s'",h)}else d||(f=sprintf("ERROR: unknown cmd '%s'",h)),e||(f=sprintf("ERROR: unknown display (%s)",k));b&&(a.globalOpts.alerts=!0,b(f));return f}b&&b("");b&&(a.globalOpts.alerts=!0)};a.lightWin=function(c,b,d,e,f){var g;switch(a.LIGHTWIN){case "dhtml":g=dhtmlwindow.open(c,
b,d,e,f),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+c+" "+a.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),$("#"+c+" ."+a.lightOpts.dhtml.dragBar).doubletap(function(){g.close()},null,400),$("#"+c+" ."+a.lightOpts.dhtml.dragBar).on("touchend",this,function(){dhtmlwindow.distancex||dhtmlwindow.distancey?0<a.lightOpts.nclick&&(a.lightOpts.nclick=0):2<=a.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),a.lightOpts.nclick=
-1):0<=a.lightOpts.nclick&&a.lightOpts.nclick++})}return g};a.checkNew=function(c){c||a.error("internal failure in a JS9 constructor")};a.specialKey=function(a){return a.metaKey||a.ctrlKey};a.strace=function(c){var b="";1<a.DEBUG&&(b=c.stack||c.stacktrace||"");return b};a.floatPrecision=function(a,b){var c,e;c=Math.floor(Math.log10(Math.abs(a)));e=Math.floor(Math.log10(Math.abs(b)));return c!==e?c>e?c:e:1};a.floatFormattedString=function(a,b,d){var c="";if(void 0===a)return c;-2>b?(b="%."+Math.min(Math.abs(b),
9)+"e",c=sprintf(b,a)):0>b?c=a.toFixed(Math.abs(b)+3):2>b?(b="%."+Math.abs(b)+"f",c=sprintf(b,a)):5>b?c=a.toFixed(d):(b="%."+Math.min(b,9)+"e",c=sprintf(b,a));return c};a.centerPolygon=function(a){var b,c,e,f,g,h;if(a&&a.length){c=a.length;for(b=0;b<c;b++){if(void 0===e||a[b].x<e)e=a[b].x;if(void 0===f||a[b].x>f)f=a[b].x;if(void 0===g||a[b].y<g)g=a[b].y;if(void 0===h||a[b].y>h)h=a[b].y}return{x:(e+f)/2,y:(g+h)/2}}};a.centroidPolygon=function(a){var b,c,e=0,f=0;if(a&&a.length){c=a.length;for(b=0;b<
c;b++)e+=a[b].x,f+=a[b].y;return{x:e/c,y:f/c}}};a.lookupImage=function(c,b){var d,e,f=a.images.length;if(!c)return null;for(d=0;d<f;d++)if(e=a.images[d],(c===e||c===e.id||c===e.id0||c===e.file||c===e.file0||c===a.TOROOT+e.file||e.fitsFile&&c===e.fitsFile)&&0<$("#"+e.display.id).length&&(!b||b===e.display.id))return e;return null};a.lookupDisplay=function(c){var b,d=new RegExp(sprintf("[-_]?(%s)$",a.PLUGINS));if(c&&"*"!==c&&0>c.toString().search(a.SUPERMENU)){for(b=0;b<a.displays.length;b++)if(c===
a.displays[b]||c===a.displays[b].id)return a.displays[b];if("string"===typeof c)for(c=c.replace(d,""),b=0;b<a.displays.length;b++)if(c===a.displays[b]||c===a.displays[b].id)return a.displays[b];a.error("can't find JS9 display with id: "+c)}return a.displays[0]};a.getImage=function(c){var b;b=a.lookupImage(c);!b&&(c=a.lookupDisplay(c))&&(b=c.image);return b};a.lookupVfile=function(c){var b,d,e,f,g=[];if(!c)return g;for(b=0;b<a.images.length;b++)for(e=a.images[b],d=0;d<e.raws.length;d++)f=e.raws[d],
f.hdu&&f.hdu.fits&&c===f.hdu.fits.vfile&&g.push({im:e,raw:f,idx:d});return g};a.fetchURL=function(c,b,d,e){var f=new XMLHttpRequest,g;b||(b=c,c=/([^\\\/]+)$/.exec(b)[1]);g=$.extend(!0,{},d,a.fits.options);f.open("GET",b,!0);f.responseType=d.responseType?d.responseType:"blob";a.globalOpts.xtimeout&&(f.timeout=a.globalOpts.xtimeout);f.onload=function(){var h;4===this.readyState&&(200===this.status||0===this.status?"blob"===f.responseType?(h=new Blob([this.response]),c.match("://")?h.name=c.split("/").reverse()[0].replace(/\?.*$/,
""):h.name=c,"uc"===h.name&&(h.name="google_"+a.uniqueID()+".fits"),a.Load(h,g,e)):d.display?e(this.response,d,{display:d.display}):e(this.response,d):404===this.status?a.error("could not find "+b):a.error(sprintf("can't load: %s %s (%s)  ",b,f.statusText,f.status)))};f.onerror=function(){a.error(sprintf("cannot load: %s %s .. please check the url/pathname",b,f.statusText))};f.ontimeout=function(){a.error("timeout awaiting response from server: "+b)};try{f.send()}catch(h){a.error("request to load "+
b+" failed",h)}};a.fitsLibrary=function(c){var b;if(!c)return a.fits.name;b=c.toLowerCase();switch(b){case "fitsy":a.fits=Fitsy;a.fits.datahandler(a.NewFitsImage);a.fits.options=a.userOpts.fits||a.fits.options||{};break;case "astroem":case "cfitsio":a.fits=Astroem;a.fits.options=a.fits.options||{};a.fits.options.handler=a.NewFitsImage;a.fits.options.error=a.error;a.userOpts.fits?(a.fits.options.extlist=a.userOpts.fits.extlist,a.fits.options.table={nx:a.userOpts.fits.xdim,ny:a.userOpts.fits.ydim},
a.fits.options.image={xmax:a.userOpts.fits.xmax,ymax:a.userOpts.fits.ymax}):(a.fits.options.extlist=a.globalOpts.extlist,a.fits.options.table={nx:a.globalOpts.table.xdim||a.globalOpts.dims[0],ny:a.globalOpts.table.ydim||a.globalOpts.dims[1]},a.fits.options.image={xmax:a.globalOpts.image.xmax,ymax:a.globalOpts.image.ymax});a.fits.maxFITSMemory&&a.globalOpts.maxMemory&&a.fits.maxFITSMemory(a.globalOpts.maxMemory);break;default:a.error("unknown fits library: "+c)}a.fits.name=b;a.fits.options.error=a.error;
a.fits.options.waiting=a.waiting;return b};a.handleFITSFile=function(c,b,d){a.fits.handleFITSFile?a.fits.handleFITSFile(c,b,d):a.error("no FITS module available to process FITS file")};a.handleImageFile=function(c,b,d){var e=new FileReader;b=$.extend(!0,{},b,a.fits.options);void 0===d&&(d=a.Load);e.onload=function(a){var e=new Image,f,k,l;e.src=a.target.result;e.onload=function(){var a,g,h,m=0;a=document.createElement("canvas");g=a.getContext("2d");var q=e.height,r=e.width;a.width=r;a.height=q;g.drawImage(e,
0,0);f=g.getImageData(0,0,r,q).data;k=new Float32Array(q*r);for(g=0;g<q;g++)for(a=0;a<r;a++)h=.299*f[m]+.587*f[m+1]+.114*f[m+2],k[(q-g)*r+a]=h,m+=4;l={head:{},filename:c.name,filedata:k,naxis:2,axis:[0,r,q],bitpix:-32,data:k};l.dmin=Number.MAX_VALUE;l.dmax=Number.MIN_VALUE;for(m=0;m<q*r;m++)l.dmin=Math.min(l.dmin,l.data[m]),l.dmax=Math.max(l.dmax,l.data[m]);d(l,b)}};e.readAsDataURL(c)};a.lookupColormap=function(c){var b;c||(c=a.imageOpts.colormap);if(c)for(b=0;b<a.colormaps.length;b++)if(a.colormaps[b].name===
c)return a.colormaps[b];a.error("unknown colormap '"+c+"'")};a.lookupCommand=function(c){var b,d;if(c)for(d=c.toLowerCase(),b=0;b<a.commands.length;b++)if(c=a.commands[b],c.name===d||c.alias===d||c.alias2===d)return c;return null};a.error=function(c,b,d){var e,f,g="",h="",k=!0;a.waiting(!1);"string"===typeof b?(f=c.match(b))?f[1]?c=f[1]:f[0]&&(c=f[0]):k=!1:"object"===typeof b&&(e=b);3>arguments.length&&(d=!0);if(k&&(e&&e.message?c+=sprintf(" (%s)",e.message):c&&(e=Error(c)),(f=a.strace(e))&&(h="\n\nStacktrace:\n"+
f),a.globalOpts.alerts&&(c&&"string"===typeof c&&0>c.search(/ERROR/)&&(g="JS9 ERROR: "),alert(g+(c+h))),d))throw e;};a.eventToCharStr=function(a){var b,c,e={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},f={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},g={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",
47:"?"};b="number"===typeof a?a:a.which||a.keyCode;c=String(b);f.hasOwnProperty(c)&&(b=f[c]);return b=!a.shiftKey&&65<=b&&90>=b?String.fromCharCode(b+32):!a.shiftKey&&e.hasOwnProperty(b)?e[b]:a.shiftKey&&g.hasOwnProperty(b)?g[b]:String.fromCharCode(b)};a.eventToDisplayPos=function(a,b){var c,e,f,g,h;a||(a=window.event);a.target?e=a.target:a.srcElement&&(e=a.srcElement);3===e.nodeType&&(e=e.parentNode);b=b||$(e).offset();a.originalEvent?a.originalEvent.touches&&a.originalEvent.touches.length?(h=a.originalEvent.touches,
c=h[0].pageX,f=h[0].pageY):a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?(h=a.originalEvent.changedTouches,c=h[0].pageX,f=h[0].pageY):(c=a.pageX,f=a.pageY):(c=a.pageX,f=a.pageY);e=b.left+1;g=b.top+1;f={x:Math.floor(c-e),y:Math.floor(f-g)};if(h&&h.length)for(f.touches=[{x:f.x,y:f.y}],c=1;c<h.length;c++)f.touches[c]={x:Math.floor(h[c].pageX-e),y:Math.floor(h[c].pageY-g)};return f};a.rotatePoint=function(a,b,d){var c;d=d||{x:0,y:0};b=Math.PI*b/180;c=Math.cos(b);b=Math.sin(b);
return{x:c*(a.x-d.x)-b*(a.y-d.y)+d.x,y:b*(a.x-d.x)+c*(a.y-d.y)+d.y}};a.log=function(){var a;if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(b){a=Function.prototype.bind.call(console.log,console),a.apply(console,arguments)}};a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};a.notNull=function(a){return void 0!==a&&null!==a};a.cardpars=function(c){var b;if("="===c[8])return b=c.slice(0,8).trim(),c=c.slice(10).replace(/\'/g," ").replace(/\/.*/,
"").trim(),"T"===c?c=!0:"F"===c?c=!1:a.isNumber(c)&&(c=parseFloat(c)),[b,c]};a.raw2FITS=function(a,b){var c,e,f,g=!1,h="";if(!a)return h;if(a.card)for(c=0;c<a.card.length;c++)e=a.card[c],h+=e,"END "===e.substring(0,4)&&(g=!0),b&&(h+="\n");else if(a.cardstr)for(c=0;c<a.ncard;c++)e=a.cardstr.slice(80*c,80*(c+1)),e.match(/^BITPIX/)&&a.bitpix?(f=e.replace(/BITPIX *= *(-?[0-9][0-9]*) */,"$1"),f=parseInt(f,10),h=f!==a.bitpix?h+sprintf("BITPIX  = %20s / %-47s",a.bitpix,"bits/pixel"):h+e):h+=e,"END "===e.substring(0,
4)&&(g=!0),b&&(h+="\n");else if(a.header)for(e in c=a.header,c)c.hasOwnProperty(e)&&"js9Protocol"!==e&&"js9Endian"!==e&&("END"===e&&(g=!0),f=c[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),b&&(h+="\n"));else if(a.BITPIX)for(e in c=a,c)c.hasOwnProperty(e)&&"js9Protocol"!==e&&"js9Endian"!==e&&("END"===e&&(g=!0),f=c[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),b&&(h+="\n"));g||(h+=sprintf("%-8s%-72s","END"," "),b&&(h+="\n"));return h};a.hdus2Str=function(a){var b,c,e,f="";if(!a)return f;
for(b=0;b<a.length;b++){e=a[b];c=e.name?e.name:0===b?"Primary":"N/A";f+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",e.hdu,c,e.type);switch(e.type){case "image":f+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",e.bitpix,e.naxis);if(e.naxes.length){f+="&#09;<b>axes</b>: [";for(c=0;c<e.naxes.length;c++)f+=sprintf("%d",e.naxes[c]),c!==e.naxes.length-1&&(f+=", ");f+="]"}break;case "table":case "ascii":c="&#09;";9>=e.rows&&(c+="&#09;");f+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",
e.rows,c);for(c=0;c<e.cols.length;c++)f+=sprintf("%s",e.cols[c].name),c!==e.cols.length-1&&(f+=", ");f+="]"}f+="\n\n"}return f};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};a.tooltip=function(c,b,d,e,f,g){var h,k=function(b){return b.replace(/\$([a-zA-Z0-9_./]+)/g,function(b,c,d){c=c.split(".");switch(c[0]){case "im":d=e;break;
case "xreg":d=f;break;case "evt":d=g;break;default:return b}for(b=1;b<c.length;b++)d=d[c[b]],d=a.isNumber(d)?d.toFixed(6):d;void 0===d&&(d="");return d})};if(d){d=k(d);e.display.context.save();e.display.context.font=e.display.tooltip.css("font");try{h=e.display.context.measureText(d)}catch(l){h={width:150}}e.display.context.restore();c=Math.min(c,e.display.width-(h.width+10));b=Math.min(b,e.display.height-25);e.display.tooltip.html(d).css({left:c,top:b,display:"inline-block"})}else e.display.tooltip.html("").css({left:-9999,
display:"none"})};a.xeqByName=function(c,b){var d,e,f,g;e=Array.prototype.slice.call(arguments,2);d=typeof c;switch(d){case "function":return c.apply(b,e);case "string":f=c.split(".");g=f.pop();for(d=0;d<f.length;d++)b=b[f[d]];return b[g].apply(b,e);default:a.error("unknown function type: "+d)}};a.varByName=function(c,b){var d,e,f;b=b||a;e=c.split(".");f=e.pop();for(d=0;d<e.length;d++)if(b=b[e[d]],!b)return null;return b[f]};a.mergePrefs=function(c){var b,d,e;for(e in c)if(c.hasOwnProperty(e)&&a.hasOwnProperty(e)&&
(d=typeof a[e],b=typeof c[e],d===b||"string"===b))switch(d){case "object":$.isArray(c[e])?a[e]=c[e]:$.extend(!0,a[e],c[e]);break;case "number":case "string":a[e]=c[e]}};a.loadPrefs=function(c,b){$.ajax({url:c,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(b){a.mergePrefs(b)},error:function(d,e,f){b&&(a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&""===document.domain&&f&&f.message&&f.message.match(/Failed to execute 'send' on 'XMLHttpRequest'/)?(alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file (and data files)."),
a.CHROMEFILEWARNING=!1):a.log("JS9 prefs file not available: %s",c))}})};a.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};a.Starbase=function(a,b){var c,e,f,g,h,k=0;h=function(a){var b;for(b=0;b<a.length;b++)if(null===a[b].match(/^-+$/))return 0;
return b};e=function(a){return a};this.head={};this.convFuncs=[];this.data=[];this.delims=[];if(a){b=b||{};g=a.replace(/\s+$/,"").split("\n");if(b.skip&&(f=b.skip.split(""))&&f.length)for(;k<g.length&&(f[0]===g[k][0]||"\n"===f[1]&&""===g[k]);k++);if(void 0!==g[k]&&void 0!==g[k+1]){this.headline=g[k++].trim().split(/ *\t */);b.units&&(this.unitline=g[k++].trim().split(/ *\t */));this.dashline=g[k++].trim().split(/ *\t */);for(c=h(this.dashline);0===c||c!==this.headline.length;)b.units?(this.headline=
this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=g[k++].trim().split(/ *\t */),c=h(this.dashline);for(c=0;c<this.headline.length;c++)this.headline[c]=this.headline[c].replace(/\./g,"_"),this.convFuncs[c]=b.convFuncs&&b.convFuncs[this.headline[c]]?b.convFuncs[this.headline[c]]:b.convFuncs&&b.convFuncs.def?b.convFuncs.def:e;for(e=0;k<g.length&&(!f||!f.length||f[0]!==g[k][0]&&("\n"!==f[1]||""!==g[k]));k++,e++)for(this.data[e]=g[k].split("\t"),c=0;c<this.data[e].length;c++)h=
this.convFuncs[c](this.data[e][c]),this.data[e][c]=h.val,this.delims[c]=h.delim||null;for(c=0;c<this.headline.length;c++)this[this.headline[c]]=c}}};a.colorToHex=function(a){var b={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",
cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",
floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",
lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",
mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",
sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},c;if(a)return c=a.toLowerCase(),"undefined"!==typeof b[c]?b[c]:a};a.mouseDownCB=function(c){var b=c.data,
d=b.image;if(d){c.target&&(d.posOffset=$(c.target).offset());d.pos0=a.eventToDisplayPos(c,d.posOffset);d.pos=d.pos0;d.ipos0=d.displayToImagePos(d.pos);d.ipos=d.ipos0;b.resizing=b.inResize(d.pos);if(!b.resizing){c.preventDefault();a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(d,c,"start");if(d.clickInRegion){d.clearMessage("regions");return}a.specialKey(c)||d.xeqPlugins("mouse","onmousedown",c)}d.clickState=c.which;switch(c.which){case 3:d.clickState=2}c.originalEvent&&c.originalEvent.touches&&
c.originalEvent.touches.length&&(d.clickState=-c.originalEvent.touches.length);$(document).on("mousemove."+b.id,b,function(b){return a.mouseMoveCB(b)});$(document).on("mouseup."+b.id,b,function(b){return a.mouseUpCB(b)})}};a.mouseUpCB=function(c){var b,d,e=c.data;if(b=e.image)for(b.pos=a.eventToDisplayPos(c,b.posOffset),b.ipos=b.displayToImagePos(b.pos),e.inResize(b.pos)||c.preventDefault(),a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(b,c,"stop"),b.clickInRegion&&(Math.abs(b.pos0.x-b.pos.x)<
a.NOMOVE&&Math.abs(b.pos0.y-b.pos.y)<a.NOMOVE?b.updateShapes("regions","selected","select"):b.updateShapes("regions","selected","update")),a.specialKey(c)||b.xeqPlugins("mouse","onmouseup",c),b.clickInRegion=!1,b.clickState=0,b.posOffset=null,e.resizing&&(e.resizing=!1,a.bugs.webkit_resize&&(c=parseInt(e.divjq.css("width"),10),d=parseInt(e.divjq.css("height"),10),c<e.owidth&&e.divjq.css("width",e.owidth+a.RESIZEFUDGE),d<e.oheight&&e.divjq.css("height",e.oheight+a.RESIZEFUDGE)),a.globalOpts.resizeRedisplay||
(b.displayImage("all"),b.refreshLayers())),$(document).off("mouseup."+e.id),$(document).off("mousemove."+e.id),b=0;b<a.displays.length;b++)c=a.displays[b],c!==e&&c.image&&c.image.clickState&&c.divjq.trigger("mouseup")};a.mouseMoveCB=function(c){var b;b=c.data;var d=b.image;d&&(d.pos=a.eventToDisplayPos(c,d.posOffset),d.ipos=d.displayToImagePos(d.pos),d.pos0||(d.pos0=d.pos),d.ipos0||(d.ipos0=d.ipos),b.resizing||(c.preventDefault(),d.valpos=null,d.clickInRegion&&(b=d.display.layers.regions.params.sel)&&
(d.params.listonchange||b.params.listonchange)&&(d.updateShape("regions",b,null,"update",!0),d.listRegions("selected",2)),a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(d,c),a.specialKey(c)||(d.valpos||(d.valpos=d.updateValpos(d.ipos,!1)),a.specialKey(c)||d.xeqPlugins("mouse","onmousemove",c))))};a.mouseOverCB=function(c){var b=c.data.image,d=$(document).scrollLeft(),e=$(document).scrollTop();c.preventDefault();b&&(b.display.displayConjq.focus(),window.scrollTo(d,e),a.specialKey(c)||(b.pos=a.eventToDisplayPos(c),
b.ipos=b.displayToImagePos(b.pos),a.specialKey(c)||b.xeqPlugins("mouse","onmouseover",c)))};a.mouseOutCB=function(c){var b=c.data.image;c.preventDefault();b&&(b.display.displayConjq.blur(),a.specialKey(c)||(b.pos=a.eventToDisplayPos(c),b.ipos=b.displayToImagePos(b.pos),a.specialKey(c)||b.xeqPlugins("mouse","onmouseout",c)))};a.wheelCB=function(c){var b=c.data,d=b.image;b.mousetouchZoom&&d&&a.hasOwnProperty("MouseTouch")&&a.MouseTouch.Actions["wheel zoom"]&&(a.MouseTouch.Actions["wheel zoom"](d,c),
c.preventDefault())};a.keyPressCB=function(a){var b=a.data.image;a.preventDefault();b&&b.xeqPlugins("keypress","onkeypress",a)};a.keyDownCB=function(c){var b,d=c.data.image;a.hasOwnProperty("Keyboard")&&(b=d?d.ipos:{x:null,y:null},a.Keyboard.action(d,b,c));d&&d.xeqPlugins("keypress","onkeydown",c)};a.dragenterCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragoverCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragexitCB=function(a,b){b.stopPropagation();b.preventDefault()};
a.dragdropCB=function(c,b,d){var e,f,g;b.originalEvent&&(b=b.originalEvent);b.stopPropagation();b.preventDefault();f=$.extend(!0,{},a.fits.options);f.display=f.display||c;f.extlist=f.extlist||a.globalOpts.extlist;g=b.target.files||b.dataTransfer.files;(c=a.lookupDisplay(f.display))&&c.divjq&&a.waiting(!0,c.divjq[0]);window.setTimeout(function(){for(e=0;e<g.length;e++)a.Load(g[e],f,d)},a.SPINOUT)};a.RegisterPlugin=function(c,b,d,e){var f,g;c&&b&&d&&(f=c+b,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),
e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],a.PLUGINS&&(a.PLUGINS+="|"),a.PLUGINS+=f.replace(/JS9/,""),a.plugins.push({xclass:c,xname:b,name:f,opts:e,func:d,instances:[]}),e.help&&(d=e.help.match(/^.*[\\\/]/),d[0]&&(g="plugins/"+d[0].replace(/[\\\/]+$/,"")),d=e.help.replace(/^.*[\\\/]/,""),e=e.menuItem?e.menuItem:f,a.helpOpts[b]={type:g,url:d,heading:c,title:e}))};a.instantiatePlugin=function(c,b,d,e){var f,g,h;if("string"===typeof b){for(f=0;f<a.plugins.length;f++)if(g=
a.plugins[f],g.name===b){b=g;break}"string"===typeof b&&a.error("unknown plugin: "+b)}g=Object.create(b.func.prototype);g.name=b.name;g.isActive=function(a){if("active"!==this.status||a&&!this.plugin.opts.hasOwnProperty(a))return!1;switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};g.errLog=function(b,c){a.log("error in %s: %s [%s]\n%s",b,this.name,c.message,a.strace(c))};if(c)for(h=c instanceof jQuery?c:"object"===typeof c?$(c):$("#"+c),f=0;f<b.instances.length;f++){if(h.is(b.instances[f].odivjq))return b.instances[f]}else h=
$("div");if(c)if(d)g.id=h.attr("id")||b.name,g.winType="light",g.winHandle=d,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top);else{if(g.id=h.attr("id")||b.name,g.winType="div",d=h.attr("id")||"JS9Plugin",h.wrap("<div class='JS9PluginContainer'>"),g.odivjq=h,g.divjq=h,g.divjq.addClass(b.xclass+"Plugin").addClass("JS9Plugin"),g.odivjq.attr("id")||g.odivjq.attr("id",g.id),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),b.opts.toolbarSeparate||h.data("toolbarseparate"))d=
"<div class='"+a.lightOpts[a.LIGHTWIN].dragBar+"'>",$(d).insertBefore(g.divjq)}else g.id=b.name,g.winType="virtual";g.plugin=b;g.el=c;g.status="active";b.instances.push(g);if("virtual"===g.winType)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[b.name]||(g.div=null,g.display=a.displays[f],b.func.apply(g,e),a.displays[f].pluginInstances[b.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];!b.opts.winDims||g.divjq.width()&&g.divjq.height()||(g.divjq.css("width",b.opts.winDims[0]),
g.divjq.css("height",b.opts.winDims[1]));d=g.divjq.data("js9id")||g.id;g.display=a.lookupDisplay(d);if(h=h.data("toolbarhtml")||b.opts.toolbarHTML)h=a.Image.prototype.expandMacro.call(null,h,[{name:"title",value:b.opts.winTitle||""}]),c=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),0===c.length&&(c=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",a.BTNZINDEX).html(h).data("displayid",g.display.id).insertAfter(c);g.display.pluginInstances[b.name]=g;b.func.apply(g,e)}return g};
a.instantiatePlugins=function(){var c,b=function(b){$("div."+b.name).each(function(){a.instantiatePlugin($(this),b,null,b.opts.divArgs)});b.opts.menuItem||!b.opts.winDims||b.opts.winDims[0]||b.opts.winDims[1]||a.instantiatePlugin(null,b,null,b.opts.divArgs)};for(c=0;c<a.plugins.length;c++)b(a.plugins[c])};a.init=function(){var c;window.HTMLCanvasElement||a.error("sorry: your browser does not support JS9 (no HTML5 canvas support). Try a modern version of Firefox, Chrome, or Safari.");JSON||a.error("sorry: your browser does not support JS9 (no JSON support). Try a modern version of Firefox, Chrome, or Safari.");
if(!a.INSTALLDIR){try{a.INSTALLDIR=$('link[href$="js9.css"]').attr("href").replace(/js9\.css$/,"")||""}catch(b){a.INSTALLDIR=""}a.TOROOT=a.INSTALLDIR.replace(/([^\/.])+/g,"..")}window.hasOwnProperty("Kinetic")&&!window.hasOwnProperty("fabric")&&a.error("please load fabric.js instead of Kinetic.js");"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=a.allinone?[a.allinone.min,a.allinone.close,
a.allinone.restore,a.allinone.resize]:[a.InstallDir("images/min.gif"),a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",function(){a.jupyterFocus($(this).parent())}));a.globalOpts.plotLibrary=a.globalOpts.plotLibrary||"flot";"plotly"!==a.globalOpts.plotLibrary||window.hasOwnProperty("Plotly")||(a.globalOpts.plotLibrary="flot");window.hasOwnProperty("JS9Prefs")&&"object"===
typeof JS9Prefs?(a.mergePrefs(JS9Prefs),$.extend(!0,a.Regions.opts,a.regionOpts)):a.PREFSFILE&&(a.loadPrefs(a.InstallDir(a.PREFSFILE),1),a.loadPrefs(a.PREFSFILE,0),$.extend(!0,a.Regions.opts,a.regionOpts));"file:"===a.globalOpts.helperProtocol&&(a.globalOpts.helperProtocol="http:");a.globalOpts.resize||(a.globalOpts.resizeHandle=!1);a.BROWSER[3]&&(a.globalOpts.resizeHandle=!1);a.globalOpts.helperProtocol+="//";if(window.hasOwnProperty("localStorage")){try{c=localStorage.getItem("images")}catch(b){c=
null}if(c){try{a.userOpts.images=JSON.parse(c)}catch(b){}a.userOpts.images&&$.extend(!0,a.imageOpts,a.userOpts.images)}try{c=localStorage.getItem("regions")}catch(b){c=null}if(c){try{a.userOpts.regions=JSON.parse(c)}catch(b){}a.userOpts.regions&&$.extend(!0,a.Regions.opts,a.userOpts.regions)}try{c=localStorage.getItem("fits")}catch(b){c=null}if(c)try{a.userOpts.fits=JSON.parse(c)}catch(b){}try{c=localStorage.getItem("displays")}catch(b){c=null}if(c){try{a.userOpts.displays=JSON.parse(c)}catch(b){}a.userOpts.displays&&
$.extend(!0,a.globalOpts,a.userOpts.displays)}}window.addEventListener("message",function(b){var c,e=b.data;b=b.origin||b.originalEvent.origin;"null"===b&&(b="unknown");if(a.globalOpts.postMessage){if("string"===typeof e)try{c=JSON.parse(e)}catch(f){a.error("can't parse msg: "+e,f)}else"object"===typeof e?c=e:a.error("invalid msg from postMessage");a.msgHandler(c,function(a,b,d,e){e=e||{};parent.postMessage({cmd:c.cmd,res:{name:e.name,rtype:e.rtype,rdata:a,stdout:a,stderr:b,errcode:d}},"*")})}else a.DEBUG&&
(b=sprintf("JS9 ignoring postMessage, origin: %s",b),b="string"===typeof e?b+sprintf(" data: %s",e):"object"===typeof e?b+sprintf(" obj: %s",JSON.stringify(Object.keys(e))):b+sprintf(" typeof: %s",typeof e),a.log(b))},!1);a.DEBUG=a.DEBUG||a.globalOpts.debug||0;a.hasOwnProperty("Keyboard")&&(a.Keyboard.Actions["move selected region"]=function(b,c,e){a.Regions.keyDownCB(b,c,e)},a.Keyboard.Actions["remove selected region"]=function(b,c,e){a.Regions.keyDownCB(b,c,e)});window.hasOwnProperty("ImageFilters")&&
(a.ImageFilters=ImageFilters);window.hasOwnProperty("Astroem")&&(a.vmalloc=Astroem.vmalloc,a.vfree=Astroem.vfree,a.vheap=Astroem.vheap,a.vmemcpy=Astroem.vmemcpy,a.vfile=Astroem.vfile,a.vunlink=Astroem.vunlink,a.vsize=Astroem.vsize,a.arrfile=Astroem.arrfile,a.listhdu=Astroem.listhdu,a.initwcs=Astroem.initwcs,a.wcsinfo=Astroem.wcsinfo,a.wcssys=Astroem.wcssys,a.wcsunits=Astroem.wcsunits,a.pix2wcs=Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.saodtype=
Astroem.saodtype,a.zscale=Astroem.zscale,a.tanhdr=Astroem.tanhdr,a.reproject=Astroem.reproject);window.hasOwnProperty("Fitsy")?(a.fitsLibrary("fitsy"),a.fits=Fitsy):window.hasOwnProperty("Astroem")&&(a.fitsLibrary("cfitsio"),a.fits=Astroem);$("div.JS9").each(function(){a.checkNew(new a.Display($(this)))});a.RegisterPlugin(a.MouseTouch.CLASS,a.MouseTouch.NAME,a.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:a.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,
winDims:[a.MouseTouch.WIDTH,a.MouseTouch.HEIGHT]});a.RegisterPlugin(a.Regions.CLASS,a.Regions.NAME,a.Regions.init,{onregionschange:a.Regions.onchange,divArgs:["regions"],winDims:[0,0]});a.instantiatePlugins();a.plugins.sort(function(a,c){var b=a.opts.menuItem,d=c.opts.menuItem;return b?!d||b<d?-1:b>d?1:0:1});a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("green",[[0,
0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("heat",[[0,0],[.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]]));a.checkNew(new a.Colormap("cool",[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]]));a.checkNew(new a.Colormap("viridis",[[.267004,.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,.019942,.347269],[.272594,.025563,.353093],
[.273809,.031497,.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],[.283072,.130895,.449241],[.282884,.13592,
.453427],[.282623,.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,.512008],[.26658,.228262,.514349],[.265145,
.232956,.516599],[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,.313828,.543914],[.231674,.318106,.544834],
[.229739,.322361,.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],[.19586,.395433,.555276],[.1941,.399323,
.555565],[.192357,.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,.558141],[.163625,.471133,.558148],[.162142,
.474838,.55814],[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,.541173,.554483],[.135066,.544853,.554029],[.133743,
.548535,.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],[.119483,.614817,.537692],[.119699,.61849,.536347],
[.120081,.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,.501686],[.162016,.687316,.499129],[.166383,.690856,
.496502],[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,.751988,.436601],[.281477,.755203,.432552],[.288921,
.758394,.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],[.440137,.811138,.340967],[.449368,.813768,.335384],
[.458674,.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,.854645,.223353],[.636902,.856542,.21662],[.647257,
.8584,.209861],[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],[.83527,.886029,.102646],[.845561,.887322,.099702],
[.85581,.888601,.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]]));a.checkNew(new a.Colormap("magma",[[.001462,4.66E-4,.013866],[.002258,.001295,.018331],[.003279,.002305,.023708],[.004512,
.00349,.029965],[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,.044794,.176129],[.06533,.047318,.184892],[.069764,
.049726,.193735],[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],[.165308,.067911,.361816],[.171713,.067305,.370771],
[.178212,.066576,.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,.475462],[.29774,.066117,.478243],[.304081,.067835,
.480812],[.310382,.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,.110431,.504662],[.420791,.11292,.505215],[.426877,
.115395,.505714],[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],[.537755,.156894,.506551],[.544015,.159033,.506159],
[.550287,.161158,.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,.490253],[.664915,.198075,.488836],[.671349,.200133,
.487358],[.677786,.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],[.786212,.241514,.450184],[.792427,.244242,.447543],
[.798608,.24704,.444848],[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,.393995],[.899552,.314616,.391037],[.904281,.31961,
.388137],[.908884,.324755,.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,
.360311],[.971582,.45421,.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,
.410283],[.993326,.602275,.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,
.740772,.510983],[.997228,.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],
[.99244,.88433,.640099],[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],[.987053,.991438,.749504]]));a.checkNew(new a.Colormap("inferno",[[.001462,4.66E-4,.013866],[.002267,.00127,.01857],[.003299,
.002249,.024239],[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],
[.071429,.040294,.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,
.361447],[.197297,.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,
.055634,.426377],[.328921,.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],
[.447428,.101597,.43108],[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,
.408258],[.572081,.145797,.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,
.192239,.357603],[.694627,.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],
[.801871,.258674,.283099],[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,
.198286],[.894305,.353399,.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,
.468744,.099874],[.956852,.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],
[.985315,.608422,.024202],[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,
.147565],[.981173,.759135,.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,
.903409,.380271],[.948683,.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,.644924]]));a.checkNew(new a.Colormap("plasma",[[.050383,
.029803,.527975],[.063536,.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],
[.221197,.016497,.602083],[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,
.64471],[.35015,.004382,.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,8.59E-4,.656133],[.405503,6.78E-4,.656977],[.41158,5.77E-4,.65773],[.417642,5.64E-4,.65839],[.423689,6.46E-4,.658956],[.429719,8.31E-4,.659425],[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,
.004545,.660139],[.471457,.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],
[.579029,.064296,.635126],[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,
.578688],[.67916,.151848,.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,
.235976,.505794],[.764193,.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],
[.833422,.324635,.434366],[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,
.369768],[.896131,.415712,.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,.497642,.309197],[.942598,.502639,.305816],[.944844,
.507658,.302433],[.947051,.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],[.977856,.602051,.241387],[.979233,.607532,.238013],
[.980556,.613039,.234646],[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,.180097],[.994324,.716681,.177208],[.994474,.722691,
.174381],[.994553,.728728,.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,.835315,.142528],[.982653,.841812,.142303],[.98119,
.848329,.142279],[.979644,.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],[.941896,.96859,.140956],[.940015,.975158,.131326]]));
a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]]));a.checkNew(new a.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]]));a.checkNew(new a.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,0,.47595],[.434417,0,.528833],[.477858,0,.581717],
[.5213,0,.6346],[.506742,0,.640217],[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,
.853583],[0,.05945,.868225],[0,.079267,.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,
.7777],[0,.857933,.753],[0,.883067,.7283],[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,.149725],[0,.828783,.124083],[0,.828392,.098442],
[0,.828,.0728],[.033167,.834167,.066733],[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,.902,0],[.7934,.902,0],[.810617,.897133,.003983],
[.827833,.892267,.007967],[.84505,.8874,.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,.675225,.082],[.95725,.656517,.0858],[.952975,
.637808,.0896],[.9487,.6191,.0934],[.952975,.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,0],[.985075,.0987,0],[.983417,.0658,0],[.981758,
.0329,0],[.9801,0,0],[.955925,0,0],[.93175,0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]]));a.checkNew(new a.Colormap("a",
[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]]));a.checkNew(new a.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]]));a.checkNew(new a.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]]));a.checkNew(new a.Colormap("he",[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],
[.065,.625],[.25,.25],[1,1]]));a.checkNew(new a.Colormap("hsv",function(){var a,c,e,f,g,h,k,l=[],n=0;for(a=0;200>a;a++,n++){c=1-a/199;e=360*c+270;f=Math.abs(Math.sin(3.1416*c));for(c=Math.pow(1-c,1/3);360<=e;)e-=360;e/=60;k=Math.floor(e);g=e-k;e=c*(1-f);h=c*(1-f*g);f=c*(1-f*(1-g));l[n]=[];switch(k){case 0:l[n].push(c);l[n].push(f);l[n].push(e);break;case 1:l[n].push(h);l[n].push(c);l[n].push(e);break;case 2:l[n].push(e);l[n].push(c);l[n].push(f);break;case 3:l[n].push(e);l[n].push(h);l[n].push(c);
break;case 4:l[n].push(f);l[n].push(e);l[n].push(c);break;case 5:l[n].push(c),l[n].push(e),l[n].push(h)}}return l}()));a.checkNew(new a.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]]));a.checkNew(new a.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],[.666,.3],[.666,0],[1,.3]]));a.checkNew(new a.Colormap("staircase",function(){var a,
c,e=[],f=0;for(a=1;5>=a;a++,f++)c=a/5,e[f]=[],e[f].push(.3*c),e[f].push(.3*c),e[f].push(c);for(a=1;5>=a;a++,f++)c=a/5,e[f]=[],e[f].push(.3*c),e[f].push(c),e[f].push(.3*c);for(a=1;5>=a;a++,f++)c=a/5,e[f]=[],e[f].push(c),e[f].push(.3*c),e[f].push(.3*c);return e}()));a.checkNew(new a.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,.56078],[.74902,.74902,.74902],[.93725,.93725,.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,
0],[.3098,.62353,0],[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]]));a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,c,e,f,g,h="",k=this.image;if(k&&k.analysisPackages)for(c=0;c<k.analysisPackages.length;c++){g=k.analysisPackages[c];for(a=0;a<g.length;a++)f=g[a],h&&(h+=", "),e=f.xclass?f.xclass+":"+f.name:f.name,h+=sprintf("%s (%s)",f.title,e);c<k.analysisPackages.length-1&&(h+="\n")}return h},set:function(b){var c,
e=this.image;e&&((c=e.lookupAnalysis(b[0]))?c.purl?(b=e.displayAnalysis("params",a.InstallDir(c.purl),{title:c.title+": "+e.fitsFile}),$(b).data("dispid",e.display.id).data("aname",c.name)):e.runAnalysis(c.name):a.error("unknown analysis command '"+b[0]+"'"))}}));a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,a.bias)},set:function(a){var b=this.image;
b&&b.setColormap.apply(b,a)}}));a.checkNew(new a.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var b,c="";for(b=0;b<a.colormaps.length;b++)c&&(c+=", "),c+=a.colormaps[b].name;return c}}));a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var b,c,e;e="<table>";for(b=0;b<a.commands.length;b++)c=a.commands[b],e+="<tr><td>"+c.name+"</td><td>"+c.help,c.alias&&(e+=" ("+c.alias,c.alias2&&(e+=", "+c.alias2),e+=")"),
e+="</td></tr>";return e+"</table>"}}));a.checkNew(new a.Command({name:"helper",help:"get/set helper connection",get:function(){return a.helper.connectinfo()},set:function(b){a.helper.connect(b[0].trim())}}));a.checkNew(new a.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(b){var c,e;for(c=0;c<a.images.length;c++)if(e=a.images[c],0<=e.file.search(b[0])&&e.display===this.display){e.displayImage("display");
break}}}));a.checkNew(new a.Command({name:"images",help:"get list of currently loaded images",get:function(){var b,c,e="";for(b=0;b<a.images.length;b++)c=a.images[b],c.display===this.display&&(e&&(e+=", "),e+=c.file);return e}}));a.checkNew(new a.Command({name:"load",help:"load image(s)",set:function(b){var c;for(c=0;c<b.length;c++)a.Load(b[c],{display:this.display.id})}}));a.checkNew(new a.Command({name:"pan",help:"set/get pan location for current image",get:function(){var a;if(a=this.image)return a=
a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var b=this.image;b&&b.setPan.apply(b,a)}}));a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(b){var c=this.image;if(c)return b=a.Pix2WCS(parseFloat(b[0]),parseFloat(b[1]),{display:c}),b.str}}));a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;a&&a.print()}}));a.checkNew(new a.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",
get:function(){var a=this.image;if(a)return a.listRegions("all",0)||""},set:function(a){var b=this.image;b&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),b.removeShapes("regions",a)):(a=a.join(" "),b.addShapes("regions",a)))}}));a.checkNew(new a.Command({name:"resize",help:"get/set display size for current image",get:function(){var a;if(a=this.image)return a=a.display,sprintf("%s %s",a.width,a.height)},set:function(a){var b;b=this.image;var c;b&&a.length&&(b=b.display,c=parseInt(a[0],
10),a=1<a.length?parseInt(a[1],10):c,b.resize(c,a))}}));a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,a.scalemax)},set:function(a){var b=this.image;b&&b.setScale.apply(b,a)}}));a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}}));a.checkNew(new a.Command({name:"status",help:"get status for specified (or current) image",
get:function(b){var c,e,f,g="";for(c=0;c<a.images.length;c++)if(e=a.images[c],0<=e.file.search(b[0])){f=e;break}f?c=1:(c=0,f=this.image);if(f){if(c>b.length)return f.status.load;for(;c<b.length;c++)switch(e=b[c].toLowerCase().trim(),e){case "load":g&&(g+="\n"),g+=f.status.load}}return g}}));a.checkNew(new a.Command({name:"url",help:"display a url",set:function(b){a.DisplayHelp(b[0])}}));a.checkNew(new a.Command({name:"wcssys",help:"set/get wcs system for current image",get:function(){var a=this.image;
if(a)return a.getWCSSys()},set:function(a){var b=this.image;b&&b.setWCSSys(a[0])}}));a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},set:function(a){var b=this.image;b&&b.setWCSUnits(a[0])}}));a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}}));a.checkNew(new a.Command({name:"wcsunits",help:"get list of available wcs units",
get:function(){return a.wcsunitss.join(", ")}}));a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(b){var c=this.image;if(c)return b=a.WCS2Pix(parseFloat(b[0]),parseFloat(b[1]),{display:c}),b.str}}));a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var b=this.image;b&&b.setZoom(a[0])}}));a.helper=new a.Helper;$(document).on("keyup keypress",".js9AnalysisForm",
function(a){if(13===(a.which||a.keyCode))return a.preventDefault(),!1});$(document).scrollTop(0);$(document).trigger("JS9:init")};a.parsePublicArgs=function(a){var b=null;a=Array.prototype.slice.call(a);var c=a[a.length-1];c&&"object"===typeof c&&c.hasOwnProperty("display")&&1===Object.keys(c).length&&(b=c.display,a.pop());return{argv:a,display:b}};a.mkPublic=function(c,b){"string"===typeof b?a.Image.prototype[b]?(a[c]=function(){var c;c=a.parsePublicArgs(arguments);var e=a.getImage(c.display);if(e)return c=
e[b].apply(e,c.argv),c===e||c===e.display?"OK":c},a.publics[c]=a[c]):a.error("unknown image function for mkPublic: "+b):"function"===typeof b?(a[c]=b,a.publics[c]=a[c]):a.error("unsupported type for mkPublic: "+typeof b)};a.mkPublic("CloseImage","closeImage");a.mkPublic("DisplayImage","displayImage");a.mkPublic("DisplayExtension","displayExtension");a.mkPublic("DisplaySlice","displaySlice");a.mkPublic("BlendImage","blendImage");a.mkPublic("GetColormap","getColormap");a.mkPublic("SetColormap","setColormap");
a.mkPublic("GetZoom","getZoom");a.mkPublic("SetZoom","setZoom");a.mkPublic("GetPan","getPan");a.mkPublic("SetPan","setPan");a.mkPublic("GetScale","getScale");a.mkPublic("SetScale","setScale");a.mkPublic("GetValPos","updateValpos");a.mkPublic("ImageToDisplayPos","imageToDisplayPos");a.mkPublic("DisplayToImagePos","displayToImagePos");a.mkPublic("ImageToLogicalPos","imageToLogicalPos");a.mkPublic("LogicalToImagePos","logicalToImagePos");a.mkPublic("GetWCSUnits","getWCSUnits");a.mkPublic("SetWCSUnits",
"setWCSUnits");a.mkPublic("GetWCS","getWCS");a.mkPublic("SetWCS","setWCS");a.mkPublic("GetWCSSys","getWCSSys");a.mkPublic("SetWCSSys","setWCSSys");a.mkPublic("ShowShapeLayer","showShapeLayer");a.mkPublic("ActiveShapeLayer","activeShapeLayer");a.mkPublic("AddShapes","addShapes");a.mkPublic("RemoveShapes","removeShapes");a.mkPublic("GetShapes","getShapes");a.mkPublic("ChangeShapes","changeShapes");a.mkPublic("Print","print");a.mkPublic("SavePNG","savePNG");a.mkPublic("SaveJPEG","saveJPEG");a.mkPublic("SaveFITS",
"saveFITS");a.mkPublic("RunAnalysis","runAnalysis");a.mkPublic("RawDataLayer","rawDataLayer");a.mkPublic("GaussBlurData","gaussBlurData");a.mkPublic("ImarithData","imarithData");a.mkPublic("ReprojectData","reprojectData");a.mkPublic("ShiftData","shiftData");a.mkPublic("FilterRGBImage","filterRGBImage");a.mkPublic("MoveToDisplay","moveToDisplay");a.mkPublic("SaveSession","saveSession");a.mkPublic("LookupImage",function(c){var b=a.parsePublicArgs(arguments);return a.lookupImage(b.argv[0],b.display)});
a.mkPublic("AddColormap",function(c,b,d,e){var f,g,h=a.parsePublicArgs(arguments),k=function(b){b.vertices?a.AddColormap(b.name,b.vertices[0],b.vertices[1],b.vertices[2]):b.colors?a.AddColormap(b.name,b.colors):a.error("invalid colormap object for JS9.AddColormap()")};if(h.argv[0]instanceof Blob)f=new FileReader,f.onload=function(b){try{g=JSON.parse(b.target.result)}catch(n){a.error("can't parse json colormap",n)}k(g)},f.readAsText(h.argv[0]);else if("object"===typeof h.argv[0])k(h.argv[0]);else switch(h.argv.length){case 1:try{g=
JSON.parse(c)}catch(l){a.error("can't parse JSON colormap",l)}k(g);break;case 2:a.checkNew(new a.Colormap(c,b));a.globalOpts.topColormaps.push(c);break;case 4:a.checkNew(new a.Colormap(c,b,d,e));a.globalOpts.topColormaps.push(c);break;default:a.error("AddColormap() requires a colormap name and 1 or 3 args")}});a.mkPublic("SetRGBMode",function(c,b){var d,e,f=["red","green","blue"],g=["rid","gid","bid"],h=a.parsePublicArgs(arguments);c=h.argv[0];b=h.argv[1];void 0===c&&(c=!a.globalOpts.rgb.active);
if(b)for(d=0;3>d;d++)e=b[g[d]],"string"===typeof e&&(e=a.LookupImage(e)),e&&e.setColormap(f[d]);a.globalOpts.rgb.active=!!c;a.DisplayImage({display:h.display});return a.globalOpts.rgb.active});a.mkPublic("GetRGBMode",function(){return{active:a.globalOpts.rgb.active,rid:a.globalOpts.rgb.rim?a.globalOpts.rgb.rim.id:null,gid:a.globalOpts.rgb.gim?a.globalOpts.rgb.gim.id:null,bid:a.globalOpts.rgb.bim?a.globalOpts.rgb.bim.id:null}});a.mkPublic("SetValPos",function(c){var b=null,d=a.parsePublicArgs(arguments),
e=a.getImage(d.display);e&&(c=d.argv[0],b=e.params.valpos,e.params.valpos=c);return b});a.mkPublic("Load",function(c,b){var d,e,f,g;e=a.parsePublicArgs(arguments);g="fits";c=e.argv[0];b=e.argv[1];if(c){e=e.display?e.display:0<a.displays.length?a.displays[0].id:a.DEFID;if("string"===typeof b)try{b=JSON.parse(b)}catch(h){b=void 0}b=b||{};b.display=b.display||e;b.onload?f=b.onload:a.imageOpts.onload&&(f=a.imageOpts.onload,b.onload=f);if(c instanceof Blob){if(c.path||c.name)if(b.filename=c.path||c.name,
e=a.lookupImage(b.filename,b.display)){e.displayImage("display",b);e.refreshLayers();e.clearMessage();a.waiting(!1);return}b.filename||(b.filename=a.ANON+a.uniqueID());if(c.type&&-1!==c.type.indexOf("image/"))switch(c.type){case "image/fits":break;default:g="img"}switch(g){case "fits":g=$.extend(!0,{},b,a.fits.options);try{a.handleFITSFile(c,g,a.NewFitsImage)}catch(h){a.error("can't process FITS file",h)}break;case "img":try{a.handleImageFile(c,b,a.NewFITSImage)}catch(h){a.error("can't process IMG file",
h)}}}else if("object"===typeof c)a.checkNew(new a.Image(c,b,f));else if("string"!==typeof c&&a.error("unknown file type for Load: "+typeof c),"U0lNUExFICA9"===c.slice(0,12)&&(c=window.atob(c)),"SIMPLE  ="===c.slice(0,9)){g=[];for(d=0;d<c.length;d++)g[d]=c.charCodeAt(d);d=new Blob([new Uint8Array(g)]);b.filename||(b.filename=a.ANON+a.uniqueID());d.name=b.filename;g=$.extend(!0,{},b,a.fits.options);try{a.handleFITSFile(d,g,a.NewFitsImage)}catch(h){a.error("can't process FITS file",h)}}else(e=a.lookupImage(c,
b.display))?(e.displayImage("all",b),e.clearMessage(),a.waiting(!1)):(c=c.trim(),"png"===c.split(".").pop().toLowerCase()?a.globalOpts.pngisfits?a.checkNew(new a.Image(c,b,f)):a.fetchURL(null,c,b,a.NewFitsImage):b.fits2png||void 0===b.fits2png&&a.globalOpts.fits2png?a.helper.connected?a.helper.send("fits2png",{fits:c},function(c){var d;c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};c.stderr&&a.error(c.stderr,a.analOpts.epattern);c.stdout&&(c=c.stdout.replace(/\n*$/,
"").split("\n").pop(),d=c.split(".").pop().toLowerCase(),"png"===d?a.checkNew(new a.Image(c,b,f)):a.error("fits2png conversion failed: "+c))}):a.error("no JS9 helper available to convert image: "+c):(b.display&&(d=a.lookupDisplay(b.display))&&(d=d.divjq[0]),a.waiting(!0,d),d=c.replace(/\[.*\]/,""),a.fetchURL(c,d,b,a.NewFitsImage)))}else a.error("JS9.Load: no file specified for image load")});a.mkPublic("LoadWindow",function(c,b,d,e,f){var g,h;h=(d||"")+"win";b=b||{};switch(d){case "light":return b.id?
(g=b.id,delete b.id):g=h+a.uniqueID(),d="d"+g,e=e||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",g,g,g),f=f||a.lightOpts[a.LIGHTWIN].imageWin,h=sprintf("JS9 Display"+a.IDFMT,g),e=a.lightWin(d,"inline",e,h,f),e.onclose=function(){var b,c,d=[];for(b=0;b<a.images.length;b++)c=a.images[b],c.display.id===g&&d.push(c);for(b=0;b<d.length;b++)try{d[b].closeImage()}catch(p){}return!0},
a.checkNew(new a.Display(g)),a.helper.send("addDisplay",{display:g}),a.instantiatePlugins(),b.display=g,c&&a.Load(c,b),g;case "new":b.id?(g=b.id,delete b.id):g=h+a.uniqueID();f=f||"width=540, height=605";d=document.getElementsByTagName("head")[0].innerHTML;d.match(/src=["'].*js9\.js/)||d.match(/src=["'].*js9\.min\.js/)||(d+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script"));h=e||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",
g,g,g);e=sprintf("<html><head>%s</head><body",d);c&&(e+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",c,JSON.stringify(b)));e+=sprintf(">%s</body></html>\n",h);if(c=window.open("data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data\x3c/script><p></body></html>",g,f))return c.document?(c.document.open(),c.document.write(e),c.document.close()):c.postMessage?a.error("LoadWindow(..., 'new') disabled on Desktop for security reasons"):
a.error("no method available for drawing image into window"),g;a.error("could not create window (check your pop-up blockers)")}});a.mkPublic("LoadProxy",function(c,b){var d,e,f=a.parsePublicArgs(arguments);c=f.argv[0];b=f.argv[1];a.globalOpts.loadProxy||a.error("proxy load not available for this server");a.globalOpts.workDir||a.error("proxy load requires a temp workDir this server");c||a.error("no url specified for proxy load");c=c.trim();c.match(/dropbox\.com/)?(c=c.replace("www.dropbox.com","dl.dropboxusercontent.com"),
c=c.replace("?dl=0","")+"?raw=1"):c.match(/drive\.google\.com/)&&(c=c.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));f.display&&(e=a.lookupDisplay(f.display))&&(e=e.divjq[0]);a.waiting(!0,e);a.Send("loadproxy",{cmd:"js9Xeq loadproxy "+c},function(c){c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};c.errcode=c.errcode||0;c.stderr?a.error(c.stderr):c.stdout?(b=b||{},void 0===b.fits2png&&(b.fits2png=!1),d=c.stdout.trim().replace(/\/\.\//,"/"),
b.proxyFile=d,"/"!==d.charAt(0)&&(d=a.InstallDir(d)),a.Load(d,b,{display:f.display})):a.error("internal error: no return from load proxy command")})});a.mkPublic("Preload",function(c){var b,d,e="",f=null,g=null,h=arguments.length;b=a.parsePublicArgs(arguments);c=b.argv[0];b.display&&(g={display:b.display},--h);switch(h){case 0:b=(null===a.helper.connected||a.helper.connected)&&0<a.preloads.length?2:3;break;case 1:b="boolean"===typeof c?0<a.preloads.length?2:3:null===a.helper.connected||a.helper.connected?
1:0;break;default:b=null===a.helper.connected||a.helper.connected?1:0}switch(b){case 0:for(b=0;b<h;b++)if(d=b+1,d<h&&"object"===typeof arguments[d])a.preloads.push([arguments[b],arguments[d],g]),b++;else if(d<h&&0===arguments[d].indexOf("{")){try{f=JSON.parse(arguments[d])}catch(k){f=null}a.preloads.push([arguments[b],f,g]);b++}else a.preloads.push([arguments[b],null,g]);break;case 1:a.globalOpts.alerts=!1;for(b=0;b<h;b++)if(d=b+1,d<h&&"object"===typeof arguments[d]){try{g?a.Load(arguments[b],arguments[d],
g):a.Load(arguments[b],arguments[d])}catch(k){e=e+" "+arguments[b]}b++}else if(d<h&&0===arguments[d].indexOf("{")){try{f=JSON.parse(arguments[d])}catch(k){f=null}try{g?a.Load(arguments[b],f,g):a.Load(arguments[b],f)}catch(k){e=e+" "+arguments[b]}b++}else try{g?a.Load(arguments[b],null,g):a.Load(arguments[b],null)}catch(k){e=e+" "+arguments[b]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);break;case 2:a.globalOpts.alerts=!1;for(b=0;b<a.preloads.length;b++)try{a.preloads[b][2]?
a.Load(a.preloads[b][0],a.preloads[b][1],a.preloads[b][2]):a.Load(a.preloads[b][0],a.preloads[b][1])}catch(k){e=e+" "+a.preloads[b][0]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);a.preloads=[]}});a.mkPublic("RefreshImage",function(c,b){var d=a.parsePublicArgs(arguments),e=a.getImage(d.display),f=function(c){a.Image.prototype.refreshImage.call(e,c,b)};c=d.argv[0];b=d.argv[1]||{};if(e)if(c instanceof Blob){!b.rawid&&a.fits.cleanupFITSFile&&e.raw.hdu&&e.raw.hdu.fits&&a.fits.cleanupFITSFile(e.raw.hdu.fits,
!0);try{a.handleFITSFile(c,a.fits.options,f)}catch(g){a.error("can't refresh FITS file",g)}}else a.Image.prototype.refreshImage.apply(e,d.argv);else c instanceof Blob&&a.Load.apply(null,arguments)});a.mkPublic("GetLoadStatus",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display);return d?(c=b.argv[0])&&d.id0!==c?"other":d.status.load:"none"});a.mkPublic("CopyToClipboard",function(c){var b,d,e=document.createElement("textarea");e.style.position="fixed";e.style.top=0;e.style.left=0;
e.style.width="2em";e.style.height="2em";e.style.padding=0;e.style.border="none";e.style.outline="none";e.style.boxShadow="none";e.style.background="transparent";e.value=c;document.body.appendChild(e);e.select();try{(d=document.execCommand("copy"))?b="OK":(b="MANUAL",a.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",c):window.prompt("copy to clipboard: Ctrl+C",c))}catch(f){b="ERROR"}document.body.removeChild(e);return b});a.mkPublic("OpenFileMenu",function(){var c=a.parsePublicArgs(arguments);
(c=a.lookupDisplay(c.display))&&$("#openLocalFile-"+c.id).click()});a.mkPublic("OpenRegionsMenu",function(){var c=a.parsePublicArgs(arguments);(c=a.lookupDisplay(c.display))&&$("#openLocalRegions-"+c.id).click()});a.mkPublic("OpenSessionMenu",function(){var c=a.parsePublicArgs(arguments);(c=a.lookupDisplay(c.display))&&$("#openLocalSession-"+c.id).click()});a.mkPublic("OpenCatalogsMenu",function(){var c=a.parsePublicArgs(arguments);(c=a.lookupDisplay(c.display))&&$("#openLocalCatalogs-"+c.id).click()});
a.mkPublic("OpenColormapMenu",function(){var c=a.parsePublicArgs(arguments);(c=a.lookupDisplay(c.display))&&$("#openLocalColormap-"+c.id).click()});a.mkPublic("SaveColormap",function(c){var b,d=a.parsePublicArgs(arguments);if(window.hasOwnProperty("saveAs")){if(b=a.getImage(d.display))c=d.argv[0]||"js9.cmap",b=$.extend(!0,{},b.cmapObj),delete b.type,b=JSON.stringify(b),b=new Blob([b],{type:"text/plain"}),saveAs(b,c)}else a.error("no saveAs function available to save colormap");return c});a.mkPublic("DisplayPlugin",
function(c){var b,d,e,f;b=a.parsePublicArgs(arguments);var g=a.lookupDisplay(b.display);if(g&&b.argv[0]){c=b.argv[0];f=c.toLowerCase();for(b=0;b<a.plugins.length;b++)if(d=a.plugins[b],e=d.name,e===c||e.toLowerCase().substr(-f.length)===f){g.displayPlugin(d);return}a.error("can't find plugin: "+c)}});a.mkPublic("NewFitsImage",function(c,b){var d;b&&b.onload&&(d=b.onload);a.checkNew(new a.Image(c,b,d))});a.mkPublic("GetImage",function(c){var b;c&&"string"!==typeof c&&(b=a.parsePublicArgs(arguments),
c=b.display);return a.getImage(c)});a.mkPublic("GetImageData",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display);return d?(c=b.argv[0],d.getImageData(c)):null});a.mkPublic("GetDisplayData",function(c){var b,d,e,f=[];b=a.parsePublicArgs(arguments);d=b.display||a.displays[0].id;c=b.argv[0];for(b=0;b<a.images.length;b++)e=a.images[b],e.display.id===d&&f.push(e.getImageData(c));return f});a.mkPublic("GetFITSHeader",function(c){var b="",d=a.parsePublicArgs(arguments),e=a.getImage(d.display);
e&&e.raw&&(c=d.argv[0],b=a.raw2FITS(e.raw,c));return b});a.mkPublic("BlendDisplay",function(c){var b,d,e=[],f=a.parsePublicArgs(arguments).display||a.DEFID;(b=a.lookupDisplay(f))||a.error("no JS9 display found: "+f);if(void 0===c||"mode"===c)return b.blendMode;if("list"===c){for(b=0;b<a.images.length;b++)d=a.images[b],d.display.id===f&&d.blend.active&&e.push(d.id);return e}b.blendMode=!!c;b.image&&b.image.displayImage();return b.blendMode});a.mkPublic("LoadAuxFile",function(c,b){var d=a.parsePublicArgs(arguments),
e=a.getImage(d.display);e?(c=d.argv[0],b=d.argv[1],e.loadAuxFile(c,b)):a.error("could not find image for aux file: "+c)});a.mkPublic("SubmitAnalysis",function(c,b,d){var e,f,g;e=a.lightOpts[a.LIGHTWIN];var h=a.parsePublicArgs(arguments);c=h.argv[0];b=h.argv[1];d=h.argv[2];b?e=a.lookupDisplay(h.display).id:(e=$(c).closest(e.top),b=e.data("aname"),e=e.data("dispid"));b?e&&(f=a.getImage(e)):g="internal error: could not find analysis task name";if(f){e=$(c).closest("form");try{h=e.serializeArray()}catch(k){h=
null}f.runAnalysis(b,h,d)}else g="internal error: could not find image";g&&a.error(g);return!1});a.mkPublic("Send",function(c,b,d){a.helper.connected?a.helper.send(c,b,d):a.error("no JS9 helper available")});a.mkPublic("EventToDisplayPos",function(c){return a.eventToDisplayPos(c)});a.mkPublic("PixToWCS",function(c,b){var d,e,f=1;d=a.parsePublicArgs(arguments);var g=a.getImage(d.display);if(g&&(c=d.argv[0],b=d.argv[1],a.isNumber(c)&&a.isNumber(b)||a.error("invalid input for PixToWCS"),0<g.raw.wcs))return d=
a.pix2wcs(g.raw.wcs,c,b).trim(),e=d.split(/ +/),"sexagesimal"===g.params.wcsunits&&"galactic"!==g.params.wcssys&&"ecliptic"!==g.params.wcssys&&(f=15),{ra:a.saostrtod(e[0])*f,dec:a.saostrtod(e[1]),sys:e[2],str:d}});a.Pix2WCS=a.PixToWCS;a.mkPublic("WCSToPix",function(c,b){var d,e,f;e=a.parsePublicArgs(arguments);if(d=a.getImage(e.display))if(c=e.argv[0],b=e.argv[1],a.isNumber(c)&&a.isNumber(b)||a.error("invalid input for WCSToPix"),0<d.raw.wcs)return d=a.wcs2pix(d.raw.wcs,c,b).trim().split(/ +/),e=
parseFloat(d[0]),f=parseFloat(d[1]),d=sprintf("%f %f",e,f),{x:e,y:f,str:d};return null});a.WCS2Pix=a.WCSToPix;a.mkPublic("DisplayHelp",function(c){var b,d,e=a.lightOpts.dhtml.textWin,f;c&&(d=c.split("/").reverse()[0],b="help_"+a.uniqueID(),(f=a.helpOpts[c])?(c=a.InstallDir(f.type+"/"+f.url),a.lightWin(b,"iframe",c,f.title||d,e)):a.lightWin(b,"iframe",c,d,e))});a.mkPublic("NewShapeLayer",function(c,b){var d=a.parsePublicArgs(arguments),e=a.getImage(d.display);return e?(c=d.argv[0],b=d.argv[1],e.display.newShapeLayer(c,
b)):null});a.mkPublic("AddRegions",function(c,b){var d=a.parsePublicArgs(arguments),e=a.getImage(d.display);return e?(c=d.argv[0],b=d.argv[1],c||a.error("no region specified for AddRegions"),b=d.argv[1],e.addShapes("regions",c,b)):null});a.mkPublic("RemoveRegions",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display);return d?(c=b.argv[0],d.removeShapes("regions",c),d.clearMessage("regions"),"OK"):null});a.mkPublic("CopyRegions",function(c,b){var d=a.parsePublicArgs(arguments),e=
a.getImage(d.display);return e?(c=d.argv[0],b=d.argv[1],e.copyRegions(c,b),"OK"):null});a.mkPublic("GetRegions",function(c){var b=a.parsePublicArgs(arguments),d=a.getImage(b.display);return d?(b.argv.unshift("regions"),d.getShapes.apply(d,b.argv)):null});a.mkPublic("ChangeRegions",function(c,b){var d=a.parsePublicArgs(arguments),e=a.getImage(d.display);e&&((c=d.argv[0])||a.error("no region specified for GetRegions"),b=d.argv[1],e.changeShapes("regions",c,b));return null});a.mkPublic("SaveRegions",
function(c,b,d){var e,f,g,h;h=a.parsePublicArgs(arguments);e=h.argv[0];f=h.argv[1];g=h.argv[2];return(h=a.getImage(h.display))?h.saveRegions(e,f,g):c});a.mkPublic("LoadRegions",function(c,b){var d,e;e=a.parsePublicArgs(arguments);c=e.argv[0];b=e.argv[1]||{};c||a.error("JS9.LoadRegions: no file specified for regions load");d=e.display?e.display:b.display?b.display:0<a.displays.length?a.displays[0].id:a.DEFID;"object"===typeof c?(e=new FileReader,e.onload=function(c){a.AddRegions(c.target.result,b,
{display:d})},e.readAsText(c)):"string"===typeof c?(b.responseType="text",b.display=d,a.fetchURL(null,c,b,a.AddRegions)):a.error("unknown file type for LoadRegions: "+typeof c)});a.mkPublic("InstallDir",function(c){return a.INSTALLDIR+c});a.mkPublic("AddDivs",function(){var c,b=a.parsePublicArgs(arguments);for(c=0;c<b.argv.length;c++)a.checkNew(new a.Display(b.argv[c]));a.instantiatePlugins()});a.mkPublic("ResizeDisplay",function(){var c;c=a.parsePublicArgs(arguments);var b=a.lookupDisplay(c.display);
b||a.error("invalid display for resize");c=a.Display.prototype.resize.apply(b,c.argv);c===b&&(c="OK");return c});a.mkPublic("LoadSession",function(c,b){var d,e;d=a.parsePublicArgs(arguments);c=d.argv[0];b=d.argv[1]||{};c||a.error("JS9.LoadSession: no file specified for load");e=a.lookupDisplay(d.display?d.display:b.display?b.display:0<a.displays.length?a.displays[0].id:a.DEFID);b.display=e.id;"object"===typeof c?(d=new FileReader,d.onload=function(a){a=JSON.parse(a.target.result);e.loadSession(a,
b)},d.readAsText(c)):"string"===typeof c?(b.responseType="text",b.display=e.id,a.fetchURL(null,c,b,function(a,b){var c=JSON.parse(a);e.loadSession(c,b)})):a.error("unknown file type for LoadSession: "+typeof c)});a.mkPublic("SaveCatalog",function(c,b){var d=a.parsePublicArgs(arguments),e=a.getImage(d.display);c=d.argv[0];b=d.argv[1];if(e)return e.saveCatalog(c,b)});a.mkPublic("LoadCatalog",function(c,b,d){var e,f;e=a.parsePublicArgs(arguments);c=e.argv[0];b=e.argv[1];d=e.argv[2];b||a.error("JS9.LoadCatalog: no file specified for catalog load");
if(f=a.getImage(e.display))"object"===typeof b?(e=new FileReader,e.onload=function(a){!c&&b.name&&(c=b.name.replace(/\.[^.]*$/,""));f.loadCatalog(c,a.target.result,d)},e.readAsText(b)):"string"===typeof b?f.loadCatalog(c,b,d):a.error("unknown file type for LoadCatalog: "+typeof b)});return a}();$(document).ready(function(){JS9.init()});
